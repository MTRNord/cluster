name: Validate GitOps Manifests

on:
  pull_request:
    branches: ["*"]
    paths:
      - "apps/**"
      - "clusters/**"
      - "infrastructure_talos/**"
      - "scripts/validate.sh"
  push:
    branches: ["main"]
    paths:
      - "apps/**"
      - "clusters/**"
      - "infrastructure_talos/**"
      - "scripts/validate.sh"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate-manifests:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Flux CLI
        uses: fluxcd/flux2/action@main

      - name: Setup tools
        run: |
          # Install yq
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

          # Install kustomize
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

          # Install kubeconform
          curl -LO https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz
          tar xzf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/

          # Verify installations
          yq --version
          kustomize version
          kubeconform -v

      - name: Run validation script
        run: |
          chmod +x scripts/validate.sh
          ./scripts/validate.sh
        continue-on-error: true

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup tools for manifest extraction
        run: |
          # Install yq
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

          # Install kustomize
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Extract container images
        id: extract-images
        run: |
          set +e
          mkdir -p /tmp/manifests

          # Build all kustomizations and extract images
          find . -type f -name 'kustomization.yaml' | while read -r file; do
            dir=$(dirname "$file")
            echo "Building $dir"
            kustomize build "$dir" --load-restrictor=LoadRestrictionsNone > /tmp/manifests/$(echo "$dir" | tr '/' '_').yaml 2>/dev/null || true
          done

          # Extract unique images
          cat /tmp/manifests/*.yaml | yq eval 'select(.spec.template.spec.containers != null) | .spec.template.spec.containers[].image' - 2>/dev/null | sort -u > /tmp/images.txt || true
          cat /tmp/manifests/*.yaml | yq eval 'select(.spec.template.spec.initContainers != null) | .spec.template.spec.initContainers[].image' - 2>/dev/null | sort -u >> /tmp/images.txt || true

          # Extract images from HelmRelease values
          find . -type f -name '*.yaml' -exec grep -l "kind: HelmRelease" {} \; | while read -r file; do
            yq eval '.spec.values | .. | select(. == "*image*" or . == "*repository*") | select(type == "!!str")' "$file" 2>/dev/null || true
          done >> /tmp/images.txt || true

          sort -u /tmp/images.txt > /tmp/images_final.txt

          echo "Found images:"
          cat /tmp/images_final.txt

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "config"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

  kubescape:
    name: Kubescape Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup tools
        run: |
          # Install kustomize
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Build manifests
        run: |
          mkdir -p manifests
          find . -type f -name 'kustomization.yaml' | while read -r file; do
            dir=$(dirname "$file")
            echo "Building $dir"
            kustomize build "$dir" --load-restrictor=LoadRestrictionsNone > manifests/$(echo "$dir" | tr '/' '_').yaml 2>/dev/null || true
          done
          ls -la manifests/

      - name: Run Kubescape
        uses: kubescape/github-action@main
        continue-on-error: true
        with:
          files: "manifests/"
          frameworks: |
            nsa,mitre
          complianceThreshold: 50
          severityThreshold: high
          format: sarif
          outputFile: results.sarif

      - name: Upload Kubescape results to GitHub Security
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4
        if: always()
        with:
          sarif_file: "results.sarif"

  lint:
    name: Lint YAML Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: YAML Lint
        uses: ibiqlik/action-yamllint@2576378a8e339169678f9939646ee3ee325e845c # v3
        continue-on-error: true
        with:
          config_file: .yamllint
