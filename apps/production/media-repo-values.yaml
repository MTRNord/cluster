apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: matrix-media-repo
    namespace: matrix
spec:
    chart:
        spec:
            version: 2.0.x
    values:
        config:
            admins:
                - '@lexi:midnightthoughts.space'
        ## Per-domain configuration.
        ## Ref: https://github.com/turt2live/matrix-media-repo/blob/master/docs/config.md
        ##
        homeservers:
            midnightthoughts.space:
                csApi: https://matrix.midnightthoughts.space
                backoffAt: 10
                adminApiKind: synapse
                identicons:
                    enabled: true
            art.midnightthoughts.space:
                csApi: https://matrix.art.midnightthoughts.space
                backoffAt: 10
                adminApiKind: synapse
                identicons:
                    enabled: true
        ## Ingress configuration.
        ##
        ingress:
            enabled: false
            className: traefik
            annotations:
                #    traefik.ingress.kubernetes.io/router.tls: "true"
                #    traefik.ingress.kubernetes.io/router.middlewares: default-hsts@kubernetescrd,default-redirect-https@kubernetescrd
                traefik.ingress.kubernetes.io/router.middlewares: redirect-media@kubernetescrd
                cert-manager.io/cluster-issuer: letsencrypt-dns
            hosts:
                - host: matrix.midnightthoughts.space
                  paths:
                    - /_matrix/media
            tls:
                - secretName: midnightthoughts-tls-secret
                  hosts:
                    - matrix.midnightthoughts.space
                    - midnightthoughts.space
        postgresql:
            enabled: false
            auth:
                existingSecret: matrix-media-repo-postgresql
                username: matrix_media_repo
                database: matrix_media_repo
            primary:
                persistence:
                    existingClaim: local-data-matrix-media-repo-postgresql-1
        externalPostgresql:
            host: matrix-postgres-cluster.matrix-postgres-cluster.svc.cluster.local
            port: 5432
            username: matrix_media_repo
            password: ENC[AES256_GCM,data:Jh3sl9wJUnJmo9R3NLtLWNwX7r7uosqU4Mww/9XxwFj2eniMD6meDZzNKkSF07OB1UG/QvnAW05PsnfUcVz7Qw==,iv:FpF0lY/R6gidQtBq1paB/dnZXAEB3Em4EzSt8paliyk=,tag:C/2U8CHksRW+mIMeT2DxrA==,type:str]
            database: matrix_media_repo
            sslMode: require
        persistence:
            existingClaim: local-matrix-media-repo
        redis:
            enabled: true
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBPeWNlaXBqeGlqM0tmVWxV
            cEYrVEtpUG4rT2FKYnpVcWRYdjVwVFV5cHdBCjRySG93a3JQaXYrQ2g1L2FZOHpO
            TEl1NW1tRWt2c2RiMjNqRGhOMWp6LzgKLS0tIE5VRnZaY3JWTTVNbFR1MjNWeWtT
            QVJzSUNLQjVqMzgySk1XcWdrblJLaUkKQ9iAW1FtLBCGflQ64L80FnM9hdwAcE2g
            i6ClXKpw6s3DWO1noDRf2LBnTv7UD6QZb/OM4Q1EBJspbcLpqzpMSg==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2023-04-02T14:36:16Z"
    mac: ENC[AES256_GCM,data:z/3q/fSEh51qVjVHO9c+ppOV2CX0d7DYMM7eFdQyOA4pB1VyYEY5LMxG8Daht2KIj2qNZzDBtFTRC9ay5gi8+lH7LRUShdOR5/nzb/A3xUZDKDnMIA+wI2gE0xAN5DJFhj3+jCNjMf5U/YXbyFdUbhoOPTXCmEo6eskl5Us3YoY=,iv:kwRWegX31poyGv98IrLqAyx5CnjSBI83m5KMhIjQ9Rg=,tag:TENfW5I4ZFJ8BhtBRhXYQw==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData|password)$
    version: 3.7.3
