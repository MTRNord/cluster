apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: matrix-media-repo
    namespace: matrix
spec:
    chart:
        spec:
            version: 2.0.x
    values:
        config:
            admins:
                - '@lexi:midnightthoughts.space'
        ## Per-domain configuration.
        ## Ref: https://github.com/turt2live/matrix-media-repo/blob/master/docs/config.md
        ##
        homeservers:
            midnightthoughts.space:
                csApi: https://matrix.midnightthoughts.space
                backoffAt: 10
                adminApiKind: synapse
                identicons:
                    enabled: true
            art.midnightthoughts.space:
                csApi: https://matrix.art.midnightthoughts.space
                backoffAt: 10
                adminApiKind: synapse
                identicons:
                    enabled: true
        ## Ingress configuration.
        ##
        ingress:
            enabled: false
            className: traefik
            annotations:
                #    traefik.ingress.kubernetes.io/router.tls: "true"
                #    traefik.ingress.kubernetes.io/router.middlewares: default-hsts@kubernetescrd,default-redirect-https@kubernetescrd
                traefik.ingress.kubernetes.io/router.middlewares: redirect-media@kubernetescrd
                cert-manager.io/cluster-issuer: letsencrypt-dns
            hosts:
                - host: matrix.midnightthoughts.space
                  paths:
                    - /_matrix/media
            tls:
                - secretName: midnightthoughts-tls-secret
                  hosts:
                    - matrix.midnightthoughts.space
                    - midnightthoughts.space
        postgresql:
            enabled: false
            auth:
                existingSecret: matrix-media-repo-postgresql
                username: matrix_media_repo
                database: matrix_media_repo
            primary:
                persistence:
                    existingClaim: local-data-matrix-media-repo-postgresql-1
        externalPostgresql:
            host: matrix-postgres-cluster.matrix-postgres-cluster.svc.cluster.local
            port: 5432
            username: matrix_media_repo
            password: ENC[AES256_GCM,data:4P7ZUwB5B1ec9gfCJJgw2LITBbD97Ko/gCJmg7btD1fvE7TCZKEvTr5QQ3ATfGWQqD2rOliKj8MQFmadZjGfLw==,iv:TuYPCoFPPxwXsDXIstYWA8Q3BHnzjdF66fsd/yjE/bY=,tag:tyggRBSdYZIOjzWIURICzQ==,type:str]
            database: matrix_media_repo
            sslMode: require
        persistence:
            existingClaim: local-matrix-media-repo
        redis:
            enabled: true
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBjaUl4c1RLaHltdER4c1g3
            OTJDQ0lzVkpmc2dRYkFpMi85Q3JKcmovcEdzCkNyZ2RyVlB6WW54Z3V6RHord1k0
            eHhocGM3U0k0cW1CVjNtd0VYVzZiT0EKLS0tIE9TUHZ2K2xHQ2w1Mk1VUTlWS1Bo
            amh0QnQ0QUQzU1VwMU9sSWZFNGlhd2cKO5eSMHKaT9K6zP9ThldxfNDzXtBzXv4U
            wEcgxEBJsrS6KmTyN26eVynnB8OJB5P9vYx+Ff8S6iXYMmCmcQglTA==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2023-04-02T14:43:23Z"
    mac: ENC[AES256_GCM,data:cJIvmFR+N7MFdrc1cMpF7xDi9w39/+UBZtDyZClQwwei4wgrljlA+TVq5X7Ug4aXsFqjQJz6fZRr81om7xe3LzvP741hVBLno/iuNOicE425hI4DAvt2hq2GWEJjJl6T4QLdkTZwIRfgaXBExqAuYIAlP5jRLfnM32XsWbyli04=,iv:plcMhRL7MdSV77fOq0W+wM4TsDxsZBub++vwu2QaiAQ=,tag:MezS807sZg+KacpNlrKzqA==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData|password)$
    version: 3.7.3
