apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: matrix-synapse
  namespace: matrix
spec:
  releaseName: matrix-synapse
  chart:
    spec:
      version: 3.3.x
  values:
    signingkey:
      job:
        enabled: false
      existingSecret: matrix-synapse-signingkey
      existingSecretKey: signing.key
    image:
      repository: ghcr.io/matrix-org/synapse
      # TODO update properly again
      tag: v1.87.0
      #pullPolicy: Always
    serverName: midnightthoughts.space
    publicServerName: matrix.midnightthoughts.space
    wellknown:
      client:
        m.homeserver:
          base_url: https://matrix.midnightthoughts.space
        org.matrix.msc3575.proxy:
          url: https://sliding.matrix.midnightthoughts.space
    config:
      reportStats: true
      enableRegistration: false
      trustedKeyServers:
        - server_name: matrix.org
    extraConfig:
      registration_shared_secret: ENC[AES256_GCM,data:NKwPzjjnbEcpqk5kCY714sH1DGPzc7Ou16WslbKttFIegmKVfnQJZMwSE5xhmCHQD3un0be3fwO1YycN5vraBw==,iv:U6toRtw2797XYScnIIHnWPgaxzjackkzvBBNGCFGx58=,tag:OFcJTcTE+0dHNSnosebrmg==,type:str]
      app_service_config_files:
        - /data/whatsapp-registration.yaml
        - /data/instagram-registration.yaml
        - /data/signal-registration.yaml
        - /data/hookshot-registration.yaml
    ingress:
      traefikPaths: true
      hosts:
        - midnightthoughts.space
        - matrix.midnightthoughts.space
      tls:
        - hosts:
            - midnightthoughts.space
            - matrix.midnightthoughts.space
          secretName: midnightthoughts-synapse-tls-secret
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-dns
        traefik.ingress.kubernetes.io/router.tls: "true"
        traefik.ingress.kubernetes.io/router.middlewares: default-hsts@kubernetescrd,default-compress@kubernetescrd,default-redirect-https@kubernetescrd
    workers:
      default:
        volumeMounts:
          - mountPath: /data/whatsapp-registration.yaml
            subPath: registration.yaml
            name: whatsapp-config-volume
          - mountPath: /data/instagram-registration.yaml
            subPath: registration.yaml
            name: instagram-config-volume
          - mountPath: /data/signal-registration.yaml
            subPath: registration.yaml
            name: signal-config-volume
          - mountPath: /data/hookshot-registration.yaml
            subPath: registration.yaml
            name: hookshot-config-volume
        volumes:
          - name: whatsapp-config-volume
            configMap:
              name: whatsapp-bridge-config
          - name: instagram-config-volume
            configMap:
              name: instagram-bridge-config
          - name: signal-config-volume
            configMap:
              name: signal-bridge-config
          - name: hookshot-config-volume
            configMap:
              name: hookshot-config
    synapse:
      extraVolumeMounts:
        - mountPath: /data/whatsapp-registration.yaml
          subPath: registration.yaml
          name: whatsapp-config-volume
        - mountPath: /data/instagram-registration.yaml
          subPath: registration.yaml
          name: instagram-config-volume
        - mountPath: /data/signal-registration.yaml
          subPath: registration.yaml
          name: signal-config-volume
        - mountPath: /data/hookshot-registration.yaml
          subPath: registration.yaml
          name: hookshot-config-volume
      extraVolumes:
        - name: whatsapp-config-volume
          configMap:
            name: whatsapp-bridge-config
        - name: instagram-config-volume
          configMap:
            name: instagram-bridge-config
        - name: signal-config-volume
          configMap:
            name: signal-bridge-config
        - name: hookshot-config-volume
          configMap:
            name: hookshot-config
    externalPostgresql:
      username: synapse
      ## The name of an existing secret with postgresql credentials
      existingSecret: synapse-midnightthoughts-postgresql
      database: synapse
sops:
  kms: []
  gcp_kms: []
  azure_kv: []
  hc_vault: []
  age:
    - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
      enc: |
        -----BEGIN AGE ENCRYPTED FILE-----
        YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBKZlZOVFFFYkJjU3ZzWGJZ
        K0lBYnNkelQwRXkyakpaKzJsTHJHL1kzNWtrCkJnWHhoV0NkdnBQdVpmSjRhSk9U
        bFJ6UmJJYnZpOXFhT21yQ28xdnJlelUKLS0tICtoWXdxQ2NSckNrUjdvaUNRRWhG
        Qng5K0RQR3pBOXIyV3ZxRDJJd0p1dWsKo0D8cnzBSktrv/NHMhJjx/mmssjBvX9X
        kCbY5m00We3IoAGk3sPITE15+7dHch2LIFaj+U5K8RQ+7nkxZkAVXQ==
        -----END AGE ENCRYPTED FILE-----
  lastmodified: "2023-07-18T12:56:30Z"
  mac: ENC[AES256_GCM,data:UX9TkoBtxunzywQjblvOnThkALGWkJWPekEe8iZYCHZ/LJt578ImY2BhkzPqwPSaPSLQ7EgEeBzGSrUi/Nrtx+3VZjstGaczKpN+ZWCFtFNf+7pWP5nM42U4US6PEtC7Zcai+MU1WsjvJAOejI02J2p/6cnFRkIKuYG5fdxrqPQ=,iv:FWwPMzsiOf9zi+S0PnvzTeDcm6ooUHN/5RUEKPM8Czo=,tag:Jxtl8UwvTQWuWZR8hCEdAQ==,type:str]
  pgp: []
  encrypted_regex: ^(data|stringData|password|pass|postgresPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret)$
  version: 3.7.3
