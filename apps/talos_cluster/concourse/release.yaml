apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: concourse
    namespace: ci
spec:
    releaseName: concourse
    chart:
        spec:
            version: 19.0.3
            chart: concourse
            sourceRef:
                kind: HelmRepository
                name: concourse
    interval: 50m
    install:
        remediation:
            retries: 3
    values:
        concourse:
            web:
                externalUrl: https://ci.git.midnightthoughts.space
                local_auth:
                    enabled: true
                clusterName: MTRNords CI
                postgres:
                    host: pg-cluster-v2-rw.postgres-cluster.svc.cluster.local
                    database: concourse
                    #sslmode: require
                kubernetes:
                    namespacePrefix: concourse-
                auth:
                    mainTeam:
                        config: |
                            roles:
                                - name: owner
                                  oidc:
                                      users: ["MTRNord"]
                        localUser: "concourse"
                        oidc:
                            enabled: true
                            displayName: "Midnightthoughts SSO"
                            issuer: https://auth.midnightthoughts.space/application/o/concourse/.well-known/openid-configuration
                            userNameKey: preferred_username
                            groupsKey: groups
                            skipEmailVerifiedValidation: true
        secrets:
            create: false
        persistence:
            enabled: true
            storageClass: longhorn
            accessMode: ReadWriteOnce
            size: 10Gi
        postgresql:
            enabled: false
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
    name: concourse
    namespace: ci
spec:
    parentRefs:
        - name: envoy-gateway
          namespace: envoy-gateway
    hostnames:
        - ci.git.midnightthoughts.space
    rules:
        - backendRefs:
              - name: concourse-web
                port: 8080
