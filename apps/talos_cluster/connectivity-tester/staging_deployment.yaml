apiVersion: apps/v1
kind: Deployment
metadata:
  name: connectivity-tester-stage
  namespace: matrix
spec:
  progressDeadlineSeconds: 120
  strategy:
    rollingUpdate:
      maxUnavailable: 0
    type: RollingUpdate
  selector:
    matchLabels:
      app: connectivity-tester-stage
  template:
    metadata:
      labels:
        app: connectivity-tester-stage
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - connectivity-tester-stage
              topologyKey: "kubernetes.io/hostname"
            - labelSelector:
                matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - connectivity-tester-api
              topologyKey: "kubernetes.io/hostname"
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      containers:
        - name: federation-tester-api
          image: ghcr.io/mtrnord/rust-federation-tester:main
          imagePullPolicy: Always
          env:
            - name: RFT_DEBUG
              value: "1"
            - name: RFT_TRACE_SPANS
              value: "close"
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_UID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.uid
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: DEPLOYMENT_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.labels['deployment']
            # Forward the K8s metadata to the app via OTEL_RESOURCE_ATTRIBUTES
            - name: OTEL_RESOURCE_ATTRIBUTES
              value: k8s.pod.name=$(POD_NAME),k8s.pod.uid=$(POD_UID),k8s.namespace.name=$(POD_NAMESPACE),k8s.node.name=$(NODE_NAME),k8s.deployment.name=$(DEPLOYMENT_NAME)
            - name: OTEL_EXPORTER_OTLP_TRACES_ENDPOINT
              value: "http://clickstack-otel-collector.clickstack.svc.cluster.local:4318"
          resources:
            limits: {}
            requests:
              memory: "344Mi"
              cpu: "252m"
          securityContext:
            runAsUser: 1000
            runAsGroup: 1000
            readOnlyRootFilesystem: true
          volumeMounts:
            - name: api-config
              mountPath: /app/config.yaml
              subPath: config.yaml
              readOnly: true
          ports:
            - containerPort: 8080
              name: api
              protocol: TCP
          readinessProbe:
            httpGet:
              path: /healthz
              port: api
              scheme: HTTP
          livenessProbe:
            httpGet:
              path: /healthz
              port: api
              scheme: HTTP
          startupProbe:
            httpGet:
              path: /healthz
              port: api
        - name: connection-checker-ui
          image: ghcr.io/mtrnord/matrix-connection-tester-ui:main
          imagePullPolicy: Always
          lifecycle:
            preStop:
              exec:
                command:
                  - sleep
                  - "10"
          resources:
            limits: {}
            requests:
              memory: "344Mi"
              cpu: "252m"
          ports:
            - containerPort: 8000
              name: web
              protocol: TCP
          volumeMounts:
            - name: configs
              mountPath: "/app/_fresh/client/config.json"
              subPath: config.json
              readOnly: true
            - mountPath: /tmp
              name: tmp
          livenessProbe:
            httpGet:
              path: /
              port: web
              scheme: HTTP
          readinessProbe:
            httpGet:
              path: /
              port: web
              scheme: HTTP
          startupProbe:
            httpGet:
              path: /
              port: web
      volumes:
        - name: configs
          configMap:
            name: connectivity-tester-stage-config
        - name: tmp
          emptyDir:
            sizeLimit: 2048Mi
        - name: api-config
          secret:
            secretName: connectivity-tester-stage-config
---
apiVersion: v1
kind: Service
metadata:
  name: connectivity-tester-stage
spec:
  selector:
    app: connectivity-tester-stage
  ports:
    - name: api
      port: 8080
      targetPort: 8080
    - name: web
      port: 8000
      targetPort: 8000
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: connectivity-tester-stage
  namespace: matrix
spec:
  parentRefs:
    - name: envoy-gateway
      namespace: envoy-gateway
  hostnames:
    - stage.connectivity-tester.mtrnord.blog
    - beta.connectivity-tester.mtrnord.blog
  rules:
    - matches:
        - path:
            value: /api
            type: PathPrefix
        - path:
            value: /api-docs
            type: PathPrefix
        - path:
            value: /metrics
            type: PathPrefix
      backendRefs:
        - name: connectivity-tester-stage
          port: 8080
      timeouts:
        request: 240s
        backendRequest: 0s
    - matches:
        - path:
            value: /
            type: PathPrefix
      backendRefs:
        - name: connectivity-tester-stage
          port: 8000
      timeouts:
        request: 240s
        backendRequest: 0s
