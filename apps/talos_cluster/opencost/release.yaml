apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: opencost
  namespace: opencost
spec:
  releaseName: opencost
  interval: 30m
  chart:
    spec:
      chart: opencost
      sourceRef:
        kind: HelmRepository
        name: opencost
        namespace: opencost
      interval: 1h
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    opencost:
      exporter:
        defaultCloudBackend: custom
        extraEnv:
          USE_CSV_PROVIDER: "true"
          CSV_PATH: "/etc/opencost/pricing/hetzner.csv"
        extraVolumeMounts:
          - name: hetzner-pricing
            mountPath: /etc/opencost/pricing
            readOnly: true
      prometheus:
        internal:
          enabled: true
          # vmselect service from the victoria-metrics-k8s-stack HelmRelease (name: vm)
          serviceName: vmselect-vm-victoria-metrics-k8s-stack
          namespaceName: monitoring
          port: 8481
          path: /select/0/prometheus/
    serviceMonitor:
      enabled: true
      namespace: monitoring
    extraVolumes:
      - name: hetzner-pricing
        configMap:
          name: hetzner-pricing-csv
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: opencost
  namespace: opencost
spec:
  parentRefs:
    - name: envoy-gateway
      namespace: envoy-gateway
  hostnames:
    - opencost.k8s.midnightthoughts.space
  rules:
    - backendRefs:
        - name: opencost
          port: 9090
      timeouts:
        request: 240s
        backendRequest: 0s
