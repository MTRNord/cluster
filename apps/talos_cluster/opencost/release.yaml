apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: opencost
  namespace: opencost
spec:
  releaseName: opencost
  interval: 30m
  chart:
    spec:
      chart: opencost
      sourceRef:
        kind: HelmRepository
        name: opencost
        namespace: opencost
      interval: 1h
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    opencost:
      exporter:
        defaultClusterId: "midnighthtoughts"
        defaultCloudBackend: custom
        extraEnv:
          USE_CSV_PROVIDER: "true"
          CSV_PATH: "/etc/opencost/pricing/hetzner.csv"
          PROM_CLUSTER_ID_LABEL: cluster
          KUBECOST_SCRAPE_INTERVAL: 1m
        extraVolumeMounts:
          - name: hetzner-pricing
            mountPath: /etc/opencost/pricing
            readOnly: true
      prometheus:
        external:
          enabled: true
          url: http://thanos-query-frontend.monitoring.svc.cluster.local:10902
        internal:
          enabled: false
    extraVolumes:
      - name: hetzner-pricing
        configMap:
          name: hetzner-pricing-csv
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: opencost
  namespace: opencost
spec:
  endpoints:
    - port: http
      path: /metrics
  selector:
    matchLabels:
      app.kubernetes.io/instance: opencost
  namespaceSelector:
    matchNames:
      - opencost
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: opencost
  namespace: opencost
spec:
  parentRefs:
    - name: envoy-gateway
      namespace: envoy-gateway
  hostnames:
    - opencost.k8s.midnightthoughts.space
  rules:
    - backendRefs:
        - name: opencost
          port: 9090
      timeouts:
        request: 240s
        backendRequest: 0s
