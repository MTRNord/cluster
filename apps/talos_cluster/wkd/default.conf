limit_req_zone $binary_remote_addr zone=one:10m rate=10r/s;
limit_conn_zone $binary_remote_addr zone=addr:10m;
server {
    listen 8080;
    server_name _;
    
    root /usr/share/nginx/html;
    index index.html;

    limit_conn addr 10;

    # Security headers
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options DENY;
    add_header X-XSS-Protection "1; mode=block";

    # wkd specific configuration
    location /.well-known/openpgpkey/hu/p6d5q6ozbrkcy3cnexq8s8uzh1rk9fbs {
        limit_req zone=one burst=20 nodelay;
        add_header Content-Type "application/octet-stream; charset=utf-8";
        add_header Cache-Control "max-age=604800";
        try_files $uri =404;
    }
    location /.well-known/openpgpkey/nordgedanken.dev/hu/p6d5q6ozbrkcy3cnexq8s8uzh1rk9fbs {
        limit_req zone=one burst=20 nodelay;
        add_header Content-Type "application/octet-stream; charset=utf-8";
        add_header Cache-Control "max-age=604800";
        try_files $uri =404;
    }
    location /.well-known/openpgpkey/policy {
        limit_req zone=one burst=20 nodelay;
        add_header Content-Type text/plain;
        return 200 "";
    }
    location / {
        limit_req zone=one burst=20 nodelay;
        add_header Content-Type text/plain;
        return 200 "OK";
    }

    # Tell synapse to not look for a matrix server here
    location /.well-known/matrix/server {
        limit_req zone=one burst=20 nodelay;
        return 410;
    }
    location /_matrix {
        limit_req zone=one burst=20 nodelay;
        return 410;
    }

    # Health check endpoint
    location /health {
        access_log off;
        add_header Content-Type text/plain;
        return 200 "healthy";
    }

    # Disable server tokens
    server_tokens off;
}
