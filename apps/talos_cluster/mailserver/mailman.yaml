apiVersion: apps/v1
kind: StatefulSet
metadata:
    name: mailman
    namespace: mailserver
spec:
    serviceName: mailman
    replicas: 1
    selector:
        matchLabels:
            app: mailman
    template:
        metadata:
            labels:
                app: mailman
        spec:
            hostAliases:
                - ip: 0.0.0.0
                  hostnames:
                    - mailman.mailserver.svc.cluster.local
                - ip: 127.0.0.1
                  hostnames:
                    - mailman-web
            containers:
                - name: core
                  image: ghcr.io/mtrnord/mailman-core:rolling
                  imagePullPolicy: Always
                  ports:
                    - name: api
                      containerPort: 8001
                    - name: lmtp
                      containerPort: 8024
                  env:
                    - name: DATABASE_URL
                      valueFrom:
                        secretKeyRef:
                            name: mailmancore
                            key: url
                    - name: DATABASE_TYPE
                      value: postgres
                    - name: DATABASE_CLASS
                      value: mailman.database.postgresql.PostgreSQLDatabase
                    - name: HYPERKITTY_API_KEY
                      valueFrom:
                        secretKeyRef:
                            name: mailman-passwords
                            key: apikey
                    - name: MAILMAN_REST_USER
                      value: restadm
                    - name: MAILMAN_REST_PASSWORD
                      valueFrom:
                        secretKeyRef:
                            name: mailman-passwords
                            key: restpassword
                    - name: SMTP_HOST
                      value: mail.midnightthoughts.space
                    - name: SMTP_PORT
                      value: "465"
                    - name: SMTP_USE_SSL
                      value: "true"
                    - name: SMTP_USER
                      valueFrom:
                        secretKeyRef:
                            name: mailman-passwords
                            key: smtp_user
                    - name: SMTP_PASSWORD
                      valueFrom:
                        secretKeyRef:
                            name: mailman-passwords
                            key: smtp_password
                    - name: MTA
                      value: postfix
                    - name: MM_HOSTNAME
                      value: mailman.mailserver.svc.cluster.local
                    - name: HYPERKITTY_URL
                      value: http://localhost:8000/hyperkitty
                  volumeMounts:
                    - name: mailman-opt
                      mountPath: /opt/mailman
                    - name: mailman-extra
                      mountPath: /opt/mailman/mailman-extra.cfg
                      subPath: mailman-extra.cfg
                    - name: mailman-extra
                      mountPath: /usr/bin/chown
                      subPath: chown
                - name: web
                  image: ghcr.io/mtrnord/mailman-web:rolling
                  imagePullPolicy: Always
                  ports:
                    - name: http
                      containerPort: 8000
                    - name: uwsgi
                      containerPort: 8080
                  #command:
                  #  - tail
                  #args:
                  #  - -f
                  #  - /dev/null
                  env:
                    - name: DATABASE_URL
                      valueFrom:
                        secretKeyRef:
                            name: mailmanweb
                            key: url
                    - name: DATABASE_TYPE
                      value: postgres
                    - name: DATABASE_CLASS
                      value: mailman.database.postgresql.PostgreSQLDatabase
                    - name: HYPERKITTY_API_KEY
                      valueFrom:
                        secretKeyRef:
                            name: mailman-passwords
                            key: apikey
                    - name: MAILMAN_REST_USER
                      value: restadm
                    - name: MAILMAN_REST_PASSWORD
                      valueFrom:
                        secretKeyRef:
                            name: mailman-passwords
                            key: restpassword
                    - name: SECRET_KEY
                      valueFrom:
                        secretKeyRef:
                            name: mailman-passwords
                            key: websecretkey
                    - name: POSTORIUS_TEMPLATE_BASE_URL
                      value: http://localhost:8000/
                    # serving static files by uwsgi
                    - name: UWSGI_STATIC_MAP
                      value: /static=/opt/mailman-web-data/static
                    - name: MAILMAN_ADMIN_USER
                      value: admin
                    - name: MAILMAN_ADMIN_EMAIL
                      value: mtrnord@nordgedanken.dev
                    - name: MAILMAN_HOST_IP
                      value: 127.0.0.1
                    - name: MAILMAN_HOSTNAME
                      value: localhost
                    - name: SERVE_FROM_DOMAIN
                      value: lists.midnightthoughts.space
                    - name: MAILMAN_REST_URL # MAILMAN_REST_API_URL is set from this variable in settings.
                      value: http://127.0.0.1:8001
                    - name: MAILMAN_REST_API_USER
                      value: restadm
                    - name: MAILMAN_REST_API_PASS
                      valueFrom:
                        secretKeyRef:
                            name: mailman-passwords
                            key: restpassword
                    - name: SMTP_HOST
                      value: mail.midnightthoughts.space
                    - name: SMTP_PORT
                      value: "465"
                    - name: SMTP_USE_SSL
                      value: "true"
                    - name: SMTP_USER
                      valueFrom:
                        secretKeyRef:
                            name: mailman-passwords
                            key: smtp_user
                    - name: SMTP_PASSWORD
                      valueFrom:
                        secretKeyRef:
                            name: mailman-passwords
                            key: smtp_password
                  # otherwise django cannot find the mysql driver.
                  #- name: DYLD_LIBRARY_PATH
                  #  value: /usr/local/mysql/lib/

                  volumeMounts:
                    - name: mailman-web
                      mountPath: /opt/mailman-web-data
                    - name: mailman-extra
                      mountPath: /opt/mailman-web-data/settings_local.py
                      subPath: settings_local.py
                    - name: mailman-extra
                      mountPath: /usr/bin/chown
                      subPath: chown
                - name: nginx
                  image: ghcr.io/nginx/nginx-unprivileged:stable-alpine
                  imagePullPolicy: IfNotPresent
                  ports:
                    - name: http
                      containerPort: 9090
                  volumeMounts:
                    - name: mailman-web
                      mountPath: /opt/mailman-web-data
                      readOnly: true
                    - name: nginx-config
                      mountPath: /etc/nginx/nginx.conf
                      subPath: nginx.conf
                      readOnly: true
                    - name: tmp
                      mountPath: /tmp
                      readOnly: false
                    - name: tmp-client-body
                      mountPath: /tmp/nginx/client_body
                      readOnly: false
                    - name: tmp-cgi
                      mountPath: /tmp/nginx/fastcgi
                      readOnly: false
                    - name: tmp-cgi
                      mountPath: /tmp/nginx/uwsgi
                      readOnly: false
                    - name: tmp-cgi
                      mountPath: /tmp/nginx/scgi
                      readOnly: false
            volumes:
                - name: mailman-extra
                  secret:
                    secretName: mailman-extra
                    defaultMode: 0555
                - name: nginx-config
                  configMap:
                    name: mailman-nginx
                - name: tmp
                  emptyDir: {}
                - name: tmp-client-body
                  emptyDir: {}
                - name: tmp-cgi
                  emptyDir: {}
    volumeClaimTemplates:
        - apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: mailman-opt
            namespace: mailserver
          spec:
            storageClassName: longhorn
            accessModes:
                - ReadWriteMany
            resources:
                requests:
                    storage: 10Gi
        - apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: mailman-web
            namespace: mailserver
          spec:
            storageClassName: longhorn
            accessModes:
                - ReadWriteMany
            resources:
                requests:
                    storage: 10Gi
---
apiVersion: v1
kind: Service
metadata:
    name: mailman
    namespace: mailserver
spec:
    type: ClusterIP
    selector:
        app: mailman
    ports:
        - name: api
          port: 8001
        - name: lmtp
          port: 8024
        - name: http
          port: 8000
        - name: uwsgi
          port: 8080
        - name: nginx
          port: 9090
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
    name: mailman
    namespace: mailserver
spec:
    parentRefs:
        - name: envoy-gateway
          namespace: envoy-gateway
    hostnames:
        - lists.midnightthoughts.space
    rules:
        - backendRefs:
            - name: mailman
              port: 9090
          timeouts:
            request: 240s
            backendRequest: 0s
