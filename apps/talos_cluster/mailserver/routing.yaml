apiVersion: gateway.networking.k8s.io/v1alpha2
kind: TCPRoute
metadata:
    name: mailserver-smtp
    namespace: mailserver
    annotations:
        external-dns.alpha.kubernetes.io/hostname: mail.midnightthoughts.space
spec:
    parentRefs:
        - name: email-gateway
          namespace: envoy-gateway
          sectionName: smtp
    rules:
        - backendRefs:
            - name: mailserver-docker-mailserver
              port: 12525
---
apiVersion: gateway.networking.k8s.io/v1alpha2
kind: TCPRoute
metadata:
    name: mailserver-submissions
    namespace: mailserver
    annotations:
        external-dns.alpha.kubernetes.io/hostname: mail.midnightthoughts.space
spec:
    parentRefs:
        - name: email-gateway
          namespace: envoy-gateway
          sectionName: submissions
    rules:
        - backendRefs:
            - name: mailserver-docker-mailserver
              port: 10465
---
apiVersion: gateway.networking.k8s.io/v1alpha2
kind: TCPRoute
metadata:
    name: mailserver-submission
    namespace: mailserver
    annotations:
        external-dns.alpha.kubernetes.io/hostname: mail.midnightthoughts.space
spec:
    parentRefs:
        - name: email-gateway
          namespace: envoy-gateway
          sectionName: submission
    rules:
        - backendRefs:
            - name: mailserver-docker-mailserver
              port: 10587
---
apiVersion: gateway.networking.k8s.io/v1alpha2
kind: TCPRoute
metadata:
    name: mailserver-imap
    namespace: mailserver
    annotations:
        external-dns.alpha.kubernetes.io/hostname: mail.midnightthoughts.space
spec:
    parentRefs:
        - name: email-gateway
          namespace: envoy-gateway
          sectionName: imap
    rules:
        - backendRefs:
            - name: mailserver-docker-mailserver
              port: 10143
---
apiVersion: gateway.networking.k8s.io/v1alpha2
kind: TCPRoute
metadata:
    name: mailserver-imaps
    namespace: mailserver
    annotations:
        external-dns.alpha.kubernetes.io/hostname: mail.midnightthoughts.space
spec:
    parentRefs:
        - name: email-gateway
          namespace: envoy-gateway
          sectionName: imaps
    rules:
        - backendRefs:
            - name: mailserver-docker-mailserver
              port: 10993
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: BackendTrafficPolicy
metadata:
    name: mail-policy
    namespace: mailserver
spec:
    targetRefs:
        - group: gateway.networking.k8s.io
          kind: TCPRoute
          name: mailserver-imaps
        - group: gateway.networking.k8s.io
          kind: TCPRoute
          name: mailserver-imap
        - group: gateway.networking.k8s.io
          kind: TCPRoute
          name: mailserver-submission
        - group: gateway.networking.k8s.io
          kind: TCPRoute
          name: mailserver-submissions
        - group: gateway.networking.k8s.io
          kind: TCPRoute
          name: mailserver-smtp
    proxyProtocol:
        version: "V2"
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
    name: mailserver-docker-mailserver-rspamd
    namespace: mailserver
spec:
    parentRefs:
        - name: envoy-gateway
          namespace: envoy-gateway
    hostnames:
        - rspamd.midnightthoughts.space
    rules:
        - backendRefs:
            - name: mailserver-docker-mailserver
              port: 11334
          timeouts:
            request: 240s
            backendRequest: 0s
