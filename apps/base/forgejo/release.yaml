apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: forgejo
    namespace: forgejo
spec:
    releaseName: forgejo
    chart:
        spec:
            #chart: forgejo
            chart: .
            sourceRef:
                #kind: HelmRepository
                kind: GitRepository
                name: forgejo-git
    interval: 50m
    timeout: 25m
    install:
        timeout: 25m
        remediation:
            retries: 3
    values:
        containerSecurityContext:
            capabilities:
                add:
                    - SYS_CHROOT
        signing:
            enabled: true
        memcached:
            enabled: true
        persistence:
            enabled: true
            existingClaim: data-gitea-0
            size: 50Gi
        ingress:
            enabled: true
            annotations:
                cert-manager.io/cluster-issuer: letsencrypt-dns
            hosts:
                - host: git.nordgedanken.dev
                  paths:
                    - path: /
                      pathType: Prefix
            tls:
                - secretName: git.nordgedanken.dev-tls
                  hosts:
                    - git.nordgedanken.dev
        gitea:
            oauth:
                - name: keycloak
                  provider: openidConnect
                  key: gitea
                  secret: ENC[AES256_GCM,data:697LZgGNTEIX1nJnq6eBw9Y2vZ0b7o/hHYWM+qulTJo=,iv:1h8tXFCDGgfeoFBqtoaqZoEXiE1zbCQrfsexDKPqCss=,tag:zi9TYNVJPcGts0Vx4Be5OQ==,type:str]
                  autoDiscoverUrl: https://keycloak.midnightthoughts.space/realms/Gitea/.well-known/openid-configuration
            admin:
                username: gitea_admin
                password: ENC[AES256_GCM,data:911K1L3rOszqcOVw6g3g3hsJgozLDQgJ0CCrlQLR5rBun7a7cPtWmhMrACg54b0ldWPpdkoiY2Vc4TPtsrkmWw==,iv:oopvqZvh5OwFpU7QcXrO0XgOPppwbmgVUV5fFrUJzHo=,tag:DyeHoHJx4PMJQgJqZLEM1A==,type:str]
                email: ops@nordgedanken.dev
            metrics:
                enabled: true
                serviceMonitor:
                    enabled: true
            config:
                actions:
                    ENABLED: true
                    DEFAULT_ACTIONS_URL: https://git.nordgedanken.dev
                indexer:
                    ISSUE_INDEXER_TYPE: bleve
                    REPO_INDEXER_ENABLED: true
                repository:
                    MAX_CREATION_LIMIT: 0
                    DISABLE_HTTP_GIT: false
                service:
                    DISABLE_REGISTRATION: true
                    ALLOW_ONLY_EXTERNAL_REGISTRATION: true
                    DEFAULT_KEEP_EMAIL_PRIVATE: true
                oauth2_client:
                    ENABLE_AUTO_REGISTRATION: true
                server:
                    ROOT_URL: https://git.nordgedanken.dev
                    SSH_PORT: 22
                    LFS_START_SERVER: true
                    START_SSH_SERVER: false
                federation:
                    ENABLED: true
                mailer:
                    ENABLED: true
                    FROM: ops@nordgedanken.dev
                    SMTP_ADDR: mail.nordgedanken.dev
                    SMTP_PORT: 465
                    PROTOCOL: smtps
                    USER: ops@nordgedanken.dev
                    PASSWD: ENC[AES256_GCM,data:yQcXabPyjOIu,iv:VpV32FwLjQ96UJv6yl1P3WkyexhNjsgsE2VgWq7lYzE=,tag:wVhwCS4urAVkjBKZIs5/Jw==,type:str]
        postgresql:
            enabled: true
            global:
                postgresql:
                    postgresqlDatabase: gitea
                    postgresqlUsername: gitea
                    postgresqlPassword: ENC[AES256_GCM,data:S0J9NyEzdtZyEF27TEsFttBnBQdloxiaOIJqnrCG0oEAqockrFA4kvXeAHCybSD+bMpSGcrZDvSlHma0OoZNXQ==,iv:S+XzkscJROxP0p3HRMmYR442FAixZy2o4vuEZWKpj3E=,tag:BszT8z7Q5ioQz3h8XIAktA==,type:str]
                    servicePort: 5432
            persistence:
                enabled: true
                existingClaim: data-gitea-postgresql-0
                size: 25Gi
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBhckk0UVBlME5hbXErRHhB
            WlN3Y0JxZS9lV0FwK2x4cDcrMmF4cVdORnlRClZGaTU1THF0a2JaYzQzUktDQW1H
            VWt1Y2MvZDZzSWFxY3J1RzljOHhlL0UKLS0tIGFMY3VCMlhZQit2ZU1wZVZOWkhZ
            SURTK1MwU0hiUFZiNE5FbEtBN2U2ZWcK8dzPLlGQWk7WysxUNiRxy8gzzzo/Ek2w
            lLe03Alng++eOW7l6tSSA2A9gZewrC4/QIM508yBKQDvD/Y+pnf6lA==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2023-08-10T18:42:04Z"
    mac: ENC[AES256_GCM,data:AftQsIQi3X23CYtDmQq1gh7yOZXR2eqnFOxe9uVKue4Bmtqzz0EvSLLwuFxXpBm14QV8JLCZ6Rk2YTDqrvyRaGh69zo4cwPZcRYWjO3fS+scZ3tUkhbgNA4PUy6m+sffuoMhaKW6Q3SnHdDn/nhmSUo2YHKvne4gQcl17UC7efg=,iv:yJse9etcUsu8SaHy26WSlsHFvBM4a/iIUOIPPZKz6MY=,tag:I0knyJHtDun/OmyWUZgdgA==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData|PASSWD|password|pass|postgresPassword|postgresqlPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret)$
    version: 3.7.3
