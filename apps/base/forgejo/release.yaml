apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: forgejo
    namespace: forgejo
spec:
    releaseName: forgejo
    chart:
        spec:
            chart: forgejo
            sourceRef:
                kind: HelmRepository
                name: forgejo
    interval: 50m
    timeout: 25m
    install:
        timeout: 25m
        remediation:
            retries: 3
    values:
        # image:
        #     # Codeberg.org was down.
        #     registry: docker.io
        #     repository: mtrnord/forgejo
        #     # Overrides the image tag whose default is the chart appVersion.
        #     tag: "1.20"
        tolerations:
            - key: arch
              operator: Equal
              value: arm64
              effect: NoSchedule
        containerSecurityContext:
            capabilities:
                add:
                    - SYS_CHROOT
        signing:
            enabled: true
            privateKey: ENC[AES256_GCM,data:q2EGvhlqIpIAltL41svQ1axJHTD09pCmSxFpHAYNYA+Zepq/jdXKdwoiuHLK9EgeLuZlOue/C74ZA5vie7VXR/x/usPFO6/PY23nyJcrbEukeW8ACKMDwwbf3CBBgz4Yfp3d+1tzyTOoNV5sViITjuL6qb6AavZMVN1He2mHm6WAFtS1EPOqZI1OPZIaCgtxE90hRJ9f+sizKumNBRjNh/A7GDC21kQkBP8aEySumP/Ajs90hKLtvDP3HNqPMTu8+6P7ydgwXIk9kSlRypbT4a2ipaCGMIiAm5XORme+JTGtA+kJVcE5LVaXMA7/d6HcW6EKWk/c6Lqq1xTXFa2YkS4XN4GeMddC9KQp58NXsN5lgGKg/PCgtR+jdgxCSlDJ+CuonWDzylRPBuht79iMakwqDNhGof38RSDVZWT/JOjuIRRp63JHj2L8eTB0SmlE8Jf7PyYq5fLLbBSWUH2byrN0AZ+5kD7ePrXcShb/GtJbiKXBtRplUYkHNmC2mOqYKH6FUkFtcs+36PyBSr+RYiMjHCQolf6O/dc5f7Mm2iwv5xPqqZ+MblY5Lt5u1UfCwha6uSM24e5YSj3THHQuD+k+RxWsPTnl0kDP1eSOlZYFmCoL6dsorRjUl8Nl1mKz+UvB0PvQKiQrxmG6H8F+2LmJu4WvwhiRaWkjE+h95+u+wnB+JseVVc6I3Gg5Zj/DT1HNQvZDILHm1iPFHhlyecMUUAe9Q9Sh/Gk0b53NDqImctbOFY+mmq8iBMqQ4YT5+l3jFwHpnVloFo4i4lx6KPCJTUN7H9xKq5Uxq0ScSomnWjt7MFCxBkKsU4TCya8sp9yr3/7QtMnjPsi3HeXeYBFOcURoHi2Yr+IkPk1kg86UpSA0/ba4f/dzUld8NzhmJ3gxfGPFFBVMsEroPU0JfQyof6u8lARdnyh90mI340Kc7T7Scc3AsxtJ9RUZ1CZVRV+YiYZjE0J6UNuL3nIDXH/XhNpAiBG6tTKjsSf/mI9DgBDStcoWlw==,iv:IJbmILZhSrsBpoqknl8B+zkAW292Ovl8/DBuUOEcWJU=,tag:wnh4UJ/Aru1TUXIsJu+12A==,type:str]
        persistence:
            enabled: true
            create: false
            size: 50Gi
            claimName: data-forgejo-0
        ingress:
            enabled: true
            annotations:
                cert-manager.io/cluster-issuer: letsencrypt-http
            hosts:
                - host: git.nordgedanken.dev
                  paths:
                    - path: /
                      pathType: Prefix
            tls:
                - secretName: git.nordgedanken.dev-tls
                  hosts:
                    - git.nordgedanken.dev
        gitea:
            oauth:
                - name: keycloak
                  provider: openidConnect
                  key: gitea
                  secret: ENC[AES256_GCM,data:CVIT5cGmGSfn4ejb05w0Kxr/olIpMeBx2zL4PjTPwns=,iv:6k4qdKp0nP9UyvRIBuHnHVp3yo5u+ZRgENLWoi3EqIY=,tag:5rLgXrlZWfpjP+5/kVqy3w==,type:str]
                  autoDiscoverUrl: https://keycloak.midnightthoughts.space/realms/Gitea/.well-known/openid-configuration
            admin:
                username: gitea_admin
                password: ENC[AES256_GCM,data:/1Khn/RNpe1BuPLF4b2l8mmH0kJuNCd69QfUHE2uo5v6tJqbbk24w+uExghuM0aTpa/jaXhzsAvh2vMSU1EBbA==,iv:+of+SmL0utVqr7cY0fUInsqoElEOVj2IAiYZYscod80=,tag:5ROrBXvWf1VIh+TflU+WJA==,type:str]
                email: ops@nordgedanken.dev
            metrics:
                enabled: true
                serviceMonitor:
                    enabled: true
            config:
                metrics:
                    ENABLED: true
                    ENABLED_ISSUE_BY_REPOSITORY: true
                    ENABLED_ISSUE_BY_LABEL: true
                actions:
                    ENABLED: true
                    DEFAULT_ACTIONS_URL: https://git.nordgedanken.dev
                indexer:
                    ISSUE_INDEXER_TYPE: bleve
                    REPO_INDEXER_ENABLED: true
                repository:
                    MAX_CREATION_LIMIT: 0
                    DISABLE_HTTP_GIT: false
                service:
                    DISABLE_REGISTRATION: true
                    ALLOW_ONLY_EXTERNAL_REGISTRATION: true
                    DEFAULT_KEEP_EMAIL_PRIVATE: true
                oauth2_client:
                    ENABLE_AUTO_REGISTRATION: true
                server:
                    ROOT_URL: https://git.nordgedanken.dev
                    SSH_PORT: 2222
                    LFS_START_SERVER: true
                    START_SSH_SERVER: true
                federation:
                    ENABLED: true
                mailer:
                    ENABLED: true
                    FROM: ops@nordgedanken.dev
                    SMTP_ADDR: mail.nordgedanken.dev
                    SMTP_PORT: 465
                    PROTOCOL: smtps
                    USER: ops@nordgedanken.dev
                    PASSWD: ENC[AES256_GCM,data:O6r2uOsPE28A,iv:DIox5pYytIl2uEvlVqtSm8IWGmDeYe9upjvvPkC52Fw=,tag:DapIgcKLFHkeA2n1yDGdOA==,type:str]
                session:
                    #PROVIDER: redis-cluster
                    PROVIDER: redis
                    PROVIDER_CONFIG: redis://:@forgejo-keydb.forgejo.svc.cluster.local:6379/0
                    #PROVIDER_CONFIG: redis+cluster://:@forgejo-redis-cluster-headless.forgejo.svc.cluster.local:6379/0?pool_size=100&idle_timeout=180s&
                cache:
                    ENABLED: true
                    ADAPTER: redis
                    #ADAPTER: redis-cluster
                    #HOST: redis+cluster://:@forgejo-redis-cluster-headless.forgejo.svc.cluster.local:6379/0?pool_size=100&idle_timeout=180s&
                    HOST: redis://:@forgejo-keydb.forgejo.svc.cluster.local:6379/0?pool_size=100&idle_timeout=180s
                queue:
                    TYPE: redis
                    #CONN_STR: redis+cluster://:@forgejo-redis-cluster-headless.forgejo.svc.cluster.local:6379/0?pool_size=100&idle_timeout=180s&
                    CONN_STR: redis://:@forgejo-keydb.forgejo.svc.cluster.local:6379/0
        redis-cluster:
            enabled: false
        postgresql-ha:
            enabled: false
        postgresql:
            image:
                registry: docker.io
                repository: bitnami/postgresql
                tag: 11.11.0-debian-10-r62
            enabled: true
            global:
                postgresql:
                    service:
                        ports:
                            postgresql: 5432
                    auth:
                        password: ENC[AES256_GCM,data:T4Z/E43GR9M4dsQIZtJkYQkWF7e2X3a0AUeleBsxTlmwRu598W2DmLyTgk/N2YwIQ/gPA583Wn/fJqhkMQRf0w==,iv:w1tu00eHvAzicJBUVtWxTk1YYZW1vo25ZByZEVSiqQ0=,tag:akBuNgyA+uFy3T1pp5apkA==,type:str]
                        database: gitea
                        username: gitea
            auth:
                database: gitea
                username: gitea
                postgresPassword: ENC[AES256_GCM,data:29uGZw3VawguUg==,iv:3EZkM/8hq/hHVEcKc2ZZm0+geZ9MOyyyQRu19O2qk4Q=,tag:zn9kcklLayUpo7s9Hd601A==,type:str]
                password: ENC[AES256_GCM,data:brZSTTDILdVcuWdqt7qjHElV0pMzb0C2TXUXCxaslf3P48IPM+WC3y8CFlna829WhF8sK8yNs8OmrJKVqR0uSA==,iv:fXWfq0XNs/GQsADDBebPh/ExjEMPiBg1exj01F2dTKg=,tag:qaiHoTI7ZMyFBLh1Q7AJkQ==,type:str]
            persistence:
                enabled: true
                size: 25Gi
            primary:
                networkPolicy:
                    enabled: false
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBYaW44RHZFRzE4TzlmVkRN
            cTRjeHV4SFllcjNuSjg2alFuSDVrZVJ0ZkZ3ClFSWE5Qa1I1OEM5WlRWSXNuN1ZP
            WDN0T3ppSmpQajk5dVpXU2t2bEVtU3MKLS0tIDZtbldIT2MrQUw4dE85aWQvaGFy
            d3k5Qkc4K3plUk80YTNYblBzdDdWLzQKJwxRFp0xM0M/YQt1UYO+gyiMX2Lsxwfw
            dX6Va5dT9C8iGAkQ5wwdZ0GK153XoxcJjFvtsOFqPLFebxjay8YAig==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-04-21T12:14:11Z"
    mac: ENC[AES256_GCM,data:+1FyXz33iTQaPb+HCpI0o5v9CFY7BgzLBwN0D/hX4cya85xKxCRGDoG6ePQm0SoZswghlszDv2EBRCb3ZjW6A4vzXJxLPqq8TMOnKVSXMd0GSSgaivkGX32GX+gR27hL97FZQ4CDnuBuhGhxT0NpCe4s9TA2uAA/eh8fQw4hBVc=,iv:k38WzExq+B4QDAmDguW2aD2fdPwzJAEu0YF/SlFXMuc=,tag:MNZbfGVgbWGIUzgl0dhxPw==,type:str]
    pgp: []
    encrypted_regex: ^(AUTHENTICATION_PASSWORD|ROOM_API_SECRET_KEY|adminPassword|configPassword|adminUser|configUser|APP_KEY|api_key|api_secret|keys|livekit_key|livekit_secret|secret_key|adminPassword|admin_pass|admin_email|mariadbPassword|mariadbRootPassword|privateKey|data|stringData|PASSWD|password|pass|postgresPassword|postgresqlPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret)$
    version: 3.8.1
