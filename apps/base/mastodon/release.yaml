apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
    name: mastodon
    namespace: mastodon
spec:
    interval: 1h
    releaseName: mastodon
    chart:
        spec:
            chart: .
            sourceRef:
                kind: GitRepository
                name: mastodon
                namespace: mastodon
    timeout: 4h
    upgrade:
        timeout: 2h
    install:
        timeout: 2h
        remediation:
            retries: 3
    values:
        image:
            tag: v4.4.2
        imagePullSecrets:
            - name: ghcr-pull
        externalAuth:
            oidc:
                enabled: true
                client_id: ENC[AES256_GCM,data:5uyYhXZxwGB+QIdBjELxeBHKJgmzibGhGfZPZfkDsIFe3tCoxBhsJA==,iv:7lu3RCcULLdrfGJ5kOxSFcNkPNCLP5HiQAuzUB1gaF4=,tag:iluu+3uIS2do1c13fjs1aw==,type:str]
                client_secret: ENC[AES256_GCM,data:9Fq+qxFnZK/jbIChSNTBI+GjHszwFLpx2nE1WZk0SswzAaGRowQXTNjdc8sg0R6TjHTBqfsD7QvxzezM/KHGDc5AZOg885+Sys7efi5fNRgdAZniVOQNGysvnWztNIei2rY//Z6aDWN3VMiKJvNbKaJ6VqOf2Z6nymbv6rMbD4A=,iv:emlUfH/c3xNtxeBrZV0ywGnBwcEQQeIbc2hmZWObSVo=,tag:HU6+ZN9/nUSa+v4wbqYuLQ==,type:str]
                display_name: authentik
                discovery: true
                issuer: https://auth.midnightthoughts.space/application/o/mastodon/
                scope: openid,profile,email
                uid_field: sub
                redirect_uri: https://mastodon.mtrnord.blog/auth/auth/openid_connect/callback
                assume_email_is_verified: true
        elasticsearch:
            enabled: true
            preset: single_node_cluster
        ingress:
            enabled: false
            annotations:
                cert-manager.io/cluster-issuer: letsencrypt-dns
                external-dns.alpha.kubernetes.io/hostname: mastodon.mtrnord.blog
            hosts:
                - host: mastodon.mtrnord.blog
                  paths:
                    - path: /
            tls:
                - hosts:
                    - mastodon.mtrnord.blog
                  secretName: mastodon.mtrnord.blog-tls
        mastodon:
            hooks:
                dbPrepare:
                    enabled: true
                dbMigrate:
                    enabled: true
            sidekiq:
                updateStrategy:
                    type: RollingUpdate
                    rollingUpdate:
                        maxSurge: 25%
                        maxUnavailable: 25%
                resources:
                    limits: {}
                    requests:
                        cpu: 136m
                        memory: 542Mi
            workers:
                - name: all-queues
                  concurrency: 25
                  replicas: 1
                  resources:
                    limits: {}
                    requests:
                        cpu: 136m
                        memory: 542Mi
                  queues:
                    - default,8
                    - push,6
                    - ingress,4
                    - mailers,2
                    - pull
                    # Make sure the scheduler queue only exists once and with a worker that has 1 replica.
                    - scheduler
            web:
                updateStrategy:
                    type: RollingUpdate
                    rollingUpdate:
                        maxSurge: 25%
                        maxUnavailable: 25%
                replicas: 2
                resources:
                    limits: {}
                    requests:
                        cpu: 180m
                        memory: 875Mi
            authorizedFetch: true
            local_domain: mtrnord.blog
            persistence:
                assets:
                    existingClaim: mastodon-assets-v2
                    accessMode: ReadWriteMany
                system:
                    existingClaim: mastodon-system-v2
                    accessMode: ReadWriteMany
            secrets:
                secret_key_base: ENC[AES256_GCM,data:jpNV+Nc/P2zoZQSAalQPRctEjMwCXGVjU1WV6SF1zAnvRyEa86AoWxtH693GYHApMqyC8Q7HGXK8hbDM6pIRyBEag6dT7mrfWqcp5Ziqz98WH8HWrdrzei2qTqKg2V8lNY55tEIDx1eu1PemD9wJ9NKhRni4URpjNrbT6GQeBDo=,iv:ucmYvHJWsyrjswkdJp+4x/DUgizJ/1Dp5iT7EQ+L8VI=,tag:AZG5UW/NSbxDFwqDOsEnWQ==,type:str]
                otp_secret: ENC[AES256_GCM,data:hGLsFggAlJypem+Sh/MCkM4NoH0Y8HL5gbiFkJlLNZ8AEKgBNK+fVHNpfYxrdLaoeod2V36gLkVycRYICXK/n+C6aQitnNjRGRs/azx9gnoJZITo9M+qjUZ9wFQL3c7YViGeLJ2YHTzivzOt8guiyloDg5jRZVFwlClm9Gu9giM=,iv:YLx4rb9wHq6QVWNcGjKOavzTzKCA+digsKxF2APOy8g=,tag:ZImb0g1Da9A5K+NzFCkw9w==,type:str]
                vapid:
                    private_key: ENC[AES256_GCM,data:OXaRC8aSGurETtpjrmrPwK0ZBPsr+oU4CaZByNclLpnsTlqGxO9Bsy3J07E=,iv:ZfsJBu/963cwTpyIdU2UgY2T6XPFn+Ryx2tNt+zUDt4=,tag:2FiCn7cMK1dqVqWLLJtfGQ==,type:str]
                    public_key: ENC[AES256_GCM,data:oUuut7bnH+7AxrzSZ4vGVZu16U06PDHyJS8UAWu1GPAjfrc6LpkMMNuQz1yKRG/8VNNbT+hFDSBVU/+stu+sDY0GiDX0IKFJeePWJbRdz+O0mBNdpQH/lQ==,iv:bHgFkhD5aHWs99shQFgy9vvLyuUYJ5Nn9Pf0FyERHZI=,tag:n1koOvTcJ2GW+rQu78i8Zw==,type:str]
                activeRecordEncryption:
                    primaryKey: ENC[AES256_GCM,data:vC+kpV5aYX1npOwNIuruxkuJv8TFM0jOPobK+5YEZWw99dnXIDeRaWnpNnmLU8YCZE9lq8ib9e2/FrqYYRve1g==,iv:CLh+K4KDBMG3ACYR1ztNvnc0iNpD5ni9wcplN7ir+1k=,tag:A315FsrbqtWC1QCwunpGCQ==,type:str]
                    deterministicKey: ENC[AES256_GCM,data:YQwRvsWmY129Tiv6UYqqYmq7qx53+0fbjmqjwZWCEuJyfyWMcQnLp0dtKXneYK4Zh4lDbRWT+VL7z48NGRWQgQ==,iv:YpSbxgj7aERlptwK60BD7N50nBHeA2qA3q4MbMOqgDE=,tag:GFbF2R7wNr+A1QRxmsJJew==,type:str]
                    keyDerivationSalt: ENC[AES256_GCM,data:YAD9Dm5TSQX0lzW2yjRmKCHgk+3ucsInMQe8W0ZXQvkWE3S/zgBHEdD4yXGMAdnStVHFjCCDaxWvbCJlFaCKag==,iv:wo8XW9+FTfCUmW6Vo0iUuOhNM5Q/nN+e09w7jur41Io=,tag:nE0D7ywwaHabBmqEnsJEfw==,type:str]
            singleUserMode: true
            smtp:
                domain: smtp.fastmail.com
                port: 465
                from_address: Mastodon <ops@nordgedanken.dev>
                reply_to: noreply@nordgedanken.dev
                server: smtp.fastmail.com
                login: mtrnord@nordgedanken.dev
                tls: true
                password: ENC[AES256_GCM,data:1h28fIuzL7Hayr/nz9zi2g==,iv:qB/kFExoeyiNetUjAk2wTBzbEaljZilw00mvwU8oJW8=,tag:frzft/WQwwRLtqJwRayEbg==,type:str]
            streaming:
                updateStrategy:
                    type: RollingUpdate
                    rollingUpdate:
                        maxSurge: 25%
                        maxUnavailable: 25%
                resources:
                    limits: {}
                    requests:
                        cpu: 41m
                        memory: 100Mi
                replicas: 2
                workers: 2
                sslMode: no-verify
                image:
                    repository: ghcr.io/mastodon/mastodon-streaming
                    tag: v4.4.1
            web_domain: mastodon.mtrnord.blog
            extraEnvVars:
                TRUSTED_PROXY_IP: 100.64.0.0/10
        postgresql:
            auth:
                database: mastodon
                username: mastodon
                password: ENC[AES256_GCM,data:amkcN94B3p0K4is89+NzMGHUFHU0cQfo//37SO0FciiERGwz7znc2kmXy5eoq9jsbi6EElR0fNhDfZPXJ8TZxw==,iv:BNQt27vme+qc3sfnhY/qkSBUyT0Nwh8my9McPIqvKn0=,tag:JNEWMzVKl5ht17ykGTkfYQ==,type:str]
            enabled: false
            postgresqlHostname: pg-cluster-v2-rw.postgres-cluster.svc.cluster.local
            #postgresqlReplicaHostname: main-ctrlc-repl.postgres.svc
        redis:
            master:
                persistence:
                    enabled: false
            replica:
                persistence:
                    enabled: false
            sentinel:
                persistence:
                    enabled: false
            enabled: true
            #hostname: keydb
            auth:
                password: ENC[AES256_GCM,data:OwL7bPX+l+bxwsszamhGILfkbdN4NREi+rP92/T6K2deSHas5BP0Bp/r5Te4LQz9EfITZNOCUwNLQ80KLCjtIA==,iv:B7hV1cvkQznNePDjEcUZytTo7c3Wxs7w2RNQW5ZLxJE=,tag:5oI2K7qE9saN9BfxX7g0Og==,type:str]
        replicaCount: 1
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSB6czRHR0t0TDZhMm9obGYz
            TTJTM3diVHVOd1dQaFJaTEdTZjBDQXdhelVJCmRzZXFlU2tleEI2QWh0cUxmYVRx
            R09SRkhwTUJLNHJvT0RDSDhFMXFvODgKLS0tIGkwUTNJOG9pVEhQdlAzOVRrU3BK
            UjhSeE8wRmhRb2VzTjFvOWhoSmErZFUKmQnkOBk+G2qFKjnCL/93z/NoGW8w6uR9
            87RFinyjlWoB+vNK10fOFX/514LaV3vw5bQ1ueZsKTs+cOEvCdwYcg==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2025-07-29T06:15:16Z"
    mac: ENC[AES256_GCM,data:gnMCM1WI7rKc6ItJ1iuNJNl6QE5WNu6GDViIbGp73U9UHbFUcTtgFl3ZIyy61PzD5y3lXUe59jQbMmBKmGciKOoXsPLvHMylMuBpOuXTTqkuUzJxChr5o8Zcf5Tf3ESP/JdnU33WhkOW3NvU0MjUbjcnIuG+Tl++GPXwlBD/NTM=,iv:5eSTKYbQ257SfWEOwGcHepQkXfjMico1IaK78Lmf1/o=,tag:i5uPCmRTkZ6WqZ+mK/5naQ==,type:str]
    pgp: []
    encrypted_regex: ^(GITHUB_CLIENT_ID|GITHUB_CLIENT_SECRET|GITHUB_PRIVATE_KEY|woosh|root_password|rspamd_password|pgdb_password|matrix_access_token|pgdb_remote_url|hmac_secret_key|adminPassword|adminEmail|jenkinsAdminEmail|securityRealm|gerrit.config|routing_key|DATABASE_URL|SMTP_PASSWORD|SECRET_KEY_BASE|admin_password|extraCommands|key|clickhouseDatabaseURL|databaseURL|client_id|client_secret|secret_key_base|otp_secret|private_key|public_key|primaryKey|deterministicKey|keyDerivationSalt|token|clientId|secretKey|installationId|installationKey|uriOverride|adminToken.value|password.value|sql_password|erlangCookie|AUTHENTICATION_PASSWORD|ROOM_API_SECRET_KEY|adminPassword|configPassword|adminUser|configUser|MAIL_PASSWORD|APP_KEY|api_key|api_secret|keys|livekit_key|livekit_secret|secret_key|admin_pass|admin_email|mariadbPassword|mariadbRootPassword|privateKey|data|stringData|PASSWD|password|pass|postgresPassword|postgresqlPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret|admin_token|integrationKey|rootPassword)$
    version: 3.9.1
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
    name: mastodon
    namespace: mastodon
spec:
    parentRefs:
        - name: envoy-gateway
          namespace: envoy-gateway
    hostnames:
        - mastodon.mtrnord.blog
    rules:
        - backendRefs:
            - name: mastodon-streaming
              port: 4000
          timeouts:
            request: 240s
            backendRequest: 0s
          matches:
            - path:
                type: PathPrefix
                value: /api/v1/streaming
        - backendRefs:
            - name: mastodon-web
              port: 3000
          timeouts:
            request: 240s
            backendRequest: 0s
          matches:
            - path:
                type: PathPrefix
                value: /
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSB6czRHR0t0TDZhMm9obGYz
            TTJTM3diVHVOd1dQaFJaTEdTZjBDQXdhelVJCmRzZXFlU2tleEI2QWh0cUxmYVRx
            R09SRkhwTUJLNHJvT0RDSDhFMXFvODgKLS0tIGkwUTNJOG9pVEhQdlAzOVRrU3BK
            UjhSeE8wRmhRb2VzTjFvOWhoSmErZFUKmQnkOBk+G2qFKjnCL/93z/NoGW8w6uR9
            87RFinyjlWoB+vNK10fOFX/514LaV3vw5bQ1ueZsKTs+cOEvCdwYcg==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2025-07-29T06:15:16Z"
    mac: ENC[AES256_GCM,data:gnMCM1WI7rKc6ItJ1iuNJNl6QE5WNu6GDViIbGp73U9UHbFUcTtgFl3ZIyy61PzD5y3lXUe59jQbMmBKmGciKOoXsPLvHMylMuBpOuXTTqkuUzJxChr5o8Zcf5Tf3ESP/JdnU33WhkOW3NvU0MjUbjcnIuG+Tl++GPXwlBD/NTM=,iv:5eSTKYbQ257SfWEOwGcHepQkXfjMico1IaK78Lmf1/o=,tag:i5uPCmRTkZ6WqZ+mK/5naQ==,type:str]
    pgp: []
    encrypted_regex: ^(GITHUB_CLIENT_ID|GITHUB_CLIENT_SECRET|GITHUB_PRIVATE_KEY|woosh|root_password|rspamd_password|pgdb_password|matrix_access_token|pgdb_remote_url|hmac_secret_key|adminPassword|adminEmail|jenkinsAdminEmail|securityRealm|gerrit.config|routing_key|DATABASE_URL|SMTP_PASSWORD|SECRET_KEY_BASE|admin_password|extraCommands|key|clickhouseDatabaseURL|databaseURL|client_id|client_secret|secret_key_base|otp_secret|private_key|public_key|primaryKey|deterministicKey|keyDerivationSalt|token|clientId|secretKey|installationId|installationKey|uriOverride|adminToken.value|password.value|sql_password|erlangCookie|AUTHENTICATION_PASSWORD|ROOM_API_SECRET_KEY|adminPassword|configPassword|adminUser|configUser|MAIL_PASSWORD|APP_KEY|api_key|api_secret|keys|livekit_key|livekit_secret|secret_key|admin_pass|admin_email|mariadbPassword|mariadbRootPassword|privateKey|data|stringData|PASSWD|password|pass|postgresPassword|postgresqlPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret|admin_token|integrationKey|rootPassword)$
    version: 3.9.1
