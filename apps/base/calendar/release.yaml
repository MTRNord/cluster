apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: radicale
    namespace: calendar
spec:
    interval: 5m
    chart:
        spec:
            chart: radicale
            sourceRef:
                kind: HelmRepository
                name: radicale
            interval: 60m
    install:
        crds: Create
    upgrade:
        crds: CreateReplace
        # Force recreation due to Helm not properly patching Deployment with e.g. added port,
        # causing spurious drift detection
        force: true
    values:
        env:
            # -- Set the container timezone
            TZ: Europe/Berlin
            # -- Set the location of the configuration file
            RADICALE_CONFIG: /config/config
        ingress:
            main:
                annotations:
                    cert-manager.io/cluster-issuer: letsencrypt-http
                    traefik.ingress.kubernetes.io/router.middlewares: calendar-subpath@kubernetescrd
                enabled: true
                hosts:
                    - host: midnightthoughts.space
                      paths:
                        - path: /dav
                          pathType: Prefix
                          service:
                            port: 5232
                      tls:
                        - secretName: midnightthoughts.space-tls
                          hosts:
                            - midnightthoughts.space
        configmap:
            config:
                # -- Define inline radicale configuration as a ConfigMap.
                enabled: true
                # -- Radicale configuration. See [image documentation](https://github.com/tomsquest/docker-radicale#custom-configuration) for more information.
                # @default -- See values.yaml
                data:
                    config.cfg: ENC[AES256_GCM,data:S52gG1B01z3ON3bC6j0SM9iXZ11LXvRthC9I9x+KCAo7e2bkHquczHlZfohk4IafxZmEef7hZbZa8+HzjyCaoOFgdwHgsEMJHq6lm+dZvm6Re4rsVJp/E55fcn8pV0gSC1t2Ka2rNzhd7Gh8mdJR5D4YCCY04qoZLGudk7gDi/LTpFfoWFVRTPvX+ypjkKu9Om7+ZhF0RXcetnzaSodvvYXyEkBG74ZTZO3FfCEyl8/rculAJMcp+2gzEoBY2q/1UGMLpV20QWMrX8u6uiHmCTmMcs7i7iL2v69Md0uh9HL8lxqYTbcsSaVvUTq+GM8paKElnXMGQ4DY+MaHdFIo3JsxeHK0V/5ExC7uF0UN6lpw5gRXftQA1dEQ1Jc5wx7z6T8yHrxg,iv:AMo/34KOwf0EppUTtX6391Dm0E3orpV9/iGLEDFNcfg=,tag:Ynph1PWmHK1P6Gf3UdbnZA==,type:str]
                    htpasswd: ENC[AES256_GCM,data:OPjAkq1yVadTdlvHVScANxtrNjVd5MAJZnUMPjgR0U/thnXnm3ocNMz8dRw9CdbJIHFk8RBcVNIE2VeKWW+/wl+kY1hC,iv:IVm2Bb52mtJkUSPKRgGoFi7rn5KzJAXuaLgMVwYlz/k=,tag:qjXsKcCPM3cZBrl7GfHalw==,type:str]
        persistence:
            data:
                enabled: ENC[AES256_GCM,data:5xdUYQ==,iv:Fx25cSv+iex4tF0Lw+a+XPPfNdVOlhYMw9ZV1tmemBw=,tag:gx0jYGD1lG21PzAD332IDA==,type:bool]
                storageClass: ENC[AES256_GCM,data:g6ZPCY1C8DpnRA==,iv:/8EQgJSV2h4vTFFVWABD4uV7tQ3sDHe8hEx0Mfd2LmE=,tag:jrvNs7Ue/a/6J2rpHKYxNQ==,type:str]
                accessMode: ENC[AES256_GCM,data:raiYqI4WMIm0K1thHA==,iv:3/qraamD0jCB6hp6cIt8bIbbjDflFYlaNbH7NhL+yiE=,tag:DQAdE3opioK73ByRWyCiTA==,type:str]
                size: ENC[AES256_GCM,data:/Jym,iv:yEhjltTClNf4GBBtWhVkh/vw2otBLYaKU3g8R0xFEg8=,tag:v2SDzhTmv0LsDHaTBR4knA==,type:str]
                volumeName: ENC[AES256_GCM,data:xQCkk14GK8T7Y1jsMI+SaRVwR7T/Yzq+A/fOTNJAcU6IvWYOSRp9TQ==,iv:Qz/d83JAArZFqP4jMhrWqhVNd+07tkVa+Z5Oma5KB8w=,tag:AmJTgR3Oeuv7tz/Sv9tSHA==,type:str]
            htpasswd:
                enabled: true
                type: configMap
                name: '{{ printf "%v-config" (include "common.names.fullname" .) }}'
                subPath: htpasswd
                mountPath: /config/htpasswd
                readOnly: true
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBVdzlwZjNJVUhmVG40T0pS
            eGJPTnNkNEx6TWxvRlQwVksyWWJLVjlpVWw4Cm82b0RMb1VJdUNWN2FEMm5TSENG
            akExb1paS3Z6Tyt4L3V4dXo0d3lkQ28KLS0tIHpNZVEwYUZ3a1VwVUtoRW52clZk
            YVJmUjgvb2FwUmRIUTR0LzJoTVNPdmcKzWAyDhDkpKR/j41pmevAWb6KuNuXN0n1
            fkc0cWbguHRhBvGuhWQ+ywdFbFqTpJighhynUlEbAxH927paHGaNwg==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-02-19T14:15:40Z"
    mac: ENC[AES256_GCM,data:nMz21HBr7b0gXGylcIEZn9Wsq8DpPLts3akMyHdlaC+z8PhUzE3HflGXTMwpW1AjpECna6ENyMKHfuZPmiJvzxEcOZLgF/QfXpVGhTvk6jvcJA9N6v0jHu8xq1DcbmS2SrHHExhQgGuHjk/cF8dIteFh17znJkbP4f7MniRcnXU=,iv:64nLLOXaFb9C89V7+ZR+c6emxyol2XqJrfIYNsXqMb8=,tag:rj7cc98dFhplUmTZ8Fc51A==,type:str]
    pgp: []
    encrypted_regex: ^(secret_key|adminPassword|admin_pass|admin_email|mariadbPassword|mariadbRootPassword|privateKey|data|stringData|PASSWD|password|pass|postgresPassword|postgresqlPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret)$
    version: 3.8.1
