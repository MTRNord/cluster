apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: radicale
    namespace: calendar
spec:
    interval: 5m
    chart:
        spec:
            chart: radicale
            sourceRef:
                kind: HelmRepository
                name: radicale
            interval: 60m
    install:
        crds: Create
    upgrade:
        crds: CreateReplace
        # Force recreation due to Helm not properly patching Deployment with e.g. added port,
        # causing spurious drift detection
        force: true
    values:
        env:
            # -- Set the container timezone
            TZ: Europe/Berlin
            # -- Set the location of the configuration file
            RADICALE_CONFIG: /config/config
        ingress:
            main:
                annotations:
                    cert-manager.io/cluster-issuer: letsencrypt-http
                    traefik.ingress.kubernetes.io/router.middlewares: calendar-subpath@kubernetescrd
                enabled: true
                hosts:
                    - host: midnightthoughts.space
                      paths:
                        - path: /dav
                          pathType: Prefix
                          service:
                            port: 5232
                      tls:
                        - secretName: midnightthoughts.space-tls
                          hosts:
                            - midnightthoughts.space
        configmap:
            config:
                # -- Define inline radicale configuration as a ConfigMap.
                enabled: true
                # -- Radicale configuration. See [image documentation](https://github.com/tomsquest/docker-radicale#custom-configuration) for more information.
                # @default -- See values.yaml
                data:
                    config.cfg: ENC[AES256_GCM,data:tTGf/j/0+VYXFA8vhcsKFgbXMLVlNVxYLa4LeZ8Mv+pfSFV2IUCbVLwi74kq5nre7PZV07zMx6EEerdpgqkj3OAewB3Cbhoj1c/hXjjCGnxOy3wHzWIzqHgdWaQhVDjRCK/9InByIa8QimlJ+kFrqDDLR1sUsBvXGhSCXen5vHM1F7QP9AC0ojq7LfWT6H6E4gv16W5PRsS7VToAvaKCL8f+j7ZpS515NWKijgNK0FY7vkwX4SRZMiGDa7j6MQTX9fWIfG1P1AjBYLvfwRWAK6erPAUt8G4IjWaeqmwl0l4AS1v8yArQuOkULIOGusbewBmV78sGAJ0XySedkWp9AaqO8SmCoNCv2H4bTluuxJANA/zyv11ILjm9cayVJrePMAbysov8,iv:Qjk0vRwS0qK5hMhbQQSobY9zvVQmbuqcwRb5tC7QWls=,tag:5vHdl11iGVIx6jdz6SlQ9A==,type:str]
                    htpasswd: ENC[AES256_GCM,data:RdGCcRm8x2qDFe4vj2lf470Py88ox5hj5Dy4DzUISW+/rpCs9xrwNJUdvWcjR83XvSxDiC8pyBrMT5DUmFQXE0aTRU44,iv:3xCsi5JQU8G7FAGrHHPi5NtN0jjWNe9gL+SJuBUp8+o=,tag:OHcxmEd3bnISqSbBrw6H9Q==,type:str]
        persistence:
            data:
                enabled: ENC[AES256_GCM,data:p5wIrw==,iv:88hBOY8xcrZF7Qu0dtNnN3B0cAoREihPP984a4HyCSI=,tag:LJyKY6rpNb1vxpcdVZB4mA==,type:bool]
                storageClass: ENC[AES256_GCM,data:fins7X3UKOxM7g==,iv:EDAq2fxjgFPtdIXo7BULW985GBbXsQm07WG8rB1wRgA=,tag:+X6g4iD9inzTReoIDgTGUA==,type:str]
                accessMode: ENC[AES256_GCM,data:X28p+LcOXOgq6v1NpQ==,iv:l8GcQx7RbduLJeANi+d8jo8jedK8gmgwxFWQDXyO9Fs=,tag:HzxSUnyL8Kyl2GLxxTqa3A==,type:str]
                size: ENC[AES256_GCM,data:FgGs,iv:r5vB/PShPUJP5wKJOG2KInrhLsG7yVeoCHKA8UC5V7Q=,tag:oWRgzh1QDPCch/Shdb2x7A==,type:str]
            htpasswd:
                enabled: true
                type: configMap
                name: '{{ printf "%v-config" (include "common.names.fullname" .) }}'
                subPath: htpasswd
                mountPath: /config/htpasswd
                readOnly: true
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBXaUJ0aC9UL2paZkJkM2tw
            Y3ZxT2xDVW9wK0dheFJtZEs5VWE4Z2FTTlFnCk9xVk5hUFdFOFpQRFhsaEh0K0tL
            TUNKZTV2b2g5aHNhcDFncG1wOXFXZWMKLS0tIElZYzEvdXE1cHdwRjl5dU5Sa0No
            VDFwMTNBWUhXVVNvTW9DcUR5OHp6QWsK0FlaGzCt9nnoEEgK9/Cn2KQSjwHqrnHZ
            UrZmxBIATDH3ZG7o+m88o2V5ZA96mZigXqNANpoNd72dLyGDeFddeg==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-02-19T14:05:38Z"
    mac: ENC[AES256_GCM,data:ksQ14VqJWWYDv95JCd8oMPS1O4l4liOBdWewQZ/bN0X718y6zuHGv3xJ/Ny6GjoFLxG16CN1t745sew5O+gRMSH2G5+KROxOpY4xIgCDdfvTxfLa3SVnV8p1kbTQq0DrqRSb+QJccsuCtXYGSiIHY+tcFw7XigTqtoiURWepwWw=,iv:8Q+tYtsjcgpjt2mVSxAK90MNbr4V0C3asdNNtNey2cs=,tag:eBWDVCa4QTrl6DHsasHYVw==,type:str]
    pgp: []
    encrypted_regex: ^(secret_key|adminPassword|admin_pass|admin_email|mariadbPassword|mariadbRootPassword|privateKey|data|stringData|PASSWD|password|pass|postgresPassword|postgresqlPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret)$
    version: 3.8.1
