apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: envoy-gateway
    namespace: envoy-gateway
spec:
    releaseName: envoy-gateway
    interval: 60m
    chartRef:
        kind: OCIRepository
        name: envoy-gateway
    values:
        podDisruptionBudget:
            minAvailable: 1
        deployment:
            replicas: 3
---
apiVersion: gateway.networking.k8s.io/v1beta1
kind: GatewayClass
metadata:
    name: envoy-gateway-class
    namespace: envoy-gateway
spec:
    controllerName: gateway.envoyproxy.io/gatewayclass-controller
# TODO: Set up https://gateway.envoyproxy.io/docs/tasks/security/tls-cert-manager/#creating-a-tls-gateway-listener with https://github.com/hetznercloud/hcloud-cloud-controller-manager/issues/814
---
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
    name: envoy-gateway
    namespace: envoy-gateway
    annotations:
        cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
    gatewayClassName: envoy-gateway-class
    listeners:
        - name: http
          protocol: HTTP
          port: 80
          allowedRoutes:
              namespaces:
                  from: "All"
        - name: https
          protocol: HTTPS
          port: 443
          allowedRoutes:
              namespaces:
                  from: "All"
          tls:
              mode: Terminate
              certificateRefs:
                  - kind: Secret
                    name: envoy-gateway-tls
