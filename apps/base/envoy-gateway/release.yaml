apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: envoy-gateway
    namespace: envoy-gateway
spec:
    releaseName: envoy-gateway
    interval: 60m
    chartRef:
        kind: OCIRepository
        name: envoy-gateway
    values:
        podDisruptionBudget:
            minAvailable: 1
        deployment:
            replicas: 3
---
apiVersion: gateway.networking.k8s.io/v1beta1
kind: GatewayClass
metadata:
    name: envoy-gateway-class
    namespace: envoy-gateway
spec:
    controllerName: gateway.envoyproxy.io/gatewayclass-controller
---
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
    name: envoy-gateway
    namespace: envoy-gateway
    annotations:
        cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
    gatewayClassName: envoy-gateway-class
    infrastructure:
        annotations:
            external-dns.alpha.kubernetes.io/access: public
            load-balancer.hetzner.cloud/location: hel1
            load-balancer.hetzner.cloud/name: envoy
            load-balancer.hetzner.cloud/use-private-ip: "true"
            load-balancer.hetzner.cloud/uses-proxyprotocol: "true"
    listeners:
        - name: http
          protocol: HTTP
          port: 80
          allowedRoutes:
              namespaces:
                  from: "All"
        - name: https
          protocol: HTTPS
          port: 443
          allowedRoutes:
              namespaces:
                  from: "All"
          tls:
              mode: Terminate
              certificateRefs:
                  - kind: Secret
                    name: envoy-gateway-tls
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: ClientTrafficPolicy
metadata:
    name: enable-proxy-protocol-policy
    namespace: envoy-gateway
spec:
    targetRef:
        group: gateway.networking.k8s.io
        kind: Gateway
        name: envoy-gateway
    enableProxyProtocol: true
