apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: zammad
    namespace: zammad
spec:
    interval: 5m
    chart:
        spec:
            version: 9.0.x
            chart: zammad
            sourceRef:
                kind: HelmRepository
                name: zammad
            interval: 60m
    install:
        crds: Create
        timeout: 25m
    upgrade:
        timeout: 25m
        crds: CreateReplace
        # Force recreation due to Helm not properly patching Deployment with e.g. added port,
        # causing spurious drift detection
        force: true
    values:
        ingress:
            enabled: true
            annotations:
                cert-manager.io/cluster-issuer: letsencrypt-http
            hosts:
                - host: zammad.midnightthoughts.space
                  paths:
                    - path: /
                      pathType: ImplementationSpecific
            tls:
                - secretName: zammad.midnightthoughts.space-tls
                  hosts:
                    - zammad.midnightthoughts.space
        secrets:
            postgresql:
                useExisting: true
                secretName: zammad-postgres
        zammadConfig:
            redis:
                pass: ENC[AES256_GCM,data:B/NdV0G0jNjWSlBtaMalnreznuf8iN23uhpfraEgc8lzqOmQOidKYh/8L9t32dF4F6LFNBe9FIEiRoxycODnmA==,iv:Jw5QfFOZ6GWqYhpXWBxbWgljui0OjaC8YRuzXRV2gTg=,tag:jFXf9GS5GKUAX5WiZaB9Yg==,type:str]
            postgresql:
                enabled: false
                db: zammad
                host: matrix-postgres-cluster.matrix-postgres-cluster.svc.cluster.local
        persistence:
            enabled: true
            storageClass: nfs-csi
            existingClaim: zammad-data-csi
        elasticsearch:
            master:
                ## Configure extra options for Elasticsearch master-elegible containers' liveness, readiness and startup probes
                ## ref: https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/#configure-probes
                ## @param master.startupProbe.enabled Enable/disable the startup probe (master nodes pod)
                ## @param master.startupProbe.initialDelaySeconds Delay before startup probe is initiated (master nodes pod)
                ## @param master.startupProbe.periodSeconds How often to perform the probe (master nodes pod)
                ## @param master.startupProbe.timeoutSeconds When the probe times out (master nodes pod)
                ## @param master.startupProbe.successThreshold Minimum consecutive successes for the probe to be considered successful after having failed (master nodes pod)
                ## @param master.startupProbe.failureThreshold Minimum consecutive failures for the probe to be considered failed after having succeeded
                ##
                startupProbe:
                    enabled: false
                    initialDelaySeconds: 90
                    periodSeconds: 10
                    timeoutSeconds: 5
                    successThreshold: 1
                    failureThreshold: 5
                ## @param master.livenessProbe.enabled Enable/disable the liveness probe (master-eligible nodes pod)
                ## @param master.livenessProbe.initialDelaySeconds Delay before liveness probe is initiated (master-eligible nodes pod)
                ## @param master.livenessProbe.periodSeconds How often to perform the probe (master-eligible nodes pod)
                ## @param master.livenessProbe.timeoutSeconds When the probe times out (master-eligible nodes pod)
                ## @param master.livenessProbe.successThreshold Minimum consecutive successes for the probe to be considered successful after having failed (master-eligible nodes pod)
                ## @param master.livenessProbe.failureThreshold Minimum consecutive failures for the probe to be considered failed after having succeeded
                ##
                livenessProbe:
                    enabled: true
                    initialDelaySeconds: 270
                    periodSeconds: 10
                    timeoutSeconds: 5
                    successThreshold: 1
                    failureThreshold: 5
                ## @param master.readinessProbe.enabled Enable/disable the readiness probe (master-eligible nodes pod)
                ## @param master.readinessProbe.initialDelaySeconds Delay before readiness probe is initiated (master-eligible nodes pod)
                ## @param master.readinessProbe.periodSeconds How often to perform the probe (master-eligible nodes pod)
                ## @param master.readinessProbe.timeoutSeconds When the probe times out (master-eligible nodes pod)
                ## @param master.readinessProbe.successThreshold Minimum consecutive successes for the probe to be considered successful after having failed (master-eligible nodes pod)
                ## @param master.readinessProbe.failureThreshold Minimum consecutive failures for the probe to be considered failed after having succeeded
                ##
                readinessProbe:
                    enabled: true
                    initialDelaySeconds: 180
                    periodSeconds: 25
                    timeoutSeconds: 5
                    successThreshold: 1
                    failureThreshold: 50
                    # tolerations:
                    #     - key: arch
                    #       operator: Equal
                    #       value: arm64
                    #       effect: NoSchedule
        redis:
            auth:
                password: ENC[AES256_GCM,data:4nNZeqdqX00o+vvxBphpyWLBrJZ1bwU1kIjvySViVppbKouUZdYWLmKoDeGieXJ83Vnz8JV7FCFExiQAglLg0A==,iv:3HYo5GJ7Q5jd2Vv1X2LqW1dreETTIqZPR5sI4Kq+AV4=,tag:4zqh4lfEBwhLwRU+IhJzrA==,type:str]
            persistence:
                storageClass: nfs-csi
                existingClaim: redis-zammad-csi
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBpQ0dPNHl4dU9PWE0vWnhw
            cFdyRWw0MWhLWEpqdU1JVzAyZ3pNaWpDdVMwCmNCbFROTmtoZXl0R2tLcm5rT0J2
            ZnpHbTk1eEJaVXdjeDgzLzI2am41c2MKLS0tIHdTZHkyM0xueXVIS09LcFBZOFBh
            QVdUTjh3OXBzMU5QYVljNDZnV2dlZ1UK2Iuwe2vZGtDDcWyDy0ADHWtXL3lGLRol
            d/j89WYVdXCdyUk6T3Xr+O9qB0EJgBAQnRU3qhWjbcwVbEOlgjNh7A==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-01-24T15:31:07Z"
    mac: ENC[AES256_GCM,data:qH8EvzMXBXQ2J/hQvbTPbTG7534ewqUc2pzw5C/ck00lxqKSlVsojaqLRdtmUJsCTlFrsn64EQzv7wbnvpAk4qCWHaV1eOYyOtwoGS2QBjdaQtm+QS1eRIB7K+mJvzUpzt5AFi+xg7wfsZglB9Fez4NYOozEEHy5LGAdKB4vD7k=,iv:tlLl3B8yAZio7DpXGxcCphmq9l6Xuxogduz6Mgmqv34=,tag:zv3ZGs7yhEmcSmHvl84a1w==,type:str]
    pgp: []
    encrypted_regex: ^(admin_pass|admin_email|mariadbPassword|mariadbRootPassword|privateKey|data|stringData|PASSWD|password|pass|postgresPassword|postgresqlPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret)$
    version: 3.8.1
