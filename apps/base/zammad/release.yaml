apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: zammad
    namespace: zammad
spec:
    interval: 5m
    chart:
        spec:
            version: 9.0.x
            chart: zammad
            sourceRef:
                kind: HelmRepository
                name: zammad
            interval: 60m
    install:
        crds: Create
    upgrade:
        crds: CreateReplace
        # Force recreation due to Helm not properly patching Deployment with e.g. added port,
        # causing spurious drift detection
        force: true
    values:
        ingress:
            enabled: true
            annotations:
                cert-manager.io/cluster-issuer: letsencrypt-dns
            hosts:
                - host: zammad.midnightthoughts.space
                  paths:
                    - path: /
                      pathType: ImplementationSpecific
            tls:
                - secretName: zammad.midnightthoughts.space-tls
                  hosts:
                    - zammad.midnightthoughts.space
        secrets:
            postgresql:
                useExisting: true
                secretName: zammad-postgres
        zammadConfig:
            redis:
                pass: ENC[AES256_GCM,data:iohvrJLYIs7dJPs3dxFbWdbJwkWHjX42u7zYIVSfaH6Td0NYpECciJe5VyrEtkA51Y+Z2PI3xvkCvH4IwTtmmg==,iv:co94nhcQcWRrmzWtPqUMsPAa2DiwsCcFQg6i3jnFga0=,tag:qwq9W63oWaQyLgfsdhzZrQ==,type:str]
            postgresql:
                enabled: false
                host: matrix-postgres-cluster.matrix-postgres-cluster.svc.cluster.local
        persistence:
            enabled: true
            storageClass: rook-main-fs
            accessModes:
                - ReadWriteMany
        elasticsearch:
            master:
                tolerations:
                    - key: arch
                      operator: Equal
                      value: arm64
                      effect: NoSchedule
            data:
                tolerations:
                    - key: ENC[AES256_GCM,data:jJShsw==,iv:r0ixuhzxo0JH1BSgA1uHurXq7V7RuWV+NlUzeNxEYbM=,tag:AJEG9mwNpU2RFvweSJdqZA==,type:str]
                      operator: ENC[AES256_GCM,data:7asiFbo=,iv:jav1qbEjmHPLwmSTs85VG1Ub8ZYrZTVrw0GbeA6Z1iE=,tag:u8tdyOlrYG58d9ozMPh/5w==,type:str]
                      value: ENC[AES256_GCM,data:c3QrMiA=,iv:jkdbX14Y+yavgzvExElMrQB+T7sGiF0bNks9inVYcr8=,tag:/bdTwhW6rdlKsRf7phmg/w==,type:str]
                      effect: ENC[AES256_GCM,data:Y1bm4bsFlNX34g==,iv:hBASstbjVoYP55t/tkCwcvYgLZp0TDcbsykNubw84gI=,tag:2BUCmyGNOHHUTRjYoLaD0g==,type:str]
            coordinating:
                tolerations:
                    - key: arch
                      operator: Equal
                      value: arm64
                      effect: NoSchedule
            ingest:
                tolerations:
                    - key: arch
                      operator: Equal
                      value: arm64
                      effect: NoSchedule
            metrics:
                tolerations:
                    - key: arch
                      operator: Equal
                      value: arm64
                      effect: NoSchedule
        memcached:
            tolerations:
                - key: arch
                  operator: Equal
                  value: arm64
                  effect: NoSchedule
        redis:
            auth:
                password: ENC[AES256_GCM,data:/8qZnAAvXJq/Ei00z1en5qEhlZY3/IxRXh/CNg9iFqGY6er3BSHv2/32+emlrr+7BOLwI4BO3d40TqY0fqlSqQ==,iv:eDED6ayABPBAYuzeIgHQ78nHgvh27vEX49ConH8oH3o=,tag:zp9txsobXwvgXDbawV6P3g==,type:str]
            master:
                tolerations:
                    - key: arch
                      operator: Equal
                      value: arm64
                      effect: NoSchedule
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBpbkZuMHp1U0NwZmdUVlRR
            aGdjZlA3UlRsYVRFeHJQNEpVL3RvSU4wT0JjCkUyTDNycmhqaU9ncXZzYnh1bU5Z
            MkFQdlFxVG84SWpISUg5SFpySHFRaWcKLS0tIGIwSmxWSldibHlxYXRONEVnOXZW
            ZGtHd0s2aFFoUGRxYWJYUWpmUTVveGcKFOSLyS8u0mpxN/3pDHQss6k5pzIo5MYu
            X/fx1PEivzEEdqrqEyx0HjwpH24nYcgPkDa/QmmoBRD4tHOrjdfKXQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2023-06-25T12:10:49Z"
    mac: ENC[AES256_GCM,data:3G17yyDq/vpl9gtOZhMTUHj5aT9TQgGfFwNYmXcyh9o6tY9zJVxWvMS6sIZDHPx6ZTqvJKZS+fvM7MoDBB9p0x9MdVThlV4RN03NE5/1eIvepSKyZJ55l4gDzqelGIO4+hklXWYPazPPB1rPW9Hda88a+X19KPdYZ21OOGiKRvs=,iv:0USlxPIm5s08jy24tSmoHB3npW5qiiz4wbi8QFBz2VQ=,tag:masy5oiE6HQhx8tmocyEmA==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData|password|pass|postgresPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret)$
    version: 3.7.3
