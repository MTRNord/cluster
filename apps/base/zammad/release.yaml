apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: zammad
    namespace: zammad
spec:
    interval: 5m
    chart:
        spec:
            version: 10.x.x
            chart: zammad
            sourceRef:
                kind: HelmRepository
                name: zammad
            interval: 60m
    install:
        crds: Create
        timeout: 25m
    upgrade:
        timeout: 25m
        crds: CreateReplace
        # Force recreation due to Helm not properly patching Deployment with e.g. added port,
        # causing spurious drift detection
        force: true
    values:
        tolerations:
            - key: arch
              operator: Equal
              value: arm64
              effect: NoSchedule
        ingress:
            enabled: true
            annotations:
                cert-manager.io/cluster-issuer: letsencrypt-http
            hosts:
                - host: zammad.midnightthoughts.space
                  paths:
                    - path: /
                      pathType: ImplementationSpecific
            tls:
                - secretName: zammad.midnightthoughts.space-tls
                  hosts:
                    - zammad.midnightthoughts.space
        secrets:
            postgresql:
                useExisting: true
                secretName: zammad-postgres
        zammadConfig:
            redis:
                pass: ENC[AES256_GCM,data:wOagO+0SH5Ox9Pe+MqDP8WDzSsx54mjm9C7QwgxSzJCJPxaFp6ETik/VPzr7fqQhgGbrsFrpXYDUt4bqey5XoA==,iv:v8rnwk26DXwm0IwvRrujBNLofXSYb6mn5nLAdsoVfEU=,tag:dLRM1iQd6N9QB9M8n7voHQ==,type:str]
            postgresql:
                enabled: false
                db: zammad
                host: matrix-postgres-cluster.matrix-postgres-cluster.svc.cluster.local
            tmpDirVolume:
                emptyDir:
                    sizeLimit: 100Mi
                    medium: Memory
        persistence:
            enabled: true
            storageClass: nfs-csi
            existingClaim: zammad-data-csi
        elasticsearch:
            image:
                debug: true
            clusterName: zammad
            coordinating:
                replicaCount: 0
            data:
                replicaCount: ENC[AES256_GCM,data:XA==,iv:Hbw/CejCpRX2itml8Mm8puMts+1iH6ZAgx8LTX6MN3g=,tag:7J8xuU6ltU4W6r0fQBwtfg==,type:int]
            ingest:
                replicaCount: 0
            master:
                heapSize: 512m
                masterOnly: false
                replicaCount: 1
                extraEnvVars:
                    ELASTICSEARCH_ADVERTISED_HOSTNAME: zammad-elasticsearch.zammad.svc.cluster.local
                tolerations:
                    - key: arch
                      operator: Equal
                      value: arm64
                      effect: NoSchedule
            metrics:
                enabled: true
        redis:
            auth:
                password: ENC[AES256_GCM,data:pPi0soyYy7JyHNvlQ+vTrjvOikpI/BlMSVAd/dbexg7MN36iHC1mF0J6tEzCxbO1FevNLupObJjzc3ttkGrRcA==,iv:OuIicR0fp1iUOhUuAuCWHA6MFf5NvCK/yY4kLuALt88=,tag:dbxgioEWrgg0G5pMo5xY8w==,type:str]
            persistence:
                storageClass: nfs-csi
                existingClaim: redis-zammad-csi
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBScWZqbFFwRG5XMXpibjlr
            MlVKaFIrNzJiUEhUMEVhejB5azh1RTRkakV3CnZXNDhVVG5uUXZBKzRtbmpwcFB3
            Rm95bER2UVdhSDRwRUJtY0llb1Y4Rm8KLS0tIHhheis4N0hNVUVXbDh6NVFUVUZx
            OUNmL3NUZGp1RmJTUUpScndpUlBsZmsKn4ycyU4Kv6qcDJ52pTS6YTlxdi57Fcd1
            r2LQwMUQjudM3AZhDXGsln02qEF22LdDd/QTpLgBkRru6YiqEw1boA==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-02-26T12:37:11Z"
    mac: ENC[AES256_GCM,data:wwLHTc33wG2pV3CVf67BeKTipW3FmZgZdte8Oa5APTh4boFjIFfV4BUeq7RLlSLYj2FeWmOyZXDGQlyyLGM6rz9tELNqqoRsPmGMFRVKDVGRryiTd358LDCKBmu7MRwzfkqBgvkOwXpte0IGd8SKskAKVgc9oSW5MIFvTxfZpGA=,iv:A3Levtk0DYiZLtaxJbeXjUXwsPBpZaDodZ4Xh4r/ltM=,tag:4SxfavqI09JdRCTdL26BCQ==,type:str]
    pgp: []
    encrypted_regex: ^(secret_key|adminPassword|admin_pass|admin_email|mariadbPassword|mariadbRootPassword|privateKey|data|stringData|PASSWD|password|pass|postgresPassword|postgresqlPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret)$
    version: 3.8.1
