apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: zammad
    namespace: zammad
spec:
    interval: 5m
    chart:
        spec:
            version: 9.0.x
            chart: zammad
            sourceRef:
                kind: HelmRepository
                name: zammad
            interval: 60m
    install:
        crds: Create
    upgrade:
        crds: CreateReplace
        # Force recreation due to Helm not properly patching Deployment with e.g. added port,
        # causing spurious drift detection
        force: true
    values:
        ingress:
            enabled: true
            annotations:
                cert-manager.io/cluster-issuer: letsencrypt-http
            hosts:
                - host: zammad.midnightthoughts.space
                  paths:
                    - path: /
                      pathType: ImplementationSpecific
            tls:
                - secretName: zammad.midnightthoughts.space-tls
                  hosts:
                    - zammad.midnightthoughts.space
        secrets:
            postgresql:
                useExisting: true
                secretName: zammad-postgres
        zammadConfig:
            redis:
                pass: ENC[AES256_GCM,data:Xv5SEbF3P04h2brNzWF8Pq22RncfR1mcWlrN2hBkjYYPwI09ToErbAYtNBak345c4l/mnj8X905ShYAJSFwzaA==,iv:HdNGal/VFx9QDghRrIcdAhWfmyHqPERFj7kyvjPnzF4=,tag:LslCEKRBApf+urbIs+2v7A==,type:str]
            postgresql:
                enabled: false
                db: zammad
                host: matrix-postgres-cluster.matrix-postgres-cluster.svc.cluster.local
        persistence:
            enabled: true
            storageClass: nfs-client
            accessModes:
                - ReadWriteMany
            existingClaim: zammad-var-zammad-0-nfs-temp
        #elasticsearch:
        #    master: null
        #tolerations:
        #    - key: arch
        #      operator: Equal
        #      value: arm64
        #      effect: NoSchedule
        #    data:
        #tolerations:
        #    - key: arch
        #      operator: Equal
        #      value: arm64
        #      effect: NoSchedule
        #    coordinating:
        #tolerations:
        #    - key: arch
        #      operator: Equal
        #      value: arm64
        #      effect: NoSchedule
        #    ingest:
        #tolerations:
        #    - key: arch
        #      operator: Equal
        #      value: arm64
        #      effect: NoSchedule
        #metrics:
        #tolerations:
        #    - key: arch
        #      operator: Equal
        #      value: arm64
        #      effect: NoSchedule
        # memcached:
        #     tolerations:
        #         - key: arch
        #           operator: Equal
        #           value: arm64
        #           effect: NoSchedule
        redis:
            auth:
                password: ENC[AES256_GCM,data:j7bUIwZKTrvrLherAO7g9U0F4ur9pbZQY5Jm/XlBfM1mVH+GuQGd3kKxVvdOV8P878yf6F+AB4Q+ZFo4L/MOFw==,iv:Eom00lKbSqPVDJA80SnkmoaAgTcpCKHUvqOwQnfSYg8=,tag:0CizVY5q40GOWpH5pNENFQ==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBDSXJ6bmhrYVFaOEs0Nm1E
            T3cwS2t1QUovY0lkek9YZ1hZNGwxY003T2owCkx4UDhtYTkrZUdLWENZSnJ6emI3
            NjlhMGZ0UnJieml4VExuY0M2QkltM3MKLS0tIEpXTStwSTBTdDlTaG5SdmxRdExH
            emJ6U2U3TGd0SGZ5UUZ6MCtFNWxIeFEKbhPIMkwpejFGoI2YHIqTamm35jrNG+FA
            aRx/XJm6MxnmsKnccKikqLRNEeiBlZqDy5eOvh+kJ3xJF9d1zasGxA==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2023-07-18T13:31:51Z"
    mac: ENC[AES256_GCM,data:DoFIGIc+7r++4gIG9rM3Joribxx0OMdozR0sZELPhcU+GEHakPKQXdwhZYO3fWKPDA+sEXSpWJTJDJyA3eHN6sKKdj03O26g81g/rU2O19WGzP0xELvdZkMzgK1/SWKSu4G7gJDYqwywoFrnIyZJJPOyXkuZFMw1F5cp+jb9nus=,iv:lilVzKyt5VCrU9UEbKRtAjwkm+lHXjoKGuCsqf/a5DU=,tag:reVHd+sLriqjIhSM1zP6HQ==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData|password|pass|postgresPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret)$
    version: 3.7.3
