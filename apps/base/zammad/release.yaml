apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: zammad
    namespace: zammad
spec:
    interval: 5m
    chart:
        spec:
            version: 9.0.x
            chart: zammad
            sourceRef:
                kind: HelmRepository
                name: zammad
            interval: 60m
    install:
        crds: Create
    upgrade:
        crds: CreateReplace
        # Force recreation due to Helm not properly patching Deployment with e.g. added port,
        # causing spurious drift detection
        force: true
    values:
        ingress:
            enabled: true
            annotations:
                cert-manager.io/cluster-issuer: letsencrypt-dns
            hosts:
                - host: zammad.midnightthoughts.space
                  paths:
                    - path: /
                      pathType: ImplementationSpecific
            tls:
                - secretName: zammad.midnightthoughts.space-tls
                  hosts:
                    - zammad.midnightthoughts.space
        secrets:
            postgresql:
                useExisting: true
                secretName: zammad-postgres
        zammadConfig:
            redis:
                pass: ENC[AES256_GCM,data:pCwYE6tv296ShrCy3ZMcSmwjJxsvwCusxdVmzNKmkmL8QvJHqu3pGY5tCQTmrf47I1PciU2rwMM0zDkaRB1dqg==,iv:T5mMSiRdOgtV7H3gx58r1Dtwlrqmkg04WVe5JIdM2Fs=,tag:HVuBFtnIkih71Rv179i7kw==,type:str]
            postgresql:
                enabled: false
                db: zammad
                host: matrix-postgres-cluster.matrix-postgres-cluster.svc.cluster.local
        persistence:
            enabled: true
            storageClass: nfs-client
            accessModes:
                - ReadWriteMany
        #elasticsearch:
        #    master: null
        #tolerations:
        #    - key: arch
        #      operator: Equal
        #      value: arm64
        #      effect: NoSchedule
        #    data:
        #tolerations:
        #    - key: arch
        #      operator: Equal
        #      value: arm64
        #      effect: NoSchedule
        #    coordinating:
        #tolerations:
        #    - key: arch
        #      operator: Equal
        #      value: arm64
        #      effect: NoSchedule
        #    ingest:
        #tolerations:
        #    - key: arch
        #      operator: Equal
        #      value: arm64
        #      effect: NoSchedule
        #metrics:
        #tolerations:
        #    - key: arch
        #      operator: Equal
        #      value: arm64
        #      effect: NoSchedule
        # memcached:
        #     tolerations:
        #         - key: arch
        #           operator: Equal
        #           value: arm64
        #           effect: NoSchedule
        redis:
            auth:
                password: ENC[AES256_GCM,data:4y3NybYHd5IZhlL4VEzzLfg0h2gIOc21qaaXKpS0aJXCnTJ9ZUkhBtDNXSrejiE+6bgfQ9/VEahovCmUFP+dAA==,iv:Pp8OFWfhrFuKweDp00AY7hKpEKvEnv62MT529NQUcyQ=,tag:syfjkh7Dc/qUaeORR7jGlQ==,type:str]
sops:
# master:
#     tolerations:
#         - key: arch
#           operator: Equal
#           value: arm64
#           effect: NoSchedule
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBIYnA3Z0tocHg4QTRYTFR5
            WUwrMnJVNEFqb0play9UNTNNNG5xdjh0SGpzCm1yUFhSbjZiZTBvcENkWG1vcjl5
            QTBTM3M2OUE1VGRGbWpNOEcvTEZMTFUKLS0tIHpLcUJkQnZybktOTE1VekYxRzUv
            Mk1yYkkyc2IzVlVlWEMzZFNZazV1NWcKjOSnHSIjL/7inEFBqLTUeOTNvozkNsde
            483uHgjNUZZ9FWnP34UyBy93Cc0383V9U1muUe7EjKGv3XHipKNT/w==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2023-07-18T11:05:48Z"
    mac: ENC[AES256_GCM,data:OlRaHfjZ+sxsOAYkBLAVsxWMPN9Jf3covVR0K/+4VEJvpJaArVatla7p10xBePJRvsDgqQJEEfekdfeiLYxJor9U/0eNX5kFMzcKuP0qTcGXHPKZSEKAfg3y/TOy1yqPSWimV1rGQtlK+dNsz0Dp8I513Ay7HuIDTVOzrIkuT0c=,iv:mv/f6JZ8ONzC76nLfl3ARbOC3b1A1JypdsIRJTLFiBk=,tag:CgdA+ofwNMH/alFOjjMilg==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData|password|pass|postgresPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret)$
    version: 3.7.3
