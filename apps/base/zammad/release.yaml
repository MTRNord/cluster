apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: zammad
    namespace: zammad
spec:
    interval: 5m
    chart:
        spec:
            version: 9.0.x
            chart: zammad
            sourceRef:
                kind: HelmRepository
                name: zammad
            interval: 60m
    install:
        crds: Create
    upgrade:
        crds: CreateReplace
        # Force recreation due to Helm not properly patching Deployment with e.g. added port,
        # causing spurious drift detection
        force: true
    values:
        ingress:
            enabled: true
            annotations:
                cert-manager.io/cluster-issuer: letsencrypt-dns
            hosts:
                - host: zammad.midnightthoughts.space
                  paths:
                    - path: /
                      pathType: ImplementationSpecific
            tls:
                - secretName: zammad.midnightthoughts.space-tls
                  hosts:
                    - zammad.midnightthoughts.space
        secrets:
            postgresql:
                useExisting: true
                secretName: zammad-postgres
        zammadConfig:
            redis:
                pass: pheixuethei8acaiXeutaith4fohcaich3eeLiedoo2ahkai5reeThi5yohoo1th
            postgresql:
                enabled: false
                host: matrix-postgres-cluster.matrix-postgres-cluster.svc.cluster.local
        persistence:
            enabled: true
            storageClass: rook-main-fs
            accessModes:
                - ReadWriteMany
        elasticsearch:
            master:
                tolerations:
                    - key: arch
                      operator: Equal
                      value: arm64
                      effect: NoSchedule
            data:
                tolerations:
                    - key: ENC[AES256_GCM,data:tKgmpA==,iv:Jnksc8Ju/MFoX5zUxtb3oh74pE4Szs3C/+2MPsjPetk=,tag:IY7wF2ClOtV0KlpfraxYsQ==,type:str]
                      operator: ENC[AES256_GCM,data:qL7N4tE=,iv:+XDdibdPXzjTKt1blln5zsgwKhN+z65yNEO/ig456g8=,tag:AVtoHIAsAd29jn8MFlj54A==,type:str]
                      value: ENC[AES256_GCM,data:VJFZDzM=,iv:Cewzm16DfImJGjDv25H5JlenpUdWiW9Ykkl9daJKOP8=,tag:xYCqIb8vre19DSyxxGrbDw==,type:str]
                      effect: ENC[AES256_GCM,data:3UDjespkFTtSIQ==,iv:GGjBfj3kdxoVVecz6IfD8WUbIJApKhJ0jqPhn7Jrn8k=,tag:9fYzfeSZqxkVsV+HM1OPpA==,type:str]
            coordinating:
                tolerations:
                    - key: arch
                      operator: Equal
                      value: arm64
                      effect: NoSchedule
            ingest:
                tolerations:
                    - key: arch
                      operator: Equal
                      value: arm64
                      effect: NoSchedule
            metrics:
                tolerations:
                    - key: arch
                      operator: Equal
                      value: arm64
                      effect: NoSchedule
        memcached:
            tolerations:
                - key: arch
                  operator: Equal
                  value: arm64
                  effect: NoSchedule
        redis:
            auth:
                password: ENC[AES256_GCM,data:fqmw8DfG8Wo8T2C5f6iAKd6gheb49dl8cW1eCdN7iM56jrPjs+W5NGRftwn2GSFtUuLKCEATZwgcq++SwsFtIA==,iv:g6rxklK270RAbDZ8Tpzhj82IXZt7cbAYO3+Pldkx9jM=,tag:5x9cqe5zysR378UQKOMK/Q==,type:str]
            master:
                tolerations:
                    - key: arch
                      operator: Equal
                      value: arm64
                      effect: NoSchedule
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBGT3dqSVl6WmVFd1ZrWlVH
            Z0NET083M25vTXVjL2pJajJYL0hLamVoN3dnCnNvRU95emZGZzI5SFR2NllBUGVM
            NU53UEh0TDJKdjBQOGRaSllSTlppSTQKLS0tIDhqODhoaStTWkpSclFJdGlWYmJX
            dDhHN1Z6RUF2OTJrZDNQQytxRERXQ3cKgc5C6CfEfXqgg2ylTpkIGTo0n0upWbGZ
            Phs2Y6AfiD/L0m8VmX94QD8/gpG063QN1qsO/76WO3LwQHkRZ/2K9w==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2023-06-25T11:54:22Z"
    mac: ENC[AES256_GCM,data:CGHLXPpeSw8XN86g+iQrLMdoJ0uB9erF3vXYyiF3JMqsK+NDrs1LrC/CXKF971m6nIwrsYBFNTLvLjBUT97jtJJduPqu1odATfDAJu01AwzfmRDSTkTPi6jDs8rLQHYRKXLl7HdNBYvwZvjJ0fbIr2B1DtlzlIKfqNL89ld2VbU=,iv:DOlocvHNvuZOK0v4SyWJaRWdloGys0nrbJc7umuLVp8=,tag:Xq5k6Y7a27qVzlEQET7TDw==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData|password|postgresPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret)$
    version: 3.7.3
