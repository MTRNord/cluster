apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: zammad
    namespace: zammad
spec:
    interval: 5m
    chart:
        spec:
            version: 9.0.x
            chart: zammad
            sourceRef:
                kind: HelmRepository
                name: zammad
            interval: 60m
    install:
        crds: Create
        timeout: 25m
    upgrade:
        timeout: 25m
        crds: CreateReplace
        # Force recreation due to Helm not properly patching Deployment with e.g. added port,
        # causing spurious drift detection
        force: true
    values:
        ingress:
            enabled: true
            annotations:
                cert-manager.io/cluster-issuer: letsencrypt-http
            hosts:
                - host: zammad.midnightthoughts.space
                  paths:
                    - path: /
                      pathType: ImplementationSpecific
            tls:
                - secretName: zammad.midnightthoughts.space-tls
                  hosts:
                    - zammad.midnightthoughts.space
        secrets:
            postgresql:
                useExisting: true
                secretName: zammad-postgres
        zammadConfig:
            redis:
                pass: ENC[AES256_GCM,data:Xv5SEbF3P04h2brNzWF8Pq22RncfR1mcWlrN2hBkjYYPwI09ToErbAYtNBak345c4l/mnj8X905ShYAJSFwzaA==,iv:HdNGal/VFx9QDghRrIcdAhWfmyHqPERFj7kyvjPnzF4=,tag:LslCEKRBApf+urbIs+2v7A==,type:str]
            postgresql:
                enabled: false
                db: zammad
                host: matrix-postgres-cluster.matrix-postgres-cluster.svc.cluster.local
        persistence:
            enabled: true
            storageClass: nfs-client
            accessModes:
                - ReadWriteMany
            existingClaim: zammad-var-zammad-0-nfs-temp
        elasticsearch:
            master:
                ## Configure extra options for Elasticsearch master-elegible containers' liveness, readiness and startup probes
                ## ref: https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/#configure-probes
                ## @param master.startupProbe.enabled Enable/disable the startup probe (master nodes pod)
                ## @param master.startupProbe.initialDelaySeconds Delay before startup probe is initiated (master nodes pod)
                ## @param master.startupProbe.periodSeconds How often to perform the probe (master nodes pod)
                ## @param master.startupProbe.timeoutSeconds When the probe times out (master nodes pod)
                ## @param master.startupProbe.successThreshold Minimum consecutive successes for the probe to be considered successful after having failed (master nodes pod)
                ## @param master.startupProbe.failureThreshold Minimum consecutive failures for the probe to be considered failed after having succeeded
                ##
                startupProbe:
                    enabled: false
                    initialDelaySeconds: 90
                    periodSeconds: 10
                    timeoutSeconds: 5
                    successThreshold: 1
                    failureThreshold: 5
                ## @param master.livenessProbe.enabled Enable/disable the liveness probe (master-eligible nodes pod)
                ## @param master.livenessProbe.initialDelaySeconds Delay before liveness probe is initiated (master-eligible nodes pod)
                ## @param master.livenessProbe.periodSeconds How often to perform the probe (master-eligible nodes pod)
                ## @param master.livenessProbe.timeoutSeconds When the probe times out (master-eligible nodes pod)
                ## @param master.livenessProbe.successThreshold Minimum consecutive successes for the probe to be considered successful after having failed (master-eligible nodes pod)
                ## @param master.livenessProbe.failureThreshold Minimum consecutive failures for the probe to be considered failed after having succeeded
                ##
                livenessProbe:
                    enabled: true
                    initialDelaySeconds: 270
                    periodSeconds: 10
                    timeoutSeconds: 5
                    successThreshold: 1
                    failureThreshold: 5
                ## @param master.readinessProbe.enabled Enable/disable the readiness probe (master-eligible nodes pod)
                ## @param master.readinessProbe.initialDelaySeconds Delay before readiness probe is initiated (master-eligible nodes pod)
                ## @param master.readinessProbe.periodSeconds How often to perform the probe (master-eligible nodes pod)
                ## @param master.readinessProbe.timeoutSeconds When the probe times out (master-eligible nodes pod)
                ## @param master.readinessProbe.successThreshold Minimum consecutive successes for the probe to be considered successful after having failed (master-eligible nodes pod)
                ## @param master.readinessProbe.failureThreshold Minimum consecutive failures for the probe to be considered failed after having succeeded
                ##
                readinessProbe:
                    enabled: true
                    initialDelaySeconds: 180
                    periodSeconds: 25
                    timeoutSeconds: 5
                    successThreshold: 1
                    failureThreshold: 50
                # tolerations:
                #     - key: arch
                #       operator: Equal
                #       value: arm64
                #       effect: NoSchedule
        redis:
            auth:
                password: ENC[AES256_GCM,data:j7bUIwZKTrvrLherAO7g9U0F4ur9pbZQY5Jm/XlBfM1mVH+GuQGd3kKxVvdOV8P878yf6F+AB4Q+ZFo4L/MOFw==,iv:Eom00lKbSqPVDJA80SnkmoaAgTcpCKHUvqOwQnfSYg8=,tag:0CizVY5q40GOWpH5pNENFQ==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBDSXJ6bmhrYVFaOEs0Nm1E
            T3cwS2t1QUovY0lkek9YZ1hZNGwxY003T2owCkx4UDhtYTkrZUdLWENZSnJ6emI3
            NjlhMGZ0UnJieml4VExuY0M2QkltM3MKLS0tIEpXTStwSTBTdDlTaG5SdmxRdExH
            emJ6U2U3TGd0SGZ5UUZ6MCtFNWxIeFEKbhPIMkwpejFGoI2YHIqTamm35jrNG+FA
            aRx/XJm6MxnmsKnccKikqLRNEeiBlZqDy5eOvh+kJ3xJF9d1zasGxA==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2023-07-18T13:31:51Z"
    mac: ENC[AES256_GCM,data:DoFIGIc+7r++4gIG9rM3Joribxx0OMdozR0sZELPhcU+GEHakPKQXdwhZYO3fWKPDA+sEXSpWJTJDJyA3eHN6sKKdj03O26g81g/rU2O19WGzP0xELvdZkMzgK1/SWKSu4G7gJDYqwywoFrnIyZJJPOyXkuZFMw1F5cp+jb9nus=,iv:lilVzKyt5VCrU9UEbKRtAjwkm+lHXjoKGuCsqf/a5DU=,tag:reVHd+sLriqjIhSM1zP6HQ==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData|password|pass|postgresPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret)$
    version: 3.7.3
