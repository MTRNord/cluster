---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
    name: gerrit-403
    namespace: gerrit
spec:
    ipAllowList:
        sourceRange: []
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
    annotations:
        nginx.ingress.kubernetes.io/affinity: cookie
        nginx.ingress.kubernetes.io/session-cookie-expires: "3600"
        nginx.ingress.kubernetes.io/session-cookie-max-age: "3600"
        nginx.ingress.kubernetes.io/session-cookie-name: Gerrit_Session
        nginx.ingress.kubernetes.io/session-cookie-path: /
        traefik.ingress.kubernetes.io/router.pathmatcher: PathRegexp
    labels:
        app.kubernetes.io/component: gerrit-ingress
        app.kubernetes.io/instance: gerrit-gerrit-network
        app.kubernetes.io/part-of: gerrit-gerrit-network
    name: gerrit-ingress
    namespace: gerrit
spec:
    rules:
        - host: gerrit.midnightthoughts.space
          http:
              paths:
                  - backend:
                        service:
                            name: gerrit-replica-service
                            port:
                                name: http
                    path: /.*/git-upload-pack
                    pathType: ImplementationSpecific
                  - backend:
                        service:
                            name: gerrit-service
                            port:
                                name: http
                    path: /
                    pathType: Prefix

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
    annotations:
        traefik.ingress.kubernetes.io/router.middlewares: gerrit-gerrit-403@kubernetescrd
        traefik.ingress.kubernetes.io/router.pathmatcher: PathRegexp
    labels:
        app.kubernetes.io/component: gerrit-ingress
        app.kubernetes.io/instance: gerrit-gerrit-network
        app.kubernetes.io/part-of: gerrit-gerrit-network
    name: gerrit-ingress-403
    namespace: gerrit
spec:
    rules:
        - host: gerrit.midnightthoughts.space
          http:
              paths:
                  - backend:
                        service:
                            name: gerrit-replica-service
                            port:
                                name: http
                    path: "(/a)?/plugins/high-availability/.*"
                    pathType: ImplementationSpecific
