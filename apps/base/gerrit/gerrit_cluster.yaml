apiVersion: gerritoperator.google.com/v1beta13
kind: GerritCluster
metadata:
    name: gerrit
    namespace: gerrit
spec:
    containerImages:
        imagePullPolicy: Always
        gerritImages:
            registry: ghcr.io
            org: mtrnord
            tag: latest
    storage:
        # Which StorageClasses should be used
        storageClasses:
            readWriteOnce: ceph-filesystem
            readWriteMany: ceph-filesystem
        # The shared storage will be used to store git repositories, logs and other
        # components shared between Gerrit instances
        sharedStorage:
            size: 1Gi
    ingress:
        enabled: true
        host: gerrit.midnightthoughts.space
        annotations:
            external-dns.alpha.kubernetes.io/hostname: midnightthoughts.space
        tls:
            enabled: true
            secret: ENC[AES256_GCM,data:jULKs6Ad8YcreuDntDhYxB3FUnTaSDlUyaJtEICoiMQi,iv:ALBDC3tLo+5GyhqF73zNsTH3I+gtTtzUyzmX/Yjef/8=,tag:1k48/ajVv98Q5L0C7K8HGg==,type:str]
    # All Gerrit instances in the GerritCluster serve the same repositories and
    # thus have to use the same serverId, which has to be set centrally here.
    serverId: midnightthoughts-gerrit
    # List of Gerrit deployments to be installed in the GerritCluster
    gerrits:
        # A primary Gerrit
        - metadata:
            name: gerrit
            labels:
                app: gerrit
          spec:
            mode: PRIMARY
            replicas: 1
            resources:
                requests:
                    cpu: 1
                    memory: 5Gi
                limits:
                    cpu: 1
                    memory: 6Gi
            service:
                type: NodePort
                httpPort: 80
                sshPort: 29418
            site:
                size: 1Gi
            startupProbe:
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 10
            readinessProbe:
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 10
            livenessProbe:
                initialDelaySeconds: 120
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 3
            plugins:
                # This way plugins are installed from the Gerrit-war file
                - name: download-commands
                - name: delete-project
                - name: replication
                - name: oauth
                  url: https://gerrit-ci.gerritforge.com/job/plugin-oauth-bazel-master-master/lastSuccessfulBuild/artifact/bazel-bin/plugins/oauth/oauth.jar
                  sha1: 005ff9ae2f724c3bd4cd6f4259ee9c03b4ce88a5
                - name: branch-network
                  url: https://gerrit-ci.gerritforge.com/job/plugin-branch-network-bazel-master/lastSuccessfulBuild/artifact/bazel-bin/plugins/branch-network/branch-network.jar
                  sha1: 0064a6133b72684ccecf5038e61b23457bacab43
                  #- name: replication-status
                  #  url: https://gerrit-ci.gerritforge.com/job/plugin-replication-status-bazel-master/lastSuccessfulBuild/artifact/bazel-bin/plugins/replication-status/replication-status.jar
                  #  sha1: 5eb04d2238ce7d130d8b9cf0cd79f14e68e7ddfd
            configFiles:
                # Some configuration options are specific to the k8sgerrit setup. These
                # will be set by the Gerrit Operator.
                gerrit.config: ENC[AES256_GCM,data:qAUY1AQdUIZU+SvquE3uct4KDU+2R2PEW31j2at7ALLTJ6cJfyviIOsrpsPvrL75ZBhggkB+xv+NcScW1IaLs/LLOB3sMwd/kAF1Lk95MAiGHHk6904v78VkGrd3rIzFpHtY2UnmaEzmMLL8zIIFzRPf0EP8sIZ2pj3GTBtaRM+oHS8lyYJpOW7mXqvVa7arkQH1LUHf2ge2sXbJoyW7vI/M0WK1+I/F0QCGrVOsbphyK1JuEThpoIWGeLBNgohVkeu3dPKQEdFpngU29yC2nTorQlfQ6spe+Hda2K1CgnmMLSpfyo3W+qrSfDK/oBjnMpIltFzEVZXLs4yg0W2JPhM0bSKUjESHjiem4DSM0oNzem38rQNvx6K4KFcM/0YAe23lD+oAk1TbkdpgpQG5wgx8U/oxr5Q2ZXoHmZE6j8Af3jekFwNjH4o9YfhZ9LZ02G8WYfvbldIXAO4AqbUg2Gb/8ZfSNx7kJ1HgCxlN0fy4zR6hg5dasHAhqcuhII+dtyL1VoNhL5RP2aK17zToM0T9vNK8HCAbs9OAgNrXeM6zW2aKgbAw2MMLHxiGf7QrTdWLhL7GR9b+6Cu+njMq52MkwrnMvksMopmPc1CdvBe516OTakHDKeTuDCCoSs+0ujSY1FTilksyNQRljdR1Jn5drfV0VCYBkut9YT/v/kNk8pDxxlZ/Nd/EogG7fZGgOINCqves9P6UNx3H9FXsb6jAGuvgX9t2sl+Um8PMQNt0kFPOozklObuj3CVtJSDIw4iarc41nTuIQO+6qfaz5Z90NG0VdrWvKpsyNWDQ1ey+1agtz0vZDKoKEDUQCFZEZLZwO01c0GAeIBdEsYxew/O2sWw/SJsiK8QcbqZjMNsQKRKyP/oPUTjCTAm5OnM7uHldV0LNM/NN9IFLqOFBw0E6P3W+NtRxryaIEim340sd0epU/3FCkvoc5H2FBO1PV+eJ7o4QflgGmm2AD/GaM7RSHeshe05DFFTq3asUHz1B/a71mU9uzv5NJZ4YDWZ/UqjbRG5R+wzmE2PcZgBiqBbvTcCVFX+NDIXhCb7Kt+Xgld64FZYGcQrO2pPhHppjmfsCUlL445TlsJFdp1DO6BDDf/XorsS2MgvAXLX3lJcptVEeB/Sr+d+4oMkbHqhz43wxlbEp5um+CABxX/DpxEFTWnjzKN42ZvX9y/uxEUsW/+oY0K5gGNJN/p08tfQKmLLhe9qsOdC7IhokFKcWtZmfSuDZf13091QI7PJUI2aDTS3kkkC8amWT/KVjiJQuYzuiDDNuvA3nZFtgWtYIJfFyTyPKAl6sAU5JOJqZbXH68B0yMzIRXqzbQooN4Jf4ySzJRmQeEeh1WVxj5xIVaEgT1sndcWkoVld7Am5mVKU9roIfiAB04Cb0dU4tVNn5QBZF+5DaRMBcypbWFG4UUTs51kYybLXDV2tpPkbM4Q6QvQ4Fm/GVzKNPPg1YRrx9vx5/Qg1GQeIlT7J/PM7EsKufXH4zV5KtNIFj9XdrmRFSnOKhTO1+ijpRtdDJcOUV6xxgI6ApPBdPwPgBzz7RHWTcNYbkBWTBEwZ/s5b0SRrdCNdtTvAMUcNuUigRtL4k,iv:/9pXymQi7uAD5MygfPjUjWKv/1XcQsKRsRhyhf1k6Zc=,tag:rv5vGVk/7qKXKY7Q+q/M6A==,type:str]
            # Reference by name to the Secret containing secret files to be mounted to
            # $SITE/etc
            secretRef: gerrit-secure-config
        # Gerrit Replica
        - metadata:
            name: gerrit-replica
            labels:
                app: gerrit-replica
          spec:
            mode: REPLICA
            replicas: 2
            resources:
                requests:
                    cpu: 1
                    memory: 5Gi
                limits:
                    cpu: 1
                    memory: 6Gi
            service:
                type: NodePort
                httpPort: 80
                sshPort: 29418
            site:
                size: 1Gi
            plugins:
                - name: oauth
                  url: https://gerrit-ci.gerritforge.com/job/plugin-oauth-bazel-master-master/lastSuccessfulBuild/artifact/bazel-bin/plugins/oauth/oauth.jar
                  sha1: 005ff9ae2f724c3bd4cd6f4259ee9c03b4ce88a5
            startupProbe:
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 10
            readinessProbe:
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 10
            livenessProbe:
                initialDelaySeconds: 120
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 3
            configFiles:
                gerrit.config: ENC[AES256_GCM,data:8vIvMUIHx8T4eC3JeoTRWkeE9jPZoI5EwuNeewxzZZTIi3PQ5Ll+Ux9NKCF6t+Ae9G4ZmUaSEqFmOLZegVG2HixqShJP101w6fOD8UpOKN2jgqrN6IH7GcfSL/ktpkbmtzgHMnbe0b3IWKwKGVIpsJqI1X/ICfUYYI20YJ3M/H4MxU6rjpF04S6qW6I7JyoysjtTLuxdDTo7JbmCW6vVrI9ixzIayEN5SPFEFLWBuv7vtRnGmLTkfsjDWpF0om2WonGhYNMCyWfy6aeVMYz6y5KfvDg6Rp9Ncb6z3NhBOV+PIpiA+IAq/83ytMXmn5yJ+A68+GXp4wzxzD1KNilWNh5fAZ+nxpTw81jc85/C7rGCtKNWubRWVGoIGYn1q/t+m3sYKtwPs/QOk57CbpZujqmVdhsA45e/hgZGUo3zzl/TvAZ4UkZT4qZb/SYLN/Q5LNQg+phVPWt0FIlmexH0BYnmdljuWUbtqY7zYrzsQzW57PdH3iKFcOvwZu0FCT5VmrZCiM8t03TmHpdDJN8vAMoGwJ6eCSHwRWoIMEdeDxobT2z2xn47hIe4LJW+vcslV6FA5GPH2IfoxLOQRLFFbJnPdjATYax+7wNOfeEBYCE0bmXASMMWzsVIovBvhXZFwH1h9it/Fp8H/Gh+w1dR0B718pirEj+3xAXPUe7H1ZLWxBtCTqLiEDlSptc4h2pHomdB0ZD3JPgzA7t0fr68kqZFnXUfILh/jhv7s8UUyjNOKmaaJVihU61Xt2KtzVfJ8KRjP0qhWrHI1MPiWtKFlsPO2UehuXoPvjFhIuEdV64zYTq7Bc9nugfZ0PnioYw9g0c/2hdf0Ku/KPuTgS9aZCPNMsyzgY8X+wy/GHDcWdZIybF3ZJi3tPgCfDIh7rXVmHEG/oNk1Fl4QQIAvoCFrwvTXkOYU75XLeQzkVSimoA9GWDDCmnZKnUbuR70ioPi1yG7b1zISA7O1lAWuAwL/OxOj8TRO7tSKJh54bwfwSkvbeLosrUhXv6e36daDUd+r9xFeBeS+dnzVVULSwkAB0jiaD2knv2yhPpKOdIy918TQizxaCNvMIp3XfOuTwc6Zb9g8h8dC/M7Z2URU1fdL5a0QRNJaq63E/hy4/qoUy1akd7MNU1gwcg8+GomoWBg8mh4hB3nQDXZxsiJ2kl7W7G4wUATR6PA5Bk6ZM9lKT6WWdZ+uiqAU6/CRdnfNFFraL8EUxkTSClcgPKwij7vlo8kcMk8VgcfK5x8nA/fpvizmZ5qxzBBZ+W0iKIcsj+7aF9D8kSdw1skwDaF6WoaZOcS4Sz6pcmSs26tx7wtR0cGObUagtFQTrLh12v4XuPvfI2uWAc+qf58Nb7YzMpJF7oHw6kd6XDp8HfY7Oqo7vVav91WozwMv3H4P00F2PvSPjBgYPhtH43xT5rnxXQdmNpXm3kZ6yAzGRp0VyD/MUQMH5huT+g5JDOnPPAGMVv3BmhJNoT1Y6ugeZoNYPQN6v2dAVURSFAY5dj+/sV0a4FCMhVLa9BowAmpMj9VxIr7MkQu5zMplEYCE6Yo9jsURNINEzBDtzlm4Me+j5bDBG1ZcaDnStZ54t1uAfPpgr5Z,iv:1ZS7b+I4CbUfxEsc5q/Xk9RgJvyc5rXX3uPsnGkYJmI=,tag:GDIVAu0zCFwm7SyhaRuLSg==,type:str]
                healthcheck.config: |-
                    [healthcheck "auth"]
                      enabled = false
            secretRef: gerrit-secure-config
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSAyYnd5ZlR0dFNzNWswMFds
            b2RGNENVQmNXdlJ2Wkg1ZW51anBiVTdka1JZCmVLU0p0MHdaQmtPb1JBZ2lmV2pm
            MVlqK212QUxvcXZYa3B1TGJTQWloWG8KLS0tIERuUTg0YkZXdXNrbllVMG90Y3Jq
            NERSZWJZTUlnODl6czBKRTIwRzMyMjQKmM0XiNY8cEtYLkNlRWnYoa73Ydgz15jT
            jIq9oYq6Cm4l8aI5KdPNItSb4RdT3qBRaK7SsL55yxLGWXfR9S7mKw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-12-20T11:31:11Z"
    mac: ENC[AES256_GCM,data:20bu96eKKIl3Fmkfu37XTw0lvhC1V0Cx/u2jl/0Z3fK272D6EHWEZVglpr8UKE3K0pp9VOt7igCcN9t0aCY39VFQtAL2uShrOF3rXxtg08hT7Iq2G1HCDX0h7YG1GApj3eMPcIXY8x5n0F/BhaXd0YDSbOoMTxeywSMbwjP16qs=,iv:YgrsOqLelYJMtqTUoK1Zu5RlbKdN9hJ1CIfTo0EK0YM=,tag:TOQEw5R6URJZLmFyyNqRQA==,type:str]
    pgp: []
    encrypted_regex: ^(gerrit.config|routing_key|DATABASE_URL|SMTP_PASSWORD|SECRET_KEY_BASE|admin_password|extraCommands|key|clickhouseDatabaseURL|databaseURL|client_id|client_secret|secret_key_base|otp_secret|private_key|public_key|primaryKey|deterministicKey|keyDerivationSalt|token|clientId|secretKey|installationId|installationKey|uriOverride|adminToken.value|password.value|sql_password|erlangCookie|AUTHENTICATION_PASSWORD|ROOM_API_SECRET_KEY|adminPassword|configPassword|adminUser|configUser|MAIL_PASSWORD|APP_KEY|api_key|api_secret|keys|livekit_key|livekit_secret|secret_key|admin_pass|admin_email|mariadbPassword|mariadbRootPassword|privateKey|data|stringData|PASSWD|password|pass|postgresPassword|postgresqlPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret|admin_token|integrationKey|rootPassword)$
    version: 3.9.1
