apiVersion: gerritoperator.google.com/v1beta13
kind: GerritCluster
metadata:
    name: gerrit
    namespace: gerrit
spec:
    containerImages:
        imagePullPolicy: Always
        gerritImages:
            registry: ghcr.io
            org: mtrnord
            tag: latest
    storage:
        # Which StorageClasses should be used
        storageClasses:
            readWriteOnce: ceph-filesystem
            readWriteMany: ceph-filesystem
        # The shared storage will be used to store git repositories, logs and other
        # components shared between Gerrit instances
        sharedStorage:
            size: 1Gi
    ingress:
        enabled: true
        host: gerrit.midnightthoughts.space
        annotations:
            external-dns.alpha.kubernetes.io/hostname: midnightthoughts.space
        tls:
            enabled: true
            secret: ENC[AES256_GCM,data:Q49Tmm4d8/m8ZoFRdJZj9VDJCy3JMrwU5JES1A3ZzQz+,iv:u93ptrnyknfh4t6BjJBd2FHgWy0gyl+XAwOi0zs/bWc=,tag:cz1GX20wvwo+EHka6YAlOQ==,type:str]
    # All Gerrit instances in the GerritCluster serve the same repositories and
    # thus have to use the same serverId, which has to be set centrally here.
    serverId: midnightthoughts-gerrit
    # List of Gerrit deployments to be installed in the GerritCluster
    gerrits:
        # A primary Gerrit
        - metadata:
            name: gerrit
            labels:
                app: gerrit
          spec:
            mode: PRIMARY
            replicas: 1
            resources:
                requests:
                    cpu: 1
                    memory: 5Gi
                limits:
                    cpu: 1
                    memory: 6Gi
            service:
                type: NodePort
                httpPort: 80
                sshPort: 29418
            site:
                size: 1Gi
            startupProbe:
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 10
            readinessProbe:
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 10
            livenessProbe:
                initialDelaySeconds: 120
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 3
            plugins:
                # This way plugins are installed from the Gerrit-war file
                - name: download-commands
                - name: delete-project
                - name: replication
                - name: oauth
                  url: https://gerrit-ci.gerritforge.com/job/plugin-oauth-bazel-master-master/lastSuccessfulBuild/artifact/bazel-bin/plugins/oauth/oauth.jar
                  sha1: 005ff9ae2f724c3bd4cd6f4259ee9c03b4ce88a5
                - name: branch-network
                  url: https://gerrit-ci.gerritforge.com/job/plugin-branch-network-bazel-master/lastSuccessfulBuild/artifact/bazel-bin/plugins/branch-network/branch-network.jar
                  sha1: 0064a6133b72684ccecf5038e61b23457bacab43
                  #- name: replication-status
                  #  url: https://gerrit-ci.gerritforge.com/job/plugin-replication-status-bazel-master/lastSuccessfulBuild/artifact/bazel-bin/plugins/replication-status/replication-status.jar
                  #  sha1: 5eb04d2238ce7d130d8b9cf0cd79f14e68e7ddfd
            configFiles:
                # Some configuration options are specific to the k8sgerrit setup. These
                # will be set by the Gerrit Operator.
                gerrit.config: ENC[AES256_GCM,data:l1oYC7cDDdfT5FUpLWQKLCulgjTFu0QSDL+GoLRfFM6ZxRim+Yn0kfidiK+fEsSZPxvJWU5tY0aFEAq6RX885cx8yG0qX/eM1Rp1sUQwxHC9mZmek8h8aOjsqpi/qOUR1Z2n8N04+a2msca9jP663b22jv61vP62kA1tdqQnh9HCp3LRXSgw2FLZv9DEtFbVPrmN3y03muiZ8BuR7d+XzCbQau4fQi+rmGEh2+v9lvrVxliNBZihMAjTk2hS7TE2LuhIgmtdAs2eiVyXQ0j5FPsRe4+ZK7NEg83KAUHNu5Q8mWyzkjgGyK9GXB3lKD90+/P+Qls3LFXH6FMAqdxARRfCdHg4QYLPikDSGap+tpQ0OxRZhKBCHfKabrrM1fTWYRdOtowOplbS+QGgKeSl7hY70kfhk6QDrGzhdWUbz1EnYodw48Lx9ApTUvPxeSSTs0md2Bdq5qqdLEep2q0zQlnTvs4yYuAksTLrnmBmTUB1RRRLl2xOyh0QSFTjOC0+5i4vVyMYO0B0VNzGS3fQZGspypwQdonn6IDcvMdCCMgn+Al3GY95HGO01W5eXthKcSC5AMPJFUI8ZZlo0F8rrqXrE4A9HBMP9YZme2qenkt0WPKavQh7y/EKCT0No91C56exsItNa2KDa0qcp8kYK39Y+LQOAHkmPp5QAsi8TLo4DsL/QebBhwk4qsgVfjnz9QU6LPqIKMyD7uRhZaSb+eXt14X7P9DULGIFEWrWmK6kmqY9oVr2gWE7zliGhCxk5NCRqxKhUgPnCNS7NOSUQqHVpbDwrZ17NfHO6STjZ1WVj5QMMgj8fdSSceZpG5e1v2vFSsr8DgANUiwJY166OqeT70lvceEjQbgrbTyelEqt4xue19an/+4bB9edmFh5KAp+n/EyyDZIwpDhCalV7izoAhSdhTdw02byWmrjKVYSnOOMz3q15kXlWEF8Tv2sbUpYwC4G9C+DqUz66Oudsm/fbdeJix0OJ7Q3WSyqM36RCj7IHSUxA27wj5+l33D80eCjepuA4VoeBxWbqP1HqVRGu5Z2uiFmG5dMcV/u1KaOwAcan0y0DZq9D0S1cz08brACVYT4oACkFUbd1o8fBUHygNxBWkXMSGb1efhaMP8T9RvBWxO7MLBa5SQeIB17lfHvq5MkqHnNqpbx4cvZLNbJlxizTSIXVYorK8oRaD2tCSmLjakXCXzfvj+s8RLVsy2QIycQS4lDEFpuvohXE4mBxbur9tOee5KzjJuv4epNqRsLUI+rYPYi6kXtIFJ+zm3+gp8KbdBNnFukRHEelaxDigjld0VF6GkulUDSjr9DS1yLrYAhHxkgGUjzziCBoXQC/tH7O9XphT4jDzOgmuZiyRlgOEapujm9lbtRwBOzv0jVVBhJWBkzKAKXHMJb/jKF2TfPmey11C9LTy4+IlSpRpVVz32ZT9m9Siz1C3JJDUkxt6q+ys40xD9i0PufLwZM5zyIBhZ3xx6mrzBnBk9mCnEsmEB/lQbqn4jkpaZtNvfIa6FZNj6NF29XxBP5lrXTdr6yf1vH1nXKXvHXiClahz8Bh/zwO7+EbKpwAYu20KHVMaLos5DG0ppvXcN9869iaKofTsW/qNaM94I9ruaw9D+3OpE7f32Te7VleCRMrSwJ5OMK9to2,iv:qUniMRa749clDs/Wibrb7S5Q+i8Te/y5J8ntHubrDNM=,tag:l9UPmSGwrXV8DwHi9U0FWg==,type:str]
            # Reference by name to the Secret containing secret files to be mounted to
            # $SITE/etc
            secretRef: gerrit-secure-config
        # Gerrit Replica
        - metadata:
            name: gerrit-replica
            labels:
                app: gerrit-replica
          spec:
            mode: REPLICA
            replicas: 2
            resources:
                requests:
                    cpu: 1
                    memory: 5Gi
                limits:
                    cpu: 1
                    memory: 6Gi
            service:
                type: NodePort
                httpPort: 80
                sshPort: 29418
            site:
                size: 1Gi
            plugins:
                - name: oauth
                  url: https://gerrit-ci.gerritforge.com/job/plugin-oauth-bazel-master-master/lastSuccessfulBuild/artifact/bazel-bin/plugins/oauth/oauth.jar
                  sha1: 005ff9ae2f724c3bd4cd6f4259ee9c03b4ce88a5
            startupProbe:
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 10
            readinessProbe:
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 10
            livenessProbe:
                initialDelaySeconds: 120
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 3
            configFiles:
                gerrit.config: ENC[AES256_GCM,data:tblL7cUD75+x+Jb/TD+r73hqIkIlrXhajYfPuRzfYZuL1ZZWPbMwuJlJVMjnm0hqmpTbGZKTUhAMwKuOwul4Clq/ucxfUcQCBjNxtHehfNTkuU6dQecmOKIri4YE/+29MhSIryT0DnI/GBMQ9ipsnDIiz5veKXCFQfsnroxnt3EpAjSx8kmHPI5X50k9YlPIgs2k1PnjJFR9emO1czMFqwbwxXHhMCa7KH8AQ3PGCIbcXVUuoZ9hGLBNO9BhaOgiZN3TaKNUgLTZ/Qa9PHwfJ8QSfvOyq1mtlgKut+q/QwVUz3xhSJ9RLnPlmo5quLcqAMSHQuqOkHCBdttCZTngvCViQHQLbyoThdxXAHJBp6ykhQxbUFjaghCth19jv9yPi8qTDniWEHFtXRQXIgFIe6w3Dm/6wtzX7z5hrR4K/KkQ3DqiPmpWmIVbUnkCA0Dt5FXh4W4UN/vjwPj5GMPmlZqtqMbDWiTyrukAsqHd6zkeWd/8zIW0NmojVmtzydLSkAIeCF1fOtHoSA/XO2C8aVyUkFJo9jB9Ec/3O/hlno2iiwHiZXE//4V0Vl7v0ieCuosY6EUgQRx24e8Q83v7h3EGc4eOw1cKUlghzX6DE6gnYJdPwysdH5n0+o++D0t05AQx0o31ysBPjh7/Vlf6pCiRo9Zyw05uBgUODWKETT5iNc11zRyYbOwLGGBIJaJTzhaXFC43M8AXJ4w9Bap7FOMClSUIlzzaqB1g1Uk2gXClACONzNAhhHXEjCSxoABtToTjTyjbbu4H+2ORn8qbYTz0lDAKWifCVfcJ8BtqWXKFTrapU8lan0Z2A8CdyKomDqIJkDQtKEjXVGyrFaTYio9P+hlqvrg0qkGfno4cQ1W4SM1HBJAK0t9dpvG0zXIfjfZADuCCYY2kbFhw8LF9MPJdvHoqQYQGiL1Xm9QQwYYP6JQHv9DhKn8fMsgOip6JC8C9nox0f5b+Ow5OODkrG+hTsGTHRBQEQDO/68M34yS0cRiV1+pikNJJBkH6JhuTZ/cBHx9iUjWBaNnH+oHX7AVRCgrYsbd/Cqdjr1zlFE7dyMfybbY81m4jbCcJXRh7a28SU6mLgTHouG05jfytYnh0FBrh8X7yv59we/ukrwrVQokpVOLpFXo+jF3Prxh2NCQJSiajI4KRsRLrVm1n73z88Jgza1yIih9hZ8fPrzKOhQq/yG2KtWa0z+iYfsItjfpR0EhSlpxskzlCpNGHqo9PD00Ccs8//imh1CccrLM9BpyL4+Bvit2qCMFS13sqjaZaM1ow00YUH6d434TecoAs5FOlfY6DGjSUFp9T4EzR0dxebzRiH3otgoZcPgj5RbNAWrCxyD7GmMDBTKWdblVcRxtkDU+MlxIUQ6fpq4QG1GW7fEeemX7ISYHDhG+LS7xXnJ8TOwLNktpl1yD+ptvy8RyHkGpiZXXGDjuxk16InNpmK42eOoWPwkIusESY+l15bGStnPZ6IjQbw3ONAzzTz1hudhNOY9s5upu+0e7iwpiCz/uBPR1oxasTDgQG37WM8acOBX5B/ZVdX1eswJ96Ch6VHPo2UO7LSVBYS8LTQKprQ9U6ZN9XInTYsbPwj3Z5dKcmPO4PYlHeLQj+sD9BczKhM1quHxa1gZpd1ZXwtuP1H2DMG+iB,iv:87kz2kf0wneicWe6aQlBnLkmsjdf+5b2nD0hDFbJ4QI=,tag:8TRILRTyxthsiORMI8/BnA==,type:str]
                healthcheck.config: |-
                    [healthcheck "auth"]
                      enabled = false
            secretRef: gerrit-secure-config
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBxSXhUNHh4MFVLTDNGcDl1
            ck9PTmY2ak5FN2lFNkFyQWdRanJXOEdWWEc4CklicThWeUdyRWwyNVA5V3hza2pJ
            eisyQU41ejRGaFpleUpseENOQ0MrZmsKLS0tIDBFR0ZsNjl2NnU2eGpHSllqd3M1
            V1ZFeDNoYVJNaWxFK2xYQnFSUCt0Q28KEdx/vIK6omQ11i06jpcYt8c7ErD4HOM5
            GGDaytsTioixAJKVeePuTpxBYMM35uNDd9IaobEspDKy8Rf797ko3A==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-12-20T11:59:12Z"
    mac: ENC[AES256_GCM,data:JYgGe1Lk4mo6+aF7b6EASm5M45NlOxYkuu00szGrIias5pA6ChDPfCrPjUiTphh+Dh63HTwpAcprNI9O+6mo3HwsCfon/xPAhkYqp9pgH7MmB6N2BVYxj712U9YbQTxv3dgR08S21tRgx4IGnBuXxsZA5bFMTLdYrO7XoYJgVug=,iv:W8Y/z4LatLSLjFuzlMF03w29CoTCDhQ8N3hbC+6IHtA=,tag:wObydLoqXkVJnOSYTor3xg==,type:str]
    pgp: []
    encrypted_regex: ^(gerrit.config|routing_key|DATABASE_URL|SMTP_PASSWORD|SECRET_KEY_BASE|admin_password|extraCommands|key|clickhouseDatabaseURL|databaseURL|client_id|client_secret|secret_key_base|otp_secret|private_key|public_key|primaryKey|deterministicKey|keyDerivationSalt|token|clientId|secretKey|installationId|installationKey|uriOverride|adminToken.value|password.value|sql_password|erlangCookie|AUTHENTICATION_PASSWORD|ROOM_API_SECRET_KEY|adminPassword|configPassword|adminUser|configUser|MAIL_PASSWORD|APP_KEY|api_key|api_secret|keys|livekit_key|livekit_secret|secret_key|admin_pass|admin_email|mariadbPassword|mariadbRootPassword|privateKey|data|stringData|PASSWD|password|pass|postgresPassword|postgresqlPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret|admin_token|integrationKey|rootPassword)$
    version: 3.9.1
