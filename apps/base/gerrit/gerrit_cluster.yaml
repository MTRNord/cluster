apiVersion: gerritoperator.google.com/v1beta13
kind: GerritCluster
metadata:
    name: gerrit
    namespace: gerrit
spec:
    containerImages:
        imagePullPolicy: Always
        gerritImages:
            registry: ghcr.io
            org: mtrnord
            tag: latest
    storage:
        # Which StorageClasses should be used
        storageClasses:
            readWriteOnce: ceph-filesystem
            readWriteMany: ceph-filesystem
        # The shared storage will be used to store git repositories, logs and other
        # components shared between Gerrit instances
        sharedStorage:
            size: 1Gi
    ingress:
        enabled: true
        host: gerrit.midnightthoughts.space
        annotations:
            external-dns.alpha.kubernetes.io/hostname: midnightthoughts.space
        tls:
            enabled: true
            secret: ENC[AES256_GCM,data:K/egwJZhj79wlxfm8ImX/E6Qs4DynyIgS3QxRbPC4nBL,iv:1JqzHMkeamppu3LeM89n9Q+eLqksvQvdz0mDKP5ElAI=,tag:h18PBPlT2l/xf7A+XwGTNg==,type:str]
    # All Gerrit instances in the GerritCluster serve the same repositories and
    # thus have to use the same serverId, which has to be set centrally here.
    serverId: midnightthoughts-gerrit
    # List of Gerrit deployments to be installed in the GerritCluster
    gerrits:
        # A primary Gerrit
        - metadata:
            name: gerrit
            labels:
                app: gerrit
          spec:
            mode: PRIMARY
            replicas: 1
            resources:
                requests:
                    cpu: 1
                    memory: 5Gi
                limits:
                    cpu: 1
                    memory: 6Gi
            service:
                type: NodePort
                httpPort: 80
                sshPort: 29418
            site:
                size: 1Gi
            startupProbe:
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 10
            readinessProbe:
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 10
            livenessProbe:
                initialDelaySeconds: 120
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 3
            plugins:
                # This way plugins are installed from the Gerrit-war file
                - name: download-commands
                - name: delete-project
                - name: replication
                - name: oauth
                  url: https://gerrit-ci.gerritforge.com/job/plugin-oauth-bazel-master-master/lastSuccessfulBuild/artifact/bazel-bin/plugins/oauth/oauth.jar
                  sha1: 005ff9ae2f724c3bd4cd6f4259ee9c03b4ce88a5
                - name: branch-network
                  url: https://gerrit-ci.gerritforge.com/job/plugin-branch-network-bazel-master/lastSuccessfulBuild/artifact/bazel-bin/plugins/branch-network/branch-network.jar
                  sha1: 0064a6133b72684ccecf5038e61b23457bacab43
                  #- name: replication-status
                  #  url: https://gerrit-ci.gerritforge.com/job/plugin-replication-status-bazel-master/lastSuccessfulBuild/artifact/bazel-bin/plugins/replication-status/replication-status.jar
                  #  sha1: 5eb04d2238ce7d130d8b9cf0cd79f14e68e7ddfd
            configFiles:
                # Some configuration options are specific to the k8sgerrit setup. These
                # will be set by the Gerrit Operator.
                gerrit.config: ENC[AES256_GCM,data:O3CJZ7qEhiRpkOERlAW5CQFMykVd2wk3q1MJTG4F62xW0l2/m5xQW5MbIC4O748okWlXDeElh/YK3iCrXPolli9nvOfo+ZKByeFWXdbokBmoGUT04Hg2+XUThR28CAxHzeY+M7ky2Hkf7drv6FaqPHy/wRebi6mFUPVLoqdga7+rRc232qRayyrdjuCxMAeCJFGKlxj85+MSQXebjYcNqnZAkJxEtag+7OviQSL4jW1yJdTIeM3wJQojQrX9a6hltmwcUGgOruUMeWpKZyR5wH4uxWt4pcUyTz2XWvGb2EmUuL/h2whVeu2LKBbtBD0+CyeiQV9VSIjIsj07ZS4XtkdPo5jCcU18uWlrUtzM6ZJc1vHJ4DWhC9rv0LpuXMn6CG8x7meetzXgfsefD+4F6XCvXSSFr9RR6TDlqFVBL4LlMwsmzpRTGz6Tpd59sFsA19A0Zz/KWTmt4iPPYiEPF4I8Py+YHv4pWugg6Qg63fxkTs5JBICekc6zZ1md6F4uS7bMwnssOFJo3WHZLAF7g+BGpxoUQh9JICrmjwjewip8SZsbXH7TLwabB17YWDqFsO7qocq+vXESnGA/qOKv64xvjj/6jGByp5OhI5v/tCwRfMp9C4lxGpVxWB5EMWXZBmVc7dAnFtuEmhI7Oxw4lKhBhRcfsCN13o0TmSb6Sl77Yf3yDnwy9KREqZVClFkZkNpX9ypeBQ3S1tmDA6G4KLqmk9aS4yq1DLITwaRGlMq5jLmid4qY5Yzz2OxnJgI6/i9iNTMsZ5vbt2/cDaPfxvMgMozKaTlV0cvS5+8zncgx0gyrJs0t24/8wCI0iFdGVu9rSvtW03ySvZxdd/QntWzaKFbA0vBcobL0IWfjhZDj8o/caEJMakTaLTCATozJz9qqiOUtKzDs1i1d/tDGCKG5Q5mR7ADPtNnXKwNxGSvtB6fygs7u+8YfokKlP+7bPOuu3XHdyOeNCHF/Swuxn2fIkkVK80bhfi0kNNMdByQ0JacVbPuy2fCHdVw0uL0YwxnRVaxpm+6yDUPY+gAlpfZv8xrBS/8JJkJJUl7xbrVFxTbbKN/9LZbmPhz1FFq5U6YzuUXyJNOIzTvdgoGcj8sE8hHu/wVEjGmsXgmUBhknB6Ki4cD3QeW2nYvcrSMXJOaQe/jwg4aBaPI2guAQJZt9OIDvB/AmjnhIZYZFGDEx+DCmazQemB545DILtsg3D3+KV/32X+b2O5QHE7ZUAv52To/C+fNFf9GyELn78wOTAwwlyRThrw3XphWx2W2hMaLhIZS9CWRi0CuwAVdkE+H3JtHZXdIvs+PmBJHbqw90vGkceVKZ8MnDUh7UEKl67IpOf036DBwBKf9jy2FTRRt/tHC6aHhP6EDXMOAlVutJGnPP1ky9rh10AOI65ZoOumk3HtN5RWcTYftzqF46Z3g4xn/M/1xFawmtv0QvLZkyNdE71zGWPULac9ACWoL/seuLEH3CT5LUNl+Eayzd0ePL8DzouMdNkSRnfMSmqOlLiI0owAngs7LyVSpfBE7HNPgi0qfkV6t7pX8kle//Ud8DJSCxcac9IEkFBNQbYKM1KhpfRe/QyqriomRcmvNuAqIIsaOgH3ah0kA1THMjjMVZZWsR5T0SNzJnlrIfuIPTxCReLQ/ZWQnhSL6s,iv:vHrQNSgf/UTy7hI4R1IfMSccfKZMTqWfp99nTLGSObw=,tag:SY4ggu6o1fKPRDUqW68eQw==,type:str]
            # Reference by name to the Secret containing secret files to be mounted to
            # $SITE/etc
            secretRef: gerrit-secure-config
        # Gerrit Replica
        - metadata:
            name: gerrit-replica
            labels:
                app: gerrit-replica
          spec:
            mode: REPLICA
            replicas: 2
            resources:
                requests:
                    cpu: 1
                    memory: 5Gi
                limits:
                    cpu: 1
                    memory: 6Gi
            service:
                type: NodePort
                httpPort: 80
                sshPort: 29418
            site:
                size: 1Gi
            plugins:
                - name: oauth
                  url: https://gerrit-ci.gerritforge.com/job/plugin-oauth-bazel-master-master/lastSuccessfulBuild/artifact/bazel-bin/plugins/oauth/oauth.jar
                  sha1: 005ff9ae2f724c3bd4cd6f4259ee9c03b4ce88a5
            startupProbe:
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 10
            readinessProbe:
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 10
            livenessProbe:
                initialDelaySeconds: 120
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 3
            configFiles:
                gerrit.config: ENC[AES256_GCM,data:m2mKXNkP5zyfZylNLF4m1ZTSjHSsRHRO1xpkxHyggPhMyxL8yhRnkcG9Ef+FUu4jTfeW9FC5arAhdgMDESuWYwQ3KCGrSQR5dMu7RGFkD4fnGfOj1yJwcgkMpgRgK7NEZVQicOUjd+2DL6FjcVmKJGGUxIUyopBXg5BdPE4aUghe53bNz/7VSrmsCrk4eXFxPajzL3clD5d6+SQbkairLTFXQEIzidqsybA2dy8pFADz1lpoeCpHCqRSOgDhPJpYdgc3Pouk2bTdMYR3vR7gTMOBhZ8geyP+eVxs+8emzTV5f6fMYEKJf+1ZrEFrApQcfEGrv7tUuvxBxxo6LOKy1TDYnJk6caY2IYwQ1OQAGiCTyKaJ34RYFr+gG0uFgxcxuG/PelYd8v2pYZy0nmqQhdoLVyFtzGv7M4u5o0+T/ZZkOKGadE8esspXBpqQwZi2XxzmBwx895vNhow2Slg+7QQmS7Gat06OtRlFxjltjc7PeKAKWzzSX7CL2Xi41HG+CZMFu4Yo6HRiesMbMgpJAfiNJEH85SmGMc1t1SVI/WaD5LqFn38RtcqIUNEU42/afepUsQ0QpwCx+lZMve9k6QpWj80U/M/hCduMouD4yUgrUASMERENqx9OndDSneA25laYhad02lw/jCkp/ZZ1JcfukTrXNn0Wq8FwIA3V4wTEvbtKS5DIcTuAIYiLSz828d3fgWp55toXqli6dY7EyZtGlVIbh73F2cgydGuvkzPdgehck/xHcJ4Kz3RJFuXpWkDA2u9zMthSe2smEpRQUC1I7DeOJCgagrVVWnhzV8sYyDGynO9V6LIS7D911r8WxWIVkbEEkw+O1WsfdK21WfKKlSzvcDMBr3ZOVDh/lH/vvf1IDay2/BQNPyzaVPI0/huRJ3mJgBvNMBmhHMvDnMsaaVl5DSZWUXr1Jl8ZTx2vPQ1HQ4QaDDXN7TpgQoCQBqvJA1c5wgjUzEL7LwB+s6C36KtjrkvWfL/yTjkgdjlioscP0l+Dup4hpxY5j+Nh4AZc2q8EWbCrPqWBBFYyy0EUf58Sz0O2IZNXZIS5PRFBhaHP++4++tdyytSh6YTlcVW/8WFRbwfI+sWmznC58cJuMMweO4qxQY9zKhEmcSfnFfOKvQ76bZteMW4epFU6Xqg9DHJhF+wxjqorBk4bqMY30swq/xXmGTl/grjL5r3wje2v2bOEpcfd/dnqoztJ8ZKjYD7fQFxyZ8K4iaOgn8IzxIW515/0jvf5w7ATfP2x0N9pfmzz5p9otUwMbNp9EB/4Bd+Ql2NZgyNEHrWFVAnyGtnWUQcFNssAe0KyJyMcd3DeORDhoNvyYXaprfsrFsB/scQxoWnwmc3glwohVNQyd/XstIqgKI0WvjR8H5PZyfcvxLbKVo8s6D9gct6NHeyPdNgmmr6pyeawvngR6Rg1ZUAFAGV/7agyHxQTCiftnQFQ8wv1Ta4JuuTr2XugGKwBrgUVhbfTn8RChNmfCK2pYORoWQccyOr3aHtsWCgWDY7oDlrTH2ZZhByVyafWliQ4sftNrQuTGlIMMnsjpFMJ/DhN3rx3bHhvTEgVspCbdqkLZfMTjRY1n/wi0bmbc3t0bHnuoESMoyZ+gZmWIUig5tqIKnKduGps8lWpwWisRUlVGZgOHSaG1W9g,iv:e6wtUPn4kTWxMoGeA40/h2xu6v797uKwoxc18syFHEA=,tag:GbnTUXGp8WElVSWMfTfQeA==,type:str]
                healthcheck.config: |-
                    [healthcheck "auth"]
                      enabled = false
            secretRef: gerrit-secure-config
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBZRGUrWkNMSkE4bXQ1UytM
            TEZvYkJvTWZpMG9pZjhMM0JSMCtVMWRUbTBnCmUvbVc2ejVYcWdBbExqbWVLMXVn
            NTJtbmxvRWVEZ1N2SVZMTU5aRmsxM1EKLS0tIGFZZFZacGc1bEUyMU9oMGRmcDFH
            aTN0NjU0eUE5cUtxN1RFS0t4c2x5blEKPyKuvNu9HE3Si+xTPhTTURyaydcAVFtN
            Nhqed6AHwDcJHoWwafI3sbnjgmIt8TJJ67LOphr531B/ilmJSnm98Q==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-12-20T13:20:56Z"
    mac: ENC[AES256_GCM,data:NyAL2wxQDZt/8WP6OVXqwLT1IbWWsf0AruL4wy0nInE61IAN2LVp9Y4nK6wVtiKG1EdT7fiv75T3Awu0r/NT7AINPW2xE58XZ5Du59CfoygLCU/EidXhAVY+2X13Sv+pyuik7r1bJCrUVY9+ELdi9Rkz/gYlf9CCQonw1ZR0oVQ=,iv:hIqgqmtjvqeXXT3ibkfH9OiUDBjJRzxGfosvmp59qvI=,tag:KzdC2cN9YUAzGtvJmcKpJA==,type:str]
    pgp: []
    encrypted_regex: ^(gerrit.config|routing_key|DATABASE_URL|SMTP_PASSWORD|SECRET_KEY_BASE|admin_password|extraCommands|key|clickhouseDatabaseURL|databaseURL|client_id|client_secret|secret_key_base|otp_secret|private_key|public_key|primaryKey|deterministicKey|keyDerivationSalt|token|clientId|secretKey|installationId|installationKey|uriOverride|adminToken.value|password.value|sql_password|erlangCookie|AUTHENTICATION_PASSWORD|ROOM_API_SECRET_KEY|adminPassword|configPassword|adminUser|configUser|MAIL_PASSWORD|APP_KEY|api_key|api_secret|keys|livekit_key|livekit_secret|secret_key|admin_pass|admin_email|mariadbPassword|mariadbRootPassword|privateKey|data|stringData|PASSWD|password|pass|postgresPassword|postgresqlPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret|admin_token|integrationKey|rootPassword)$
    version: 3.9.1
