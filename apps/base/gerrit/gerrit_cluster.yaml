apiVersion: gerritoperator.google.com/v1beta13
kind: GerritCluster
metadata:
    name: gerrit
    namespace: gerrit
spec:
    containerImages:
        imagePullPolicy: Always
        gerritImages:
            registry: ghcr.io
            org: mtrnord
            tag: latest
    storage:
        # Which StorageClasses should be used
        storageClasses:
            readWriteOnce: ceph-filesystem
            readWriteMany: ceph-filesystem
        # The shared storage will be used to store git repositories, logs and other
        # components shared between Gerrit instances
        sharedStorage:
            size: 1Gi
    ingress:
        enabled: true
        host: gerrit.midnightthoughts.space
        annotations:
            external-dns.alpha.kubernetes.io/hostname: midnightthoughts.space
        tls:
            enabled: true
            secret: ENC[AES256_GCM,data:p7iM0wQGnBvp4UERQuSlw94sPsEL6TSOzmayA5q6kCuZ,iv:aFdAVGUOS7R8Uwrc5cJ0GOHzQoBvczFE5RLR7gMwZQc=,tag:1HcIf3tq3EC2LFgRW6qQuw==,type:str]
    # All Gerrit instances in the GerritCluster serve the same repositories and
    # thus have to use the same serverId, which has to be set centrally here.
    serverId: midnightthoughts-gerrit
    # List of Gerrit deployments to be installed in the GerritCluster
    gerrits:
        # A primary Gerrit
        - metadata:
            name: gerrit
            labels:
                app: gerrit
          spec:
            mode: PRIMARY
            replicas: 1
            resources:
                requests:
                    cpu: 1
                    memory: 5Gi
                limits:
                    cpu: 1
                    memory: 6Gi
            service:
                type: NodePort
                httpPort: 80
                sshPort: 29418
            site:
                size: 1Gi
            startupProbe:
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 10
            readinessProbe:
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 10
            livenessProbe:
                initialDelaySeconds: 120
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 3
            plugins:
                # This way plugins are installed from the Gerrit-war file
                - name: download-commands
                - name: delete-project
                - name: replication
                - name: oauth
                  url: https://gerrit-ci.gerritforge.com/job/plugin-oauth-bazel-master-master/lastSuccessfulBuild/artifact/bazel-bin/plugins/oauth/oauth.jar
                  sha1: 005ff9ae2f724c3bd4cd6f4259ee9c03b4ce88a5
                - name: branch-network
                  url: https://gerrit-ci.gerritforge.com/job/plugin-branch-network-bazel-master/lastSuccessfulBuild/artifact/bazel-bin/plugins/branch-network/branch-network.jar
                  sha1: 0064a6133b72684ccecf5038e61b23457bacab43
                  #- name: replication-status
                  #  url: https://gerrit-ci.gerritforge.com/job/plugin-replication-status-bazel-master/lastSuccessfulBuild/artifact/bazel-bin/plugins/replication-status/replication-status.jar
                  #  sha1: 5eb04d2238ce7d130d8b9cf0cd79f14e68e7ddfd
            configFiles:
                # Some configuration options are specific to the k8sgerrit setup. These
                # will be set by the Gerrit Operator.
                gerrit.config: ENC[AES256_GCM,data:6ZBy2/hzJgnk7woDswXNxu8ExiDCCXf2PK61aPC0FANfQee2l81FH4xEY6xXNOpsPdJmRL7EkVdx60cKMewvgZUdOo9UVh+J/ck9b0J7hTcJhUigeKm9O40Pwf3zm3tr9slgc/5O0TZ5zGMAJ5iC5ty78M/NKWgAdBUcmOL3aRq/TC8xIt6REtLJ3mhzPQEAKRwuzwZwWZ4BYIFpSgL63iNIrH2oxL0U38aBRjKkXGCo0uyb+/xGEhwMlt8p9daELwh4mxg28eB2MFSHUyhB6END97U0RWZWXQqsFGG2CeHPboE1ucsncqoe1OeTsD4fsKEI+IuuZsgd6NDUnx6+dGKDTBf6SfBOxPNvt5IcAsw8/Zx5o9sWwaY9GOtm6ojrDioLp6QNfmblytgxja1nM13NclQD9mzVCKiwTiWP73O6nyl5r6u+Tbb6eDJz2+Zk2WRNbFnevt69LCWZtHLC+J4AXtDnVTbwNoUPIYTT6TNAftoikZChDldxtp0AzlqaPe65h/O8cl+wf80SAVEL7ScCWaASwgeqUUh6g7wvG5ANq7xfsGqviXIcUt5hrwa+Kmgm/oX+P6izH8zbPWJRjafegUTklSORFSkQYEbsCl5a0gf52rIsw2M5cE4nRFD6lhZupKIL9d9gdSaYFbVNAlX2DykdCu5ydMCOwxqf/cwQX9Og5YxY5T6N9bdmcXsbgBpL5RqmXqt5ybldPEkhsp2EUddLRCPm/ssE5k0PVQoYuZd2Q9SLKiERtewxp6ynhrFr7TZcVsY1xyzUQeEIr84ABCPrMs36ZemTMd45Flepah2B53YI+BgewfCuudoCkMcU+TC9pidNce62vYdIBpQFIx2PiSVaswOqCSDLZ1ephntGbb92gZiaO6qdTWet+z0+Ui8m7iUceHVv40vxwoiCn4OM600uolv7eu2oChPasX8WkNEHe4yqqWCl9HYH0VIO2RpjFj4922CzaRfstxCteN27NSx+Wlp5IU9uM4wNSe7rgmvu0hUPGD9j9Wmf4F9t67pey7in8nVywmrA9d4IYTmBf4pMnddIvE0nUkWJzteLhRjjR0ftvx98CAyxp9kjp3IwKawimWXXTc6cfglxbRmK62DtXtxnhxZv24+Ly0Zt8/JSs7hZsyLcuLo6FXgmMwe5sfYqVmyDqNR9bCAaeHPs0bm5DI9q3B+b/jjYL+wofkhHop36yZcaptQNLNM8m6TPk5c/wibSj+18twcWS4fxCFAjLZi90u5HUUAyuDoz/I4ls7CSCsz4HT2khh60LwQx7B+k0X+msdwnMovrAFnyDZv0ttqgjTWatg5dCdrs91rzKiJXlxTOyg0mnThJjU+r/2T+hbglUDjhX8qZk/qUoo8X+96jB6FeysTeetmnc689v4iyqDaZlijr/evTDgsGaNYBjjQemMahVaXT2kofU4NqE5mVzflY5e3vsOjYX3xpTW8Zl3WYFo7vX4E1kHjqgiR5S6j0/DbaYBXJBe1eBJ3sqeuGtCyzDs+Dy1SRYLMIpBSIjDb6bQ+Qu3hbUd3m1DynGFc3JiUIXNydHt1ImoR0lFG4W93EJxrsHD6x3pE8FwIKTenrARAUSKv4LSiTvgDlimwRAYk+NXHvn2muVnDPRzLncK0BSJOYYT01eLEwHPyr9H5D,iv:CmRcXVGH4oXtUa+OgoSRPIONaktai941JmvvRULjjho=,tag:jClyha1M6TCzeiEe5nxIMQ==,type:str]
            # Reference by name to the Secret containing secret files to be mounted to
            # $SITE/etc
            secretRef: gerrit-secure-config
        # Gerrit Replica
        - metadata:
            name: gerrit-replica
            labels:
                app: gerrit-replica
          spec:
            mode: REPLICA
            replicas: 2
            resources:
                requests:
                    cpu: 1
                    memory: 5Gi
                limits:
                    cpu: 1
                    memory: 6Gi
            service:
                type: NodePort
                httpPort: 80
                sshPort: 29418
            site:
                size: 1Gi
            plugins:
                - name: oauth
                  url: https://gerrit-ci.gerritforge.com/job/plugin-oauth-bazel-master-master/lastSuccessfulBuild/artifact/bazel-bin/plugins/oauth/oauth.jar
                  sha1: 005ff9ae2f724c3bd4cd6f4259ee9c03b4ce88a5
            startupProbe:
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 10
            readinessProbe:
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 10
            livenessProbe:
                initialDelaySeconds: 120
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 3
            configFiles:
                gerrit.config: ENC[AES256_GCM,data:BKs739JlpqEhMz8UMMwhGCPZFIhXceWrrfvzjUqbRcVDV5+nCgbBOCAj/2tsYA6dG3slR8NvvHEgdxJBza/MnOtIA/ykqavIdFfJeGz6MbyWZtGKv8p1pjlyS3oekZ+0vJIrk3FnsJH6PS76NAQX6+X+93/YVH3VKcdItf7k3hlP3Sgesx3hXE7rDC+eWL+UJXp0R1P4zBzCsrBHY3W/j8uyJuplCixBkqzX11tr8YuSRgjOIkakQ1v5owYs1NDeoEKZoWKaB/NP0ZpM3XyToXN8AkRNcRXw0AlVdmsSK/1C1ENOSM4rEjxAdwA8rjjTUV5fSjqaI1Nz1eMKiPquDFZRnDtWMvdFAwWRZ5iHh1KVhi7+GedVDhmYIMt9uGs/h0lBYwt2OXdUmH7ZyrW8lRjjR5Q1fGvaI05Srm/a5gWHxJmIKcpn5MjRs0+hgsYrY9RtEH4jnFezprAzOyhUI5BeGX9HCuhUpUnjkySKaLd7ALE4MWED+uKvxQ1Due9R7lHPBDIROcRF6GUN1PMG4hL5aTV+V4e+qfjLDYKkFzw0lFEn06H2IMl/WNHSeqvth5qviNQowzVZ4GRp65UpYIQfsnv7qHb6ouRutUJqyZAn9H9z4hl7HHx24tG6GJ8+jRujwbE9eKU1Jfgu1rgWNgenGZKlT16w9paSg8jg+F/oRHx2wvEgKj4QTQjfBlheO7QZtICKpbjA9f3e+p4o8El6STjRXmNn3Un8LozjR1tZIQaj8UvHYHPc5LrGZM6nqRkvRyKyDwdaFDfhf+V291WcavC/BGsmmio1Q7oq3kenyCr8DE97jbIqwnbZMw5Wg/ehxQoHKHIcaRbdh1SfbJV0Wq9yxerPpWe18+la4CAa6zmg2aNQjri2/TKZzbmNVkdAff52YaZE0T19jmDVbRdq+nGChYVJa7FYyHRdoD2jgrZ/g/2VdrPU8bTq3+UDK/2gO8VTe3aHvngvU0Bc7ymnTXIm6ooZrjE1mKyo3Uw5hYOr30vJpxHqtwsJlAyJRo/cUNo/rhArryo33uGkrehaoWjXwX6sHFABH5aVBCTieZfL2e+m+lzNeLMJXjpzAiRS/Rn8yaD0VI5K6YgLJb/qgOhoIUrTwQl2rOILtjYXOu8kjak4IDAdI3Sq+oj/qRR+L9+VNYEE/sulO2Gjn7+vSKZQ5m2CuoNLTXv6UrOH5aK3+ZdC1lao/CWA8BUBokWdbtOQ2tmXjluRhPhrGOeLq1jmjYOspemugjsLAcwjnm1Hi9YXNPwcIGu5ZstZ2nXRHWQ/x23g8sugeamw3FNkYzQE5f7rWufLUm93lDYEBCQX7763y6CN4p/tBS6466+XnbrHkmu3DoDRRcJlZlKmMXJzrCEJRkNiuTFzI0OdJafCgmo0rtS2gx9jDV6kqaaDWS3dMiev/iOuLdSqcIwqAit8Lg2zB+Vcy58JOIxtsZa9wJ5MQ1vVcIcmKhCf/11nkyIjlQfxNoRoAxM6OdfrJv22j8kJ3pnAvTqJ/lTBCogRjMPLOggckFIXAFJTUaA1kgFHM3bIK+8vcKk6z3Erh5A4Ma4GXL/qqAf5YkBZfUNgUwRISZHoZEGnKQVMOuNQdqTXHJHcS/p0QrBvlka/DyXUkS+7NjmUQt6y49XVRTS02dLdGAGMazuB,iv:JO+1RLEEMRCwzhyTTgWcUeeo4QOLYo+I1jPEifX5geA=,tag:rVo+N/M+J6puCBWp6aw+0g==,type:str]
                healthcheck.config: |-
                    [healthcheck "auth"]
                      enabled = false
            secretRef: gerrit-secure-config
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBuUzA2MENQdUNvMnFRTHVS
            UVVUUmVtRWErbW05YTk5eUdpbGNRUzdLRDJnClRkV2pUb1BHdUFzanBhYm16Y1dr
            T3lQYURPRVRNbTAwanlnSEF6cEZ2SjQKLS0tIHJIbmpPbUNHbkRnVS9hV3pXKzZX
            dytaTjR0dVF1ODlCVndOYTRMUjZ2YVUK8YQeJ4OMG2ukM07Ib1fYsuftjrndBGzJ
            yC95WMYhRaUTiwxemnVPerUWYQwZtdrTWMP87TEjnv+l6H3t4tGeQg==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-12-20T13:27:08Z"
    mac: ENC[AES256_GCM,data:eXnrGaJmpHYkgn5+3bJvEC4hbRp2Uenjjzmo3c9JIkjNOM1DUnVgGjOk08MrnfYVLXIiDRYThr6/7++SDP5Z0obvqFEJaLeJdfe4XaZTejjlP4cyKqbzyegWyVZbcWvpCFSIirisoYbhAleqs+ahTI7gwrmCpjmYqLwpuc1a4eM=,iv:y/Juyetdjzk/lQ3saDYOhItBGUXRbc0juaUJMw4b5DQ=,tag:jTalmGd/zwGmsSBaNvRWnQ==,type:str]
    pgp: []
    encrypted_regex: ^(gerrit.config|routing_key|DATABASE_URL|SMTP_PASSWORD|SECRET_KEY_BASE|admin_password|extraCommands|key|clickhouseDatabaseURL|databaseURL|client_id|client_secret|secret_key_base|otp_secret|private_key|public_key|primaryKey|deterministicKey|keyDerivationSalt|token|clientId|secretKey|installationId|installationKey|uriOverride|adminToken.value|password.value|sql_password|erlangCookie|AUTHENTICATION_PASSWORD|ROOM_API_SECRET_KEY|adminPassword|configPassword|adminUser|configUser|MAIL_PASSWORD|APP_KEY|api_key|api_secret|keys|livekit_key|livekit_secret|secret_key|admin_pass|admin_email|mariadbPassword|mariadbRootPassword|privateKey|data|stringData|PASSWD|password|pass|postgresPassword|postgresqlPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret|admin_token|integrationKey|rootPassword)$
    version: 3.9.1
