apiVersion: gerritoperator.google.com/v1beta13
kind: GerritCluster
metadata:
    name: gerrit
    namespace: gerrit
spec:
    containerImages:
        imagePullPolicy: Always
        gerritImages:
            registry: ghcr.io
            org: mtrnord
            tag: latest
    storage:
        # Which StorageClasses should be used
        storageClasses:
            readWriteOnce: ceph-filesystem
            readWriteMany: ceph-filesystem
        # The shared storage will be used to store git repositories, logs and other
        # components shared between Gerrit instances
        sharedStorage:
            size: 1Gi
    ingress:
        enabled: true
        host: gerrit.midnightthoughts.space
        annotations:
            external-dns.alpha.kubernetes.io/hostname: midnightthoughts.space
        tls:
            enabled: true
            secret: ENC[AES256_GCM,data:n4kSoKEz072gaeJ8UhzZ4iGjGLdAvA/+lQW4xnxQ+Zf4,iv:f1L0rj7Z8x14QeNooqSOWq+lSG7HE20jD8ogvMVXoOk=,tag:QBuamE/ESN+KBPCutPD+8Q==,type:str]
    # All Gerrit instances in the GerritCluster serve the same repositories and
    # thus have to use the same serverId, which has to be set centrally here.
    serverId: midnightthoughts-gerrit
    # List of Gerrit deployments to be installed in the GerritCluster
    gerrits:
        # A primary Gerrit
        - metadata:
            name: gerrit
            labels:
                app: gerrit
          spec:
            mode: PRIMARY
            replicas: 1
            resources:
                requests:
                    cpu: 1
                    memory: 5Gi
                limits:
                    cpu: 1
                    memory: 6Gi
            service:
                type: NodePort
                httpPort: 80
                sshPort: 29418
            site:
                size: 1Gi
            startupProbe:
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 10
            readinessProbe:
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 10
            livenessProbe:
                initialDelaySeconds: 120
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 3
            plugins:
                # This way plugins are installed from the Gerrit-war file
                - name: download-commands
                - name: delete-project
                - name: replication
                - name: oauth
                  url: https://gerrit-ci.gerritforge.com/job/plugin-oauth-bazel-master-master/lastSuccessfulBuild/artifact/bazel-bin/plugins/oauth/oauth.jar
                  sha1: 005ff9ae2f724c3bd4cd6f4259ee9c03b4ce88a5
                - name: branch-network
                  url: https://gerrit-ci.gerritforge.com/job/plugin-branch-network-bazel-master/lastSuccessfulBuild/artifact/bazel-bin/plugins/branch-network/branch-network.jar
                  sha1: 0064a6133b72684ccecf5038e61b23457bacab43
                  #- name: replication-status
                  #  url: https://gerrit-ci.gerritforge.com/job/plugin-replication-status-bazel-master/lastSuccessfulBuild/artifact/bazel-bin/plugins/replication-status/replication-status.jar
                  #  sha1: 5eb04d2238ce7d130d8b9cf0cd79f14e68e7ddfd
            configFiles:
                # Some configuration options are specific to the k8sgerrit setup. These
                # will be set by the Gerrit Operator.
                gerrit.config: ENC[AES256_GCM,data:7QbThuvByZzMLRys8eC65wiPbqv8k9866KHqnzPO15RisvUUlDnolYMkKgpsKHnV7dyBf49Dmq4SgTZ9vyZk9PLi8/WJEczCv5SlmEaqcLHJ8WTor1B4FJlrj3tMs9G4/dgOvo3DElcFtRJVlnW5B9XvCZIrUd7E9rAhqGKCFDnZGRbvpyPB0zGVEDSwDuqZXKEQZ+nDaTn2SRoJlcSwrIOgkkuOx7v8kDUgf84qt3+kK6MU8pf3bCSurJTIOVrGZk37/FsHrsFT+2UUqSI5ZjpUE88P9OLof2UfDC01sx8aVFnKLtvSMUJ1qCHqcjMBzXzm9Ayr11bozzCAXSfVarFUOJdtmQkkTBUE+Ld+SlqQGXgiGuYPN5QSusUIarUd7xAuYVVk+9rjwPb+C+Lve8HcObAuevOyjcLbOANtDrCdbM1nkdqEYxMtqggs2CUDae/eysfX1q6iNjRLw/XUa3SJu38fCXF4HHDBEOczhxAYpFd4ftyP3LELVf7kMOa+vgtVkEp+ZWM8zWAJoLsiQngh2kM3pZibyEJuTkGyVkxYoGHlbXs7LwtjiN/U6vCAzLM7QG7sCor8oGFD6+IaZSq39ts97CsIOy9ULKBG8W7pnEWYNMJQCkbQvSB3VBsJu9pEbp3V23wcNkuJMaer43tCZiwykQEn2R5EocBDq2ymgR67BcZfDJNgofmcGFBMO3vaCfTa5hRq6c96lsR8rs27RYXrlEEJPl9kmKfLjLIzmRY3lKI4bhA40gSuJ573bl5A42H1bVgkvjBkahNz+LmHZItzNgLWh+BIWXsBrNcc+mstVMWekOM4jo3VXbfuBZE7ShIoaqyUG7c+YGVWhP1h4w/dSZ1JZC3Q2yp4tzbiWtMkMDmF21hcDNAZp7BMS6fKfO0Hovn/bYPNhM3ETIMObTdgkRr3P2EtC/J1rh1f2mLYeEMQ8E/wnTBBowwcNgPJVjsE2OFE58J+LEa97PND93eO+ikZD5ddDTl9C5E9oXG9cdLuncMQLTb4GPqIKZP4ApK+61ddqJAHgo0i1vEcBNNPEqWfqpwUo2QwmitFZHxMQdRIZNCiMMuSgIlTjSTLaRPHp2CprNqQ04ubbyEUq99XniP04PNks997iI2yZi8//Yq0SYi8oFUoA1Rca9n9QIacbiVXrb1Rc9ZAcMW8xDf932NWLg73DfGndWjlbSCwM8SJfon87IjgUNdqXb+06IRfgMHc2vn4pCtxoTyw2z3tpFkzR9ZEd0MoD837k48ht5poVmYMfo9/YbVqAwAjhTrLs1R49jSSUvPnw9wbcaO/jtMbwypMRQf5yFRegs+do5qnc6crCtqm07nBuHdWW3z4mFbi+q0KV5nWY1lHgHXNsUbd207xi6RiaTc1yii8ewEp6vWQNokbWApT0BcmTbbvo+LY0cjqnmV0dG9LePdLcqiTltWOw/JzRe4H7ymTsXmX8tJNQE7K+EPbR81/1ggoqG2ys5/tOls9hEo1cl2pFb+3lUEE2nx76ht2j6P/Df0DW8mObuvRZNu/TjnfYRNDOH17AckA0ROd9LjiE7hF1mrQXaOZBZu9yvG9WeYcCb5U7kTVwl8N0Xx7l3nQqOTdDe3g8KCwLBjQYIx9uyD2jyDYdDFDzGpONsxFtlzkbz1aliHjOA==,iv:oOAmcsWbqHeJZvfTdsdkZBD3miztRuzFRljAHD6kih0=,tag:Ur2FtnyObK/nSieZuVwrsw==,type:str]
            # Reference by name to the Secret containing secret files to be mounted to
            # $SITE/etc
            secretRef: gerrit-secure-config
        # Gerrit Replica
        - metadata:
            name: gerrit-replica
            labels:
                app: gerrit-replica
          spec:
            mode: REPLICA
            replicas: 2
            resources:
                requests:
                    cpu: 1
                    memory: 5Gi
                limits:
                    cpu: 1
                    memory: 6Gi
            service:
                type: NodePort
                httpPort: 80
                sshPort: 29418
            site:
                size: 1Gi
            plugins:
                - name: oauth
                  url: https://gerrit-ci.gerritforge.com/job/plugin-oauth-bazel-master-master/lastSuccessfulBuild/artifact/bazel-bin/plugins/oauth/oauth.jar
                  sha1: 005ff9ae2f724c3bd4cd6f4259ee9c03b4ce88a5
            startupProbe:
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 10
            readinessProbe:
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 10
            livenessProbe:
                initialDelaySeconds: 120
                periodSeconds: 10
                timeoutSeconds: 10
                successThreshold: 1
                failureThreshold: 3
            configFiles:
                gerrit.config: ENC[AES256_GCM,data:o3t7XrDlv4EHLyM5Wf9Xoio7zT0frzs303LvuD/mxfVWzROSS3o7KW0Njf0EU5GaH4V5cw0ejWATtRddUijfKhz8dLQxE4dRamr6pMFcVIJrDtOF6uYJijP0DUkqHUAvC8eeieOQ4JTdG2h3yBcbOhwQrsXui/PxNkTo7uVTAX7HoECdn2tP76kVx71YCBm4KSurZUBUKrCJKLwYt0AcXnGLh4lyucfWFxDvG1XdGDlK4Exec5jLClrkMB07fZRshNP5cJaAWprWyqtegfAezse8K6UPHMfS172udn1UI9vP6KEYMNdPqodGocGRvRLc0ASa97sTZ7jeImnL/18UIbkjnG05Hx412PcHAkC3SepT1vBrUCcYODW/BVy91J5TriQbx3kzBoK6ci3A0FuONdicuChN57OjcNAm5XAf7Ft6yEqcTMPZsqSG34WL7yNPwLyUac9HXjdxqXhTplfPGn2aflOhE9N5EWEJLhZYpTVLFYmHFrzGYhAad9F31ksJa5Zhv15sLa3UCRiBN7Z4/rOiRNb5U7eiFNhosLl+/aeDoBXch2ooCnrPdoifNE2fKYjweTkeMFKvdFKNpaz2vv+KaILZ19aykvKCRUJo2cy/dCALd0bXZNLPeo9SfmEgt29NTkqPDUXxP2xFrfmFPhNgCC/YLM54Z3kEz/uGC4r841GVOEGBPL4icVNpwrRUdu6EDOrNA96JcV+3zKojwXzRNIqvYDaqiR7FxjA0z+X+mxq8CnfjrKgH94hDDZqvOit9mvyfqUJwt5murwEFIfS1sz+up7zFkKBcwMFof/tQAneiOTn7JiATqLqW92JAJxn00kw2NH62wzJtJylTbHwOIdnAKT0Jr4XhkpGse5dFAXAWZoHi3z0vflmpuqQjE5vlpEwwCd5wV1tMjzopa9bkAh7qIgBd9SyqoofXUypczexBFfCMyadSed3fRWevH5lS6/SlHGfNP6o5Dgsh7znqHyPk21Rjf+pDxAOB8rM8DTpOuPynvc5SVU4QPxhdk1o8u6HjMzB4YXlTu7M0n6E2/LZxY/5iaxArA/to71qyzXBL18HFxwtgdhYlgiwXfMIa5RmXILBOLuWUejva8+CfZVdO5SzKFXyoErgsw8p2KBwWypSZZu77BUuPmctgBJp/kUsnEBNwM1OdrswOe6aB6t63+0/Uh8Ga9VikVHddIIXD7WhIXwbBeo87VGooWXHuvfNcx2CjJPMcTzzGtTghM2rYAYOhMjhQC6mIh0DhLNV5rt1GNXN/5SzkPuOW8ChJ17FhdqGzRQ/ZLahhaYnArW4yOJqhlCVPqtw1X8Xwc5VwoM6+aLRh7rW6YymqDybZLFu8eHCtKGg8m2hxT0FOcNxzWLe7r+o4yYpN2Uc/VM12SKbh4p08RnIVuk1/HZX2GvBD9+gqgl2JafzVM76nbfNE+RdOvBrJuUGZufSAaWS5pyjyjt+72dQv4ZRvP2dwQXpkehhvZWQAV0ZarBepW19vDmB2nVrtNJWqFBLqgsLmfM4Cv/Pt6lqISmSHHFORLnGSfCSjrsWINJVyVZwqBv6I0qb/aS08Ivp80v2n7FEbtnYyJZbZZqJJ9GIm0+B71wJ10ce7Cb0wol2xVLdeDa0I58b5dvKLU+4eFh2TmC+lIRes+Q3P5w==,iv:efc/AzRW1yruIlgM7xhOniYXucekG3GSsY4/p+p6RPM=,tag:sHJ7kg702xgN+r69NJ2KzA==,type:str]
                healthcheck.config: |-
                    [healthcheck "auth"]
                      enabled = false
            secretRef: gerrit-secure-config
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBMMmN3bXVDMFRaMHB5RmhU
            RnhGbDVOTDZZeURnS2FMSVIwUjk3WlFud0N3CjdFOEFuME1PRXU1enlYeDM0MmFr
            VFl6YzhGbkFFb2NVOWFEbDZhUi9ESG8KLS0tIGExYXc4T0tBdGg2NW1sbGtNa0Zm
            ajVVOXk2V0twUlFFdjlHa3NxMGdmTTAKcaFtOkil2JYRW92+JBEAGc6FZovQ7HBD
            BRuTKEj8bZ6xBsYsTX+RdNX1/d81BuivQdoboA+nadN0achNZBSCfg==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-12-20T13:17:51Z"
    mac: ENC[AES256_GCM,data:yS86iRzYFigAIg4dhABD9T1vlyG9NWYv7fWBAOmhdrbPWAleTfZedxPV1oJbI6eN+MkNrwV6nvmoinRoiDdWDAv98X0XfzFH4Dh1K4IObj/jHZqRdSBRJFd5bIQ4pkkVALD9cwtN91etOof3/biFl//wo+dXIXUNqsSyipCi9Gg=,iv:p1n1B7FLS+KOWg398Rf6n5BwWO/hHhScuVCJduChsHE=,tag:LBLfEOnd3oBeNOd8JgyMZA==,type:str]
    pgp: []
    encrypted_regex: ^(gerrit.config|routing_key|DATABASE_URL|SMTP_PASSWORD|SECRET_KEY_BASE|admin_password|extraCommands|key|clickhouseDatabaseURL|databaseURL|client_id|client_secret|secret_key_base|otp_secret|private_key|public_key|primaryKey|deterministicKey|keyDerivationSalt|token|clientId|secretKey|installationId|installationKey|uriOverride|adminToken.value|password.value|sql_password|erlangCookie|AUTHENTICATION_PASSWORD|ROOM_API_SECRET_KEY|adminPassword|configPassword|adminUser|configUser|MAIL_PASSWORD|APP_KEY|api_key|api_secret|keys|livekit_key|livekit_secret|secret_key|admin_pass|admin_email|mariadbPassword|mariadbRootPassword|privateKey|data|stringData|PASSWD|password|pass|postgresPassword|postgresqlPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret|admin_token|integrationKey|rootPassword)$
    version: 3.9.1
