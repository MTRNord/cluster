apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: element-call
    namespace: element-call
spec:
    interval: 5m
    chart:
        spec:
            version: 0.1.14
            chart: element-call
            sourceRef:
                kind: HelmRepository
                name: element-call
            interval: 60m
    install:
        crds: Create
        timeout: 25m
    upgrade:
        timeout: 25m
        crds: CreateReplace
        # Force recreation due to Helm not properly patching Deployment with e.g. added port,
        # causing spurious drift detection
        force: true
    values:
        livekit_key: ENC[AES256_GCM,data:hgwBX/xTh39LdWu5vBrNdyuTAYHdit0aHFNrt+QZ/NAMcK3zI+D+K/u/uuJx2UeDj93GKjbIdjWb5zFR7Ld4vA==,iv:cfOcIArR59wDjuJkr1wxliKoht6qdCe8zps3D0TDux0=,tag:4Sk5tvNhbMrUpquh5h3qFA==,type:str]
        livekit_secret: ENC[AES256_GCM,data:nCCzUSp/Bj7oh+oP7o2a4uZE1TBpiUyIND0ZcKGywBmjbB0/kjJm/oanwQqMwE2mrf50P5ojVcVIcb3fXb5+lg==,iv:tbZmKbiamY7pT+v4f2tTb2M+Mj1WlGa/UI8FxXUfFLo=,tag:d7LuoKE3Vx64itBVUfavXw==,type:str]
        livekit_ws: wss://call-livekit.midnightthoughts.space
        livekit_mgmt:
            ingress:
                enabled: true
                annotations:
                    cert-manager.io/cluster-issuer: letsencrypt-http
                hosts:
                    - host: call-jwt.midnightthoughts.space
                      paths:
                        - path: /
                          pathType: ImplementationSpecific
                tls:
                    - secretName: call-jwt.midnightthoughts.space-tls
                      hosts:
                        - call-jwt.midnightthoughts.space
        element_call:
            replicaCount: 1
            config:
                eula: https://example.com
                homeserver:
                    base_url: https://matrix-call.midnightthoughts.space
                    server_name: matrix-call.midnightthoughts.space
                livekit:
                    livekit_service_url: https://call-jwt.midnightthoughts.space
            ingress:
                enabled: true
                annotations:
                    cert-manager.io/cluster-issuer: letsencrypt-http
                hosts:
                    - host: call.midnightthoughts.space
                      paths:
                        - path: /
                          pathType: ImplementationSpecific
                tls:
                    - secretName: call.midnightthoughts.space-tls
                      hosts:
                        - call.midnightthoughts.space
        livekit-server:
            livekit:
                keys:
                    bQXMwwlTCTbxDd6xRHYaaK5gzOzyb1gzS5E89vrJ96ONp3kEH4Ljh9su5L3BQc33: ENC[AES256_GCM,data:a0Ho8zXZ/PTvVGHulgVGoPX25aPdSXphpnQTqn7e1rvRpX1wCE/DVODQr759T4XiVowGuF+2DsXpj/yT6a7tUw==,iv:LjLl//pMBh0ZVZE0oclUxne1Frtf6V8OBO3PudSvhgw=,tag:6dc1YOd8V33KDJw9eFcGvQ==,type:str]
                    iHMQVcTZSmUek9m55nFcvpGWaAR1nGpQggvEmvKyWqWbu099EjSZ2sQkU1ZMpR1h: ENC[AES256_GCM,data:e2zwg47K+S4zUBDYukzwWw3GY1HbvHe5u6H5sTjdnc36goEnTl5QpYWRvRWbmALHRrOMjEipxBOprAK91L4W8g==,iv:N+IUz+n0hKcsrJLMC19moxwtflyfuumsT6iQk5e0QMc=,tag:CH/m0t7JhZlQOQoZwzo1sw==,type:str]
                redis:
                    address: element-call-redis-master:6379
                    db: 0
                    password: ENC[AES256_GCM,data:Bkqv6vlv1DkOV3rVrW+78hyeuvirz8YimtIQXRB1jeMIvun7i/9zWZPpZ9uBJzH0D6okZrIwMEz7Un0EQ6Ar+w==,iv:IrwrfFaj2yNjp/xKoKbLYtrOzJalqWiT8B/ONrwsEP8=,tag:Wff9HM1yMmr01Z/2ECVQ1A==,type:str]
        redis:
            auth:
                password: ENC[AES256_GCM,data:jVnwCDBbvgHINJ7Poz9oQLiMkXjhl0d/XD+jQcCn7aJMRjc3OSF6bIhMu4Q+8HZLXU/VluR9Pxfj8pREzdA24Q==,iv:I214aG/5q9d332bZbMHShv8+znFXs3UjDlb3Aoftz0M=,tag:ZYfXq0opkIYDap6Tvi1BRQ==,type:str]
        egress:
            egress:
                api_key: ENC[AES256_GCM,data:RbZ4sWA/UP1rlWwNLA6lYulB0mEnED0PGfptsd/+2ovzum0Famk3HqEjAuduIazAZmeXwK/D/pR++/qRDfxnQA==,iv:mgmRZT7AZ3egZjZcE2+U4onm/e1UE1UJjYUHR2FeTkU=,tag:QrKE8xGOWQ4TCynSRB+wKA==,type:str]
                api_secret: ENC[AES256_GCM,data:CgowY1z7DSg7q7WQuKXEI4DFW/aLWAbAEm/FNsoJsRKWUFvohjYhWxOmPfcJvkwG59nLu/SAAevvs8uFoSfJ4g==,iv:56dRTwTehMXr1eligsLiZ2fXSNwtu2HicGGGy5g316A=,tag:vl6McElumf7FF2walXxd7g==,type:str]
                ws_url: ws://element-call-livekit-server:7880
                redis:
                    address: element-call-redis-master:6379
                    password: ENC[AES256_GCM,data:gOhIhr7kFAvJXSpC1A9w+c/Sz2G9um8EPbDZTnjDjySZCRwfYVgQ1zrEcom9WexUbWFCKR3PAvWXNb9HiK/AyQ==,iv:3/6+qjBo1ANabddeSsORSW0JGb8SvKPOFT5oZYi4bRk=,tag:lh7z8oW/i48eVTCDzn5Jjw==,type:str]
                    db: 0
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBmblhnaWR6ekFVKzVRb2FK
            MWZCdGFjVFgwaWRMcmdxcVZkU1JrRlVpOFU4CjdJTmhqMlorNlVZV0V5TU9pd3Bo
            WFhSU2QrSmJNVXA3K25hYUdnQnJROVUKLS0tIFdQMmE1T2E0aGEzNFArWWk5dHFB
            Y2pGVUVFT0ZBK29yZUoyVktyMVc0UmMKOUZdMJoWSOWS8DHGev0pY0PQLjYCDNo/
            uO7LUyAZa0h/9ylfoMPmhmloLv8nu7+N28h1MMyQ4V3zNlQmvhpwaw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-03-06T13:20:25Z"
    mac: ENC[AES256_GCM,data:bJcR8+wP24b1obxgvlmckBpwpgjyc8cWky3Bngr2nou95qUE4B+CayoOBA0gaq5YcWtfzaoONxked8Hivsgw/uzDgC73gCAJveSWC7gZZ1z+e6ZFuGGVdUB7kDvNV7jWvt8xGbswj/4YQTNazC9U2h1U51Qop8XPX+LevDRKZQY=,iv:Y9GUZO2XKS5uju9EcLUcnwwxCpXKAmGTjXA980jBXF8=,tag:YtK2Y9qUBV+2EefEpRID8w==,type:str]
    pgp: []
    encrypted_regex: ^(api_key|api_secret|keys|livekit_key|livekit_secret|secret_key|adminPassword|admin_pass|admin_email|mariadbPassword|mariadbRootPassword|privateKey|data|stringData|PASSWD|password|pass|postgresPassword|postgresqlPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret)$
    version: 3.8.1
