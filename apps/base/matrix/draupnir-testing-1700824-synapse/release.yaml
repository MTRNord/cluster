apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
    name: draupnir-testing-1700824
    namespace: draupnir-testing-1700824
spec:
    chart:
        spec:
            chart: matrix-synapse
            sourceRef:
                kind: HelmRepository
                name: ananace-charts
            version: 3.9.x
    interval: 50m
    install:
        remediation:
            retries: 3
    values:
        extraConfig:
            allow_unsafe_locale: true
            use_presence: false
            presence:
                enabled: false
            event_cache_size: 10K
            caches:
                global_factor: 10
                expire_caches: true
                cache_entry_ttl: 240m
                cache_autotuning:
                    max_cache_memory_usage: 2048M
                    target_cache_memory_usage: 1024M
                    min_cache_ttl: 5m
        wellknown:
            enabled: true
            client:
                m.homeserver:
                    base_url: https://matrix.draupnir-testing-1700824.midnightthoughts.space
            extraData:
                support:
                    admins:
                        - email_address: support@nordgedanken.dev
                          role: admin
        persistence:
            size: 250Mi
        volumePermissions:
            enabled: true
        synapse:
            strategy:
                type: Recreate
            ## Liveness probe configuration to use
            ##
            livenessProbe:
                timeoutSeconds: 60
                failureThreshold: 5
                httpGet:
                    path: /health
                    port: http
            ## Readiness probe configuration to use
            ##
            readinessProbe:
                timeoutSeconds: 60
                failureThreshold: 5
                httpGet:
                    path: /health
                    port: http
            extraCommands: []
            annotations:
                prometheus.io/scrape: "true"
                prometheus.io/path: /_synapse/metrics
                prometheus.io/port: "9090"
        externalRedis:
            host: draupnir-testing-1700824-keydb.draupnir-testing-1700824.svc.cluster.local
            port: 6379
            password: null
        redis:
            enabled: false
            usePassword: false
            password: null
            auth:
                enabled: false
                password: null
        postgresql:
            enabled: false
        externalPostgresql:
            host: postgres-cluster.postgres-cluster.svc.cluster.local
            port: 5432
            sslmode: require
            database: draupnir_testing_1700824
            username: draupnir_testing_1700824
            password: ENC[AES256_GCM,data:F/pzYh5crI1dwuRV44jafGvgONNh7ZQenkqYdI/LqqDde1pJNPL6rWULBftoPTmTvVrwzlaNyNkh3Qc2IE03+A==,iv:QOtYY+0osYfq7392jUPCtcQ1cwlAKI3496/2mZwEuIA=,tag:ayJ3siCWcgTfKlCZdMqLzA==,type:str]
        signingkey:
            job:
                enabled: false
        serverName: draupnir-testing-1700824.midnightthoughts.space
        publicServerName: matrix.draupnir-testing-1700824.midnightthoughts.space
        config:
            reportStats: true
            enableRegistration: false
        ingress:
            traefikPaths: true
            hosts:
                - draupnir-testing-1700824.midnightthoughts.space
                - matrix.draupnir-testing-1700824.midnightthoughts.space
            tls:
                - hosts:
                    - draupnir-testing-1700824.midnightthoughts.space
                    - matrix.draupnir-testing-1700824.midnightthoughts.space
                  secretName: draupnir-testing-1700824-midnightthoughts-synapse-tls-secret
            annotations:
                cert-manager.io/cluster-issuer: letsencrypt-dns
                traefik.ingress.kubernetes.io/router.tls: "true"
                external-dns.alpha.kubernetes.io/hostname: midnightthoughts.space
                #traefik.ingress.kubernetes.io/router.middlewares: default-hsts@kubernetescrd,default-compress@kubernetescrd,default-redirect-https@kubernetescrd
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSA4eElxS1d2RE9lam9DNG9x
            UHhoZ3VrellWY1lubmZHK2MrOXRyNWYvMEFFClczbTNFNmVNQm16NTdXWW0zR3Zy
            Q0Raam9uam41eFFXZDVxd25qc3RDYTgKLS0tIHpKdDdaMEpabWx5YzV6NXpXbHZP
            MFdzQi9pVjZLbHI3Y29ySlUrQjJUUmsKtPV7/qERGmj9sBcehCZUzsX/0l7vLjsj
            3MA2b8fJr7fIP3EtiRtEV6AEsfIN64WXYbyk/FU9+m7+oyCvOEBx0Q==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-08-17T10:34:24Z"
    mac: ENC[AES256_GCM,data:N9HR7IyoHP6eERRzKLsJBOCs9JNzNZ5caYdtSn2ZH0V88keJqnhJGYMPc6smkWHK8jfN9kHaGbIXxdlXuhdTJ/etgZ++xVUn5quoJj/pxIeUhbSdT3ZZUhGJejJ7OAhH/XJCqBwKUkfSs6z52Ryc6IhEH52Kj76Ji66oJ2pPjXI=,iv:V01s1ZxqaaMs90BhS21hpHw2rtPoK6vCVWcNPvb23so=,tag:RpRf3eziW9rmlfJrGtOqvg==,type:str]
    pgp: []
    encrypted_regex: ^(admin_password|extraCommands|key|clickhouseDatabaseURL|databaseURL|client_id|client_secret|secret_key_base|otp_secret|private_key|public_key|primaryKey|deterministicKey|keyDerivationSalt|token|clientId|secretKey|installationId|installationKey|uriOverride|adminToken.value|password.value|sql_password|erlangCookie|AUTHENTICATION_PASSWORD|ROOM_API_SECRET_KEY|adminPassword|configPassword|adminUser|configUser|APP_KEY|api_key|api_secret|keys|livekit_key|livekit_secret|secret_key|admin_pass|admin_email|mariadbPassword|mariadbRootPassword|privateKey|data|stringData|PASSWD|password|pass|postgresPassword|postgresqlPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret)$
    version: 3.8.1
