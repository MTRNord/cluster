apiVersion: v1
kind: Namespace
metadata:
    name: rook-ceph
---
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: HelmRepository
metadata:
    name: rook-ceph
    namespace: rook-ceph
spec:
    interval: 24h
    url: https://charts.rook.io/release
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: rook-ceph-operator
    namespace: rook-ceph
spec:
    chart:
        spec:
            chart: rook-ceph
            sourceRef:
                kind: HelmRepository
                name: rook-ceph
    interval: 60m
    values:
        csi:
            serviceMonitor:
                enabled: true
        monitoring:
            enabled: true
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: rook-ceph-cluster
    namespace: rook-ceph
spec:
    chart:
        spec:
            chart: rook-ceph-cluster
            sourceRef:
                kind: HelmRepository
                name: rook-ceph
            version: v1.15.3
    interval: 60m
    values:
        monitoring:
            enabled: true
            createPrometheusRules: true
        cephClusterSpec:
            mon:
                count: 3
                allowMultiplePerNode: false
                volumeClaimTemplate:
                    spec:
                        storageClassName: hcloud-volumes
                        resources:
                            requests:
                                storage: 10Gi
            storage:
                useAllNodes: true
                useAllDevices: false
                storageClassDeviceSets:
                    - name: "hcloud-volumes"
                      count: 3
                      portable: false
                      encrypted: false
                      volumeClaimTemplates:
                        - metadata:
                            name: "data"
                          spec:
                            storageClassName: hcloud-volumes
                            resources:
                                requests:
                                    storage: 10Gi
                          volumeMode: Block
                          accessModes:
                            - ReadWriteOnce
        ingress:
            dashboard:
                enabled: true
                annotations:
                    cert-manager.io/cluster-issuer: letsencrypt-dns
                    external-dns.alpha.kubernetes.io/hostname: midnightthoughts.space
                    traefik.ingress.kubernetes.io/router.pathmatcher: PathRegexp
                host:
                    name: rook.midnightthoughts.space
                    path: "/ceph-dashboard(/|$)(.*)"
                tls:
                    - secretName: rook-midnightthoughts-space-tls
                      hosts:
                        - rook.midnightthoughts.space
        cephBlockPools: []
        cephObjectStores: []
        cephFilesystems:
            - name: cephfs
              spec:
                metadataPool:
                    replicated:
                        size: 2
                dataPools:
                    - replicated:
                        size: 2
                      name: data0
                preserveFilesystemOnDelete: true
              storageClass:
                enabled: true
                isDefault: true
                name: cephfs
                pool: data0
                reclaimPolicy: Delete
                allowVolumeExpansion: true
                volumeBindingMode: Immediate
