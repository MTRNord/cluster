apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: OCIRepository
metadata:
    name: capacitor
    namespace: flux-system
spec:
    interval: 12h
    url: oci://ghcr.io/gimlet-io/capacitor-manifests
    ref:
        semver: '>=0.4.2'
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSA5MWplckhUTHE1Ym9yNVdp
            MUdMY0kvVmRqTFk0b1BXbTljVCswT3Y2M2xVCjVjT3JMMWJWQWRBVENNVnlSbXNz
            eTQ0czg5NDdXYUYrMy9kUC9OTnZCaDgKLS0tIEFmdEdEMkdYbXA3eURkQy9oclZs
            MTdkclBla2RveGVtQzdLbG1UZmdWcE0Kc/YTjoHpHZEG/xP37UVdHgqYpbA8zdTz
            oO5tI6DrveNvQQy22aQvmeUa2PoJrl7CbTDC7PXDBhFWOJF5FJtZ6g==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2025-02-19T11:22:44Z"
    mac: ENC[AES256_GCM,data:ohg1VEP1CcdFQPa+qTSV4zLEXVrMQXKp9FWzpShinwK7qIsYhctqR3mNV9zbegR3HnCj47EijuD8NZiVPRQYsVblQzQI29AQohyfdhljO89UXdttl9pBmQMRD+zoWundRm/xzs559Lyo4TZomUdM59J7w5vEReRw8SBhytx0de0=,iv:H+/wiSFCVUzKiG569J0l7/JBYaoWxJNiUJNaiLa4354=,tag:9S7Bjdf3IQJljlwLn/xJUw==,type:str]
    pgp: []
    encrypted_regex: ^(adminPassword|adminEmail|jenkinsAdminEmail|securityRealm|gerrit.config|routing_key|DATABASE_URL|SMTP_PASSWORD|SECRET_KEY_BASE|admin_password|extraCommands|key|clickhouseDatabaseURL|databaseURL|client_id|client_secret|secret_key_base|otp_secret|private_key|public_key|primaryKey|deterministicKey|keyDerivationSalt|token|clientId|secretKey|installationId|installationKey|uriOverride|adminToken.value|password.value|sql_password|erlangCookie|AUTHENTICATION_PASSWORD|ROOM_API_SECRET_KEY|adminPassword|configPassword|adminUser|configUser|MAIL_PASSWORD|APP_KEY|api_key|api_secret|keys|livekit_key|livekit_secret|secret_key|admin_pass|admin_email|mariadbPassword|mariadbRootPassword|privateKey|data|stringData|PASSWD|password|pass|postgresPassword|postgresqlPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret|admin_token|integrationKey|rootPassword)$
    version: 3.9.1
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
    name: capacitor
    namespace: flux-system
spec:
    targetNamespace: flux-system
    interval: 1h
    retryInterval: 2m
    timeout: 5m
    wait: true
    prune: true
    path: ./
    sourceRef:
        kind: OCIRepository
        name: capacitor
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSA5MWplckhUTHE1Ym9yNVdp
            MUdMY0kvVmRqTFk0b1BXbTljVCswT3Y2M2xVCjVjT3JMMWJWQWRBVENNVnlSbXNz
            eTQ0czg5NDdXYUYrMy9kUC9OTnZCaDgKLS0tIEFmdEdEMkdYbXA3eURkQy9oclZs
            MTdkclBla2RveGVtQzdLbG1UZmdWcE0Kc/YTjoHpHZEG/xP37UVdHgqYpbA8zdTz
            oO5tI6DrveNvQQy22aQvmeUa2PoJrl7CbTDC7PXDBhFWOJF5FJtZ6g==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2025-02-19T11:22:44Z"
    mac: ENC[AES256_GCM,data:ohg1VEP1CcdFQPa+qTSV4zLEXVrMQXKp9FWzpShinwK7qIsYhctqR3mNV9zbegR3HnCj47EijuD8NZiVPRQYsVblQzQI29AQohyfdhljO89UXdttl9pBmQMRD+zoWundRm/xzs559Lyo4TZomUdM59J7w5vEReRw8SBhytx0de0=,iv:H+/wiSFCVUzKiG569J0l7/JBYaoWxJNiUJNaiLa4354=,tag:9S7Bjdf3IQJljlwLn/xJUw==,type:str]
    pgp: []
    encrypted_regex: ^(adminPassword|adminEmail|jenkinsAdminEmail|securityRealm|gerrit.config|routing_key|DATABASE_URL|SMTP_PASSWORD|SECRET_KEY_BASE|admin_password|extraCommands|key|clickhouseDatabaseURL|databaseURL|client_id|client_secret|secret_key_base|otp_secret|private_key|public_key|primaryKey|deterministicKey|keyDerivationSalt|token|clientId|secretKey|installationId|installationKey|uriOverride|adminToken.value|password.value|sql_password|erlangCookie|AUTHENTICATION_PASSWORD|ROOM_API_SECRET_KEY|adminPassword|configPassword|adminUser|configUser|MAIL_PASSWORD|APP_KEY|api_key|api_secret|keys|livekit_key|livekit_secret|secret_key|admin_pass|admin_email|mariadbPassword|mariadbRootPassword|privateKey|data|stringData|PASSWD|password|pass|postgresPassword|postgresqlPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret|admin_token|integrationKey|rootPassword)$
    version: 3.9.1
---
apiVersion: v1
kind: Secret
metadata:
    name: capacitor-oidc-config
    namespace: flux-system
type: Opaque
stringData:
    client-secret: ENC[AES256_GCM,data:2OHoGu7QVjr+ZuG4dIMRLdCiyCwNLRfNL5iubzSxpwaKl7HebV6roRzZXyGryzbzzRxN/86b/T4A52+BZ1/nNJh1Y1VQ0tPsv+ObLmvcLKznlsurfrBPI/gwl1qHp3/4nArFN3aNM7IrTdkYzVRZJgNF0S9+DuEMRbsStIFYhhQ=,iv:Oa6mDTZXzE1/Vrhrl6wGc5xdS6f1AKJDyLO+0SpWDGM=,tag:LP00RrjGce1MivOtJ9oV+A==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSA5MWplckhUTHE1Ym9yNVdp
            MUdMY0kvVmRqTFk0b1BXbTljVCswT3Y2M2xVCjVjT3JMMWJWQWRBVENNVnlSbXNz
            eTQ0czg5NDdXYUYrMy9kUC9OTnZCaDgKLS0tIEFmdEdEMkdYbXA3eURkQy9oclZs
            MTdkclBla2RveGVtQzdLbG1UZmdWcE0Kc/YTjoHpHZEG/xP37UVdHgqYpbA8zdTz
            oO5tI6DrveNvQQy22aQvmeUa2PoJrl7CbTDC7PXDBhFWOJF5FJtZ6g==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2025-02-19T11:22:44Z"
    mac: ENC[AES256_GCM,data:ohg1VEP1CcdFQPa+qTSV4zLEXVrMQXKp9FWzpShinwK7qIsYhctqR3mNV9zbegR3HnCj47EijuD8NZiVPRQYsVblQzQI29AQohyfdhljO89UXdttl9pBmQMRD+zoWundRm/xzs559Lyo4TZomUdM59J7w5vEReRw8SBhytx0de0=,iv:H+/wiSFCVUzKiG569J0l7/JBYaoWxJNiUJNaiLa4354=,tag:9S7Bjdf3IQJljlwLn/xJUw==,type:str]
    pgp: []
    encrypted_regex: ^(adminPassword|adminEmail|jenkinsAdminEmail|securityRealm|gerrit.config|routing_key|DATABASE_URL|SMTP_PASSWORD|SECRET_KEY_BASE|admin_password|extraCommands|key|clickhouseDatabaseURL|databaseURL|client_id|client_secret|secret_key_base|otp_secret|private_key|public_key|primaryKey|deterministicKey|keyDerivationSalt|token|clientId|secretKey|installationId|installationKey|uriOverride|adminToken.value|password.value|sql_password|erlangCookie|AUTHENTICATION_PASSWORD|ROOM_API_SECRET_KEY|adminPassword|configPassword|adminUser|configUser|MAIL_PASSWORD|APP_KEY|api_key|api_secret|keys|livekit_key|livekit_secret|secret_key|admin_pass|admin_email|mariadbPassword|mariadbRootPassword|privateKey|data|stringData|PASSWD|password|pass|postgresPassword|postgresqlPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret|admin_token|integrationKey|rootPassword)$
    version: 3.9.1
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
    name: capacitor
    namespace: flux-system
spec:
    parentRefs:
        - name: envoy-gateway
          namespace: envoy-gateway
    hostnames:
        - ui.k8s.midnightthoughts.space
    rules:
        - backendRefs:
            - name: capacitor
              port: 9000
          timeouts:
            request: 240s
            backendRequest: 0s
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSA5MWplckhUTHE1Ym9yNVdp
            MUdMY0kvVmRqTFk0b1BXbTljVCswT3Y2M2xVCjVjT3JMMWJWQWRBVENNVnlSbXNz
            eTQ0czg5NDdXYUYrMy9kUC9OTnZCaDgKLS0tIEFmdEdEMkdYbXA3eURkQy9oclZs
            MTdkclBla2RveGVtQzdLbG1UZmdWcE0Kc/YTjoHpHZEG/xP37UVdHgqYpbA8zdTz
            oO5tI6DrveNvQQy22aQvmeUa2PoJrl7CbTDC7PXDBhFWOJF5FJtZ6g==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2025-02-19T11:22:44Z"
    mac: ENC[AES256_GCM,data:ohg1VEP1CcdFQPa+qTSV4zLEXVrMQXKp9FWzpShinwK7qIsYhctqR3mNV9zbegR3HnCj47EijuD8NZiVPRQYsVblQzQI29AQohyfdhljO89UXdttl9pBmQMRD+zoWundRm/xzs559Lyo4TZomUdM59J7w5vEReRw8SBhytx0de0=,iv:H+/wiSFCVUzKiG569J0l7/JBYaoWxJNiUJNaiLa4354=,tag:9S7Bjdf3IQJljlwLn/xJUw==,type:str]
    pgp: []
    encrypted_regex: ^(adminPassword|adminEmail|jenkinsAdminEmail|securityRealm|gerrit.config|routing_key|DATABASE_URL|SMTP_PASSWORD|SECRET_KEY_BASE|admin_password|extraCommands|key|clickhouseDatabaseURL|databaseURL|client_id|client_secret|secret_key_base|otp_secret|private_key|public_key|primaryKey|deterministicKey|keyDerivationSalt|token|clientId|secretKey|installationId|installationKey|uriOverride|adminToken.value|password.value|sql_password|erlangCookie|AUTHENTICATION_PASSWORD|ROOM_API_SECRET_KEY|adminPassword|configPassword|adminUser|configUser|MAIL_PASSWORD|APP_KEY|api_key|api_secret|keys|livekit_key|livekit_secret|secret_key|admin_pass|admin_email|mariadbPassword|mariadbRootPassword|privateKey|data|stringData|PASSWD|password|pass|postgresPassword|postgresqlPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret|admin_token|integrationKey|rootPassword)$
    version: 3.9.1
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: Backend
metadata:
    name: backend-authentik
spec:
    endpoints:
        - fqdn:
            hostname: auth.midnightthoughts.space
            port: 443
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSA5MWplckhUTHE1Ym9yNVdp
            MUdMY0kvVmRqTFk0b1BXbTljVCswT3Y2M2xVCjVjT3JMMWJWQWRBVENNVnlSbXNz
            eTQ0czg5NDdXYUYrMy9kUC9OTnZCaDgKLS0tIEFmdEdEMkdYbXA3eURkQy9oclZs
            MTdkclBla2RveGVtQzdLbG1UZmdWcE0Kc/YTjoHpHZEG/xP37UVdHgqYpbA8zdTz
            oO5tI6DrveNvQQy22aQvmeUa2PoJrl7CbTDC7PXDBhFWOJF5FJtZ6g==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2025-02-19T11:22:44Z"
    mac: ENC[AES256_GCM,data:ohg1VEP1CcdFQPa+qTSV4zLEXVrMQXKp9FWzpShinwK7qIsYhctqR3mNV9zbegR3HnCj47EijuD8NZiVPRQYsVblQzQI29AQohyfdhljO89UXdttl9pBmQMRD+zoWundRm/xzs559Lyo4TZomUdM59J7w5vEReRw8SBhytx0de0=,iv:H+/wiSFCVUzKiG569J0l7/JBYaoWxJNiUJNaiLa4354=,tag:9S7Bjdf3IQJljlwLn/xJUw==,type:str]
    pgp: []
    encrypted_regex: ^(adminPassword|adminEmail|jenkinsAdminEmail|securityRealm|gerrit.config|routing_key|DATABASE_URL|SMTP_PASSWORD|SECRET_KEY_BASE|admin_password|extraCommands|key|clickhouseDatabaseURL|databaseURL|client_id|client_secret|secret_key_base|otp_secret|private_key|public_key|primaryKey|deterministicKey|keyDerivationSalt|token|clientId|secretKey|installationId|installationKey|uriOverride|adminToken.value|password.value|sql_password|erlangCookie|AUTHENTICATION_PASSWORD|ROOM_API_SECRET_KEY|adminPassword|configPassword|adminUser|configUser|MAIL_PASSWORD|APP_KEY|api_key|api_secret|keys|livekit_key|livekit_secret|secret_key|admin_pass|admin_email|mariadbPassword|mariadbRootPassword|privateKey|data|stringData|PASSWD|password|pass|postgresPassword|postgresqlPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret|admin_token|integrationKey|rootPassword)$
    version: 3.9.1
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
    name: oidc-capacitor
    namespace: flux-system
spec:
    targetRefs:
        - group: gateway.networking.k8s.io
          kind: HTTPRoute
          name: capacitor
    oidc:
        provider:
            backendRefs:
                - group: gateway.envoyproxy.io
                  kind: Backend
                  name: backend-authentik
                  port: 443
            issuer: https://auth.midnightthoughts.space/application/o/capacitor/
            authorizationEndpoint: https://auth.midnightthoughts.space/application/o/authorize/
            tokenEndpoint: https://auth.midnightthoughts.space/application/o/token/
        clientID: LKNnKYcm816EEnnFTmEdfo91kmWyJnc3lrh98NWW
        #gitleaks:allow
        clientSecret:
            name: capacitor-oidc-config
        redirectURL: https://ui.k8s.midnightthoughts.space/oauth2/callback
        logoutPath: /logout
        refreshToken: true
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSA5MWplckhUTHE1Ym9yNVdp
            MUdMY0kvVmRqTFk0b1BXbTljVCswT3Y2M2xVCjVjT3JMMWJWQWRBVENNVnlSbXNz
            eTQ0czg5NDdXYUYrMy9kUC9OTnZCaDgKLS0tIEFmdEdEMkdYbXA3eURkQy9oclZs
            MTdkclBla2RveGVtQzdLbG1UZmdWcE0Kc/YTjoHpHZEG/xP37UVdHgqYpbA8zdTz
            oO5tI6DrveNvQQy22aQvmeUa2PoJrl7CbTDC7PXDBhFWOJF5FJtZ6g==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2025-02-19T11:22:44Z"
    mac: ENC[AES256_GCM,data:ohg1VEP1CcdFQPa+qTSV4zLEXVrMQXKp9FWzpShinwK7qIsYhctqR3mNV9zbegR3HnCj47EijuD8NZiVPRQYsVblQzQI29AQohyfdhljO89UXdttl9pBmQMRD+zoWundRm/xzs559Lyo4TZomUdM59J7w5vEReRw8SBhytx0de0=,iv:H+/wiSFCVUzKiG569J0l7/JBYaoWxJNiUJNaiLa4354=,tag:9S7Bjdf3IQJljlwLn/xJUw==,type:str]
    pgp: []
    encrypted_regex: ^(adminPassword|adminEmail|jenkinsAdminEmail|securityRealm|gerrit.config|routing_key|DATABASE_URL|SMTP_PASSWORD|SECRET_KEY_BASE|admin_password|extraCommands|key|clickhouseDatabaseURL|databaseURL|client_id|client_secret|secret_key_base|otp_secret|private_key|public_key|primaryKey|deterministicKey|keyDerivationSalt|token|clientId|secretKey|installationId|installationKey|uriOverride|adminToken.value|password.value|sql_password|erlangCookie|AUTHENTICATION_PASSWORD|ROOM_API_SECRET_KEY|adminPassword|configPassword|adminUser|configUser|MAIL_PASSWORD|APP_KEY|api_key|api_secret|keys|livekit_key|livekit_secret|secret_key|admin_pass|admin_email|mariadbPassword|mariadbRootPassword|privateKey|data|stringData|PASSWD|password|pass|postgresPassword|postgresqlPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret|admin_token|integrationKey|rootPassword)$
    version: 3.9.1
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
    name: allow-capacitor
    namespace: flux-system
spec:
    podSelector:
        matchLabels:
            app.kubernetes.io/instance: capacitor
    ingress:
        - ports:
            - protocol: TCP
              port: 9000
    policyTypes:
        - Ingress
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1esjyg2qfy49awv0ptkzvpk425adczjr38m37w2mmcahzc4p8n54sll2nzh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSA5MWplckhUTHE1Ym9yNVdp
            MUdMY0kvVmRqTFk0b1BXbTljVCswT3Y2M2xVCjVjT3JMMWJWQWRBVENNVnlSbXNz
            eTQ0czg5NDdXYUYrMy9kUC9OTnZCaDgKLS0tIEFmdEdEMkdYbXA3eURkQy9oclZs
            MTdkclBla2RveGVtQzdLbG1UZmdWcE0Kc/YTjoHpHZEG/xP37UVdHgqYpbA8zdTz
            oO5tI6DrveNvQQy22aQvmeUa2PoJrl7CbTDC7PXDBhFWOJF5FJtZ6g==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2025-02-19T11:22:44Z"
    mac: ENC[AES256_GCM,data:ohg1VEP1CcdFQPa+qTSV4zLEXVrMQXKp9FWzpShinwK7qIsYhctqR3mNV9zbegR3HnCj47EijuD8NZiVPRQYsVblQzQI29AQohyfdhljO89UXdttl9pBmQMRD+zoWundRm/xzs559Lyo4TZomUdM59J7w5vEReRw8SBhytx0de0=,iv:H+/wiSFCVUzKiG569J0l7/JBYaoWxJNiUJNaiLa4354=,tag:9S7Bjdf3IQJljlwLn/xJUw==,type:str]
    pgp: []
    encrypted_regex: ^(adminPassword|adminEmail|jenkinsAdminEmail|securityRealm|gerrit.config|routing_key|DATABASE_URL|SMTP_PASSWORD|SECRET_KEY_BASE|admin_password|extraCommands|key|clickhouseDatabaseURL|databaseURL|client_id|client_secret|secret_key_base|otp_secret|private_key|public_key|primaryKey|deterministicKey|keyDerivationSalt|token|clientId|secretKey|installationId|installationKey|uriOverride|adminToken.value|password.value|sql_password|erlangCookie|AUTHENTICATION_PASSWORD|ROOM_API_SECRET_KEY|adminPassword|configPassword|adminUser|configUser|MAIL_PASSWORD|APP_KEY|api_key|api_secret|keys|livekit_key|livekit_secret|secret_key|admin_pass|admin_email|mariadbPassword|mariadbRootPassword|privateKey|data|stringData|PASSWD|password|pass|postgresPassword|postgresqlPassword|redminePassword|smtpPassword|registration_shared_secret|shared_secret|secret|admin_token|integrationKey|rootPassword)$
    version: 3.9.1
