---
apiVersion: v1
kind: Namespace
metadata:
  name: matrix-postgres-cluster
---
apiVersion: acid.zalan.do/v1
kind: postgresql
metadata:
  labels:
    team: matrix
  name: matrix-postgres-cluster
  namespace: matrix-postgres-cluster
spec:
  enableShmVolume: true
  databases:
    synapse: synapse
    matrix_media_repo: matrix_media_repo
    syncv3: syncv3
    signal_bridge: signal_bridge
    instagram_bridge: instagram_bridge
  numberOfInstances: 3
  resources:
    requests:
      cpu: 500m
      memory: 24000Mi
    limits:
      cpu: 2000m
      memory: 64000Mi
  postgresql:
    version: "15"
    parameters:
      password_encryption: scram-sha-256
      max_connections: "200"
      superuser_reserved_connections: "6"
      shared_buffers: "10240 MB"
      work_mem: "128 MB"
      maintenance_work_mem: "620 MB"
      huge_pages: try
      effective_cache_size: "45 GB"
      effective_io_concurrency: "200"
      random_page_cost: "1.25"
      track_io_timing: on
      min_wal_size: "512 MB"
      max_wal_size: "1024 MB"
      wal_buffers: "-1"
      wal_writer_delay: 200ms
      wal_writer_flush_after: 1MB
      wal_keep_size: "3650 MB"
      bgwriter_delay: 200ms
      bgwriter_lru_maxpages: "100"
      bgwriter_lru_multiplier: "2.0"
      bgwriter_flush_after: "0"
      max_worker_processes: "16"
      max_parallel_workers_per_gather: "8"
      max_parallel_maintenance_workers: "8"
      max_parallel_workers: "16"
      parallel_leader_participation: "on"
      enable_partitionwise_join: "on"
      enable_partitionwise_aggregate: "on"
      jit: "on"
      max_slot_wal_keep_size: "1000 MB"
      track_wal_io_timing: "on"
      maintenance_io_concurrency: "200"
      wal_recycle: "on"
  teamId: matrix
  users:
    synapse: []
    matrix_media_repo: []
    syncv3: []
    signal_bridge: []
    instagram_bridge: []
  volume:
    size: 50Gi
  patroni:
    ttl: 30
    loop_wait: 10
    retry_timeout: 10
    failsafe_mode: true
    synchronous_mode: true
    synchronous_mode_strict: false
    synchronous_node_count: 1
    maximum_lag_on_failover: 150
