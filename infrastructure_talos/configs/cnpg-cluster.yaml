apiVersion: barmancloud.cnpg.io/v1
kind: ObjectStore
metadata:
    name: hetzner-base-backup
    namespace: postgres-cluster
spec:
    retentionPolicy: "30d"
    configuration:
        destinationPath: s3://mtrnord-talos-pg-backup/pg-base-backup
        endpointURL: https://hel1.your-objectstorage.com
        s3Credentials:
            accessKeyId:
                name: pg-s3-credentials
                key: ACCESS_KEY_ID
            secretAccessKey:
                name: pg-s3-credentials
                key: ACCESS_SECRET_KEY
        wal:
            compression: gzip
            maxParallel: 2
        data:
            compression: gzip
            immediateCheckpoint: true
            jobs: 2
---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
    name: pg-cluster-v2
    namespace: postgres-cluster
spec:
    instances: 3
    imageName: ghcr.io/cloudnative-pg/postgresql:18.0-202509261031-standard-trixie@sha256:6f0f41dffed078d700963eb6e0ca918815d603c97ef1875fe1db01db70d18ed5
    enableSuperuserAccess: true
    primaryUpdateMethod: switchover
    ephemeralVolumesSizeLimit:
        shm: 250Mi
        temporaryData: 250Mi
    postgresql:
        parameters:
            # Tuned by https://pgconfigurator.cybertec-postgresql.com/
            # Connectivity
            max_connections: "220"
            superuser_reserved_connections: "5"
            # Memory Settings
            shared_buffers: 2048 MB
            work_mem: 32 MB
            maintenance_work_mem: 320 MB
            huge_pages: "off"
            effective_cache_size: 6 GB
            effective_io_concurrency: "150"
            random_page_cost: "1.5"
            # Monitoring
            track_io_timing: "on"
            # track execution times of pl-language procedures if any
            track_functions: pl
            # Replication
            max_wal_senders: "10"
            # Checkpointing
            checkpoint_timeout: 15 min
            checkpoint_completion_target: "0.9"
            max_wal_size: 1024 MB
            min_wal_size: 512 MB
            # WAL writing
            wal_compression: "on"
            wal_buffers: "-1"
            wal_writer_delay: 200ms
            wal_writer_flush_after: 1MB
            wal_keep_size: 3650 MB
            # Background writer
            bgwriter_delay: 200ms
            bgwriter_lru_maxpages: "100"
            bgwriter_lru_multiplier: "2.0"
            bgwriter_flush_after: "0"
            # Parallel queries:
            max_worker_processes: "6"
            max_parallel_workers_per_gather: "3"
            max_parallel_maintenance_workers: "3"
            max_parallel_workers: "6"
            parallel_leader_participation: "on"
            # Advanced features
            enable_partitionwise_join: "on"
            enable_partitionwise_aggregate: "on"
            jit: "on"
            max_slot_wal_keep_size: 1000 MB
            track_wal_io_timing: "on"
            maintenance_io_concurrency: "150"
            wal_recycle: "on"
            # #pg_hba:
            # #    - host all bugzilla all md5
    # backup:
    #     target: prefer-standby
    #     retentionPolicy: 30d
    #     barmanObjectStore:
    #         destinationPath: s3://mtrnord-talos-pg-backup/pg-base-backup
    #         endpointURL: https://hel1.your-objectstorage.com
    #         s3Credentials:
    #             accessKeyId:
    #                 name: pg-s3-credentials
    #                 key: ACCESS_KEY_ID
    #             secretAccessKey:
    #                 name: pg-s3-credentials
    #                 key: ACCESS_SECRET_KEY
    #         wal:
    #             compression: gzip
    #             maxParallel: 2
    #         data:
    #             compression: gzip
    #             immediateCheckpoint: true
    #             jobs: 2
    plugins:
        - name: barman-cloud.cloudnative-pg.io
          isWALArchiver: true
          parameters:
            barmanObjectName: hetzner-base-backup
    managed:
        roles:
            - name: freshrss
              ensure: present
              login: true
              superuser: false
              passwordSecret:
                name: freshrss
            - name: meowlnir
              ensure: present
              login: true
              comment: Read Only Access for synapse required but RW to meowlnir db
              superuser: false
              passwordSecret:
                name: meowlnir
            - name: connectivity-tester-stage
              ensure: present
              login: true
              superuser: false
              passwordSecret:
                name: connectivity-tester-stage
            - name: connectivity-tester
              ensure: present
              login: true
              superuser: false
              passwordSecret:
                name: connectivity-tester
            - name: draupnir_synapse
              ensure: present
              login: true
              superuser: false
              passwordSecret:
                name: draupnir-synapse
            - name: authentik
              ensure: present
              login: true
              superuser: false
              passwordSecret:
                name: authentik
            - name: ejabberd
              ensure: present
              login: true
              superuser: false
              passwordSecret:
                name: ejabberd
            - name: vaultwarden
              ensure: present
              login: true
              superuser: false
              passwordSecret:
                name: vaultwarden
            - name: mastodon
              ensure: present
              login: true
              superuser: false
              passwordSecret:
                name: mastodon
            - name: openproject
              ensure: present
              login: true
              superuser: false
              passwordSecret:
                name: openproject
            - name: plausible
              ensure: present
              login: true
              superuser: false
              passwordSecret:
                name: plausible
            - name: coder
              ensure: present
              login: true
              superuser: false
              passwordSecret:
                name: coder
            - name: matrix_auth
              ensure: present
              login: true
              superuser: false
              passwordSecret:
                name: matrix-auth
            - name: cachet
              ensure: present
              login: true
              superuser: false
              passwordSecret:
                name: cachet
            - name: docuseal
              ensure: present
              login: true
              superuser: false
              passwordSecret:
                name: docuseal
            - name: bugzilla
              ensure: present
              login: true
              superuser: false
              passwordSecret:
                name: bugzilla
            - name: rundeck
              ensure: present
              login: true
              superuser: false
              passwordSecret:
                name: rundeck
            - name: plane
              ensure: present
              login: true
              superuser: false
              passwordSecret:
                name: plane
            - name: gotosocial
              ensure: present
              login: true
              superuser: false
              passwordSecret:
                name: gotosocial
            - name: grafana-ro
              ensure: present
              login: true
              superuser: false
              passwordSecret:
                name: grafana-ro
            - name: mailman
              ensure: present
              login: true
              superuser: false
              passwordSecret:
                name: mailman
    storage:
        storageClass: hcloud-volumes
        size: 15Gi
---
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
    name: pg-cluster-v2
    namespace: postgres-cluster
spec:
    selector:
        matchLabels:
            cnpg.io/cluster: pg-cluster-v2
    podMetricsEndpoints:
        - port: metrics
---
apiVersion: postgresql.cnpg.io/v1
kind: ScheduledBackup
metadata:
    name: hetzner-base-backup
    namespace: postgres-cluster
spec:
    schedule: 0 5 4 * * */3
    backupOwnerReference: self
    immediate: true
    cluster:
        name: pg-cluster-v2
    method: plugin
    pluginConfiguration:
        name: barman-cloud.cloudnative-pg.io
---
apiVersion: postgresql.cnpg.io/v1
kind: Database
metadata:
    name: rundeck
    namespace: postgres-cluster
spec:
    name: rundeck
    owner: rundeck
    cluster:
        name: pg-cluster-v2
---
apiVersion: postgresql.cnpg.io/v1
kind: Database
metadata:
    name: plane
    namespace: postgres-cluster
spec:
    name: plane
    owner: plane
    cluster:
        name: pg-cluster-v2
---
apiVersion: postgresql.cnpg.io/v1
kind: Database
metadata:
    name: meowlnir
    namespace: postgres-cluster
spec:
    name: meowlnir
    owner: meowlnir
    cluster:
        name: pg-cluster-v2
---
apiVersion: postgresql.cnpg.io/v1
kind: Database
metadata:
    name: connectivity-tester-stage
    namespace: postgres-cluster
spec:
    name: connectivity-tester-stage
    owner: connectivity-tester-stage
    cluster:
        name: pg-cluster-v2
---
apiVersion: postgresql.cnpg.io/v1
kind: Database
metadata:
    name: connectivity-tester
    namespace: postgres-cluster
spec:
    name: connectivity-tester
    owner: connectivity-tester
    cluster:
        name: pg-cluster-v2
---
apiVersion: postgresql.cnpg.io/v1
kind: Database
metadata:
    name: freshrss
    namespace: postgres-cluster
spec:
    name: freshrss
    owner: freshrss
    cluster:
        name: pg-cluster-v2
---
apiVersion: postgresql.cnpg.io/v1
kind: Database
metadata:
    name: synapse
    namespace: postgres-cluster
spec:
    name: synapse
    owner: synapse
    ensure: absent
    cluster:
        name: pg-cluster-v2
---
apiVersion: postgresql.cnpg.io/v1
kind: Database
metadata:
    name: authentik
    namespace: postgres-cluster
spec:
    name: authentik
    owner: authentik
    ensure: present
    cluster:
        name: pg-cluster-v2
---
apiVersion: postgresql.cnpg.io/v1
kind: Database
metadata:
    name: draupnir-synapse
    namespace: postgres-cluster
spec:
    name: draupnir_synapse
    owner: draupnir_synapse
    ensure: present
    cluster:
        name: pg-cluster-v2
---
apiVersion: postgresql.cnpg.io/v1
kind: Database
metadata:
    name: d4all
    namespace: postgres-cluster
spec:
    name: d4all
    owner: draupnir_synapse
    ensure: present
    cluster:
        name: pg-cluster-v2
---
apiVersion: postgresql.cnpg.io/v1
kind: Database
metadata:
    name: vaultwarden
    namespace: postgres-cluster
spec:
    name: vaultwarden
    owner: vaultwarden
    ensure: present
    cluster:
        name: pg-cluster-v2
---
apiVersion: postgresql.cnpg.io/v1
kind: Database
metadata:
    name: gotosocial
    namespace: postgres-cluster
spec:
    name: gotosocial
    owner: gotosocial
    ensure: present
    cluster:
        name: pg-cluster-v2
---
apiVersion: postgresql.cnpg.io/v1
kind: Database
metadata:
    name: mailman
    namespace: postgres-cluster
spec:
    name: mailman
    owner: mailman
    ensure: present
    cluster:
        name: pg-cluster-v2
---
apiVersion: postgresql.cnpg.io/v1
kind: Database
metadata:
    name: plausible
    namespace: postgres-cluster
spec:
    name: plausible
    owner: plausible
    ensure: present
    cluster:
        name: pg-cluster-v2
